<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Kstry业务架构首选框架</title>
    <meta name="generator" content="VuePress 1.9.7">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.slim.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.2/jquery.fancybox.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.2/jquery.fancybox.min.css">
    <meta name="description" content="Kstry使用文档">
    
    <link rel="preload" href="/assets/css/0.styles.9634fd34.css" as="style"><link rel="preload" href="/assets/js/app.fc8f11ce.js" as="script"><link rel="preload" href="/assets/js/2.6d18f2ff.js" as="script"><link rel="preload" href="/assets/js/9.c1a65384.js" as="script"><link rel="prefetch" href="/assets/js/10.976139c2.js"><link rel="prefetch" href="/assets/js/11.cee08e74.js"><link rel="prefetch" href="/assets/js/12.b8c547b5.js"><link rel="prefetch" href="/assets/js/13.63a0d034.js"><link rel="prefetch" href="/assets/js/14.8cab9faf.js"><link rel="prefetch" href="/assets/js/15.349558f5.js"><link rel="prefetch" href="/assets/js/16.0d2fbd26.js"><link rel="prefetch" href="/assets/js/17.af43253d.js"><link rel="prefetch" href="/assets/js/3.84f41dcf.js"><link rel="prefetch" href="/assets/js/4.32e6db9d.js"><link rel="prefetch" href="/assets/js/5.a021e58e.js"><link rel="prefetch" href="/assets/js/6.8b7c2b97.js"><link rel="prefetch" href="/assets/js/7.c487ae2f.js"><link rel="prefetch" href="/assets/js/8.81adceba.js">
    <link rel="stylesheet" href="/assets/css/0.styles.9634fd34.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="http://cdn.kstry.cn/doc/img/title-field.png" alt="Kstry业务架构首选框架" class="logo"> <span class="site-name can-hide">Kstry业务架构首选框架</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/doc/understandkstry/use_case_demo.html" class="nav-link">
  使用场景
</a></div><div class="nav-item"><a href="/doc/specification/quick_start.html" class="nav-link">
  使用文档
</a></div><div class="nav-item"><a href="http://kstry.cn/modeler" target="_blank" rel="noopener noreferrer" class="nav-link external">
  配置台
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="/doc/release/kstry-release.html" class="nav-link">
  发布记录
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="推荐" class="dropdown-title"><span class="title">推荐</span> <span class="arrow down"></span></button> <button type="button" aria-label="推荐" class="mobile-dropdown-title"><span class="title">推荐</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="http://waitmoon.com/zh/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  规则引擎—ice
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="https://github.com/kstry/kstry-core" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://gitee.com/kstry/kstry-core" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Gitee
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/doc/understandkstry/use_case_demo.html" class="nav-link">
  使用场景
</a></div><div class="nav-item"><a href="/doc/specification/quick_start.html" class="nav-link">
  使用文档
</a></div><div class="nav-item"><a href="http://kstry.cn/modeler" target="_blank" rel="noopener noreferrer" class="nav-link external">
  配置台
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="/doc/release/kstry-release.html" class="nav-link">
  发布记录
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="推荐" class="dropdown-title"><span class="title">推荐</span> <span class="arrow down"></span></button> <button type="button" aria-label="推荐" class="mobile-dropdown-title"><span class="title">推荐</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="http://waitmoon.com/zh/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  规则引擎—ice
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="https://github.com/kstry/kstry-core" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://gitee.com/kstry/kstry-core" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Gitee
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><a href="/doc/specification/quick_start" class="sidebar-heading clickable open"><span>使用文档</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/doc/specification/quick_start.html" class="sidebar-link">一、快速开始</a></li><li><a href="/doc/specification/process_choreography.html" class="sidebar-link">二、流程编排</a></li><li><a href="/doc/specification/data_transfer.html" aria-current="page" class="active sidebar-link">三、数据流转</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/doc/specification/data_transfer.html#_3-1-storybus介绍" class="sidebar-link">3.1 StoryBus介绍</a></li><li class="sidebar-sub-header"><a href="/doc/specification/data_transfer.html#_3-2-变量注解" class="sidebar-link">3.2 变量注解</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/doc/specification/data_transfer.html#_3-2-1-获取变量" class="sidebar-link">3.2.1 获取变量</a></li><li class="sidebar-sub-header"><a href="/doc/specification/data_transfer.html#_3-2-2-通知变量" class="sidebar-link">3.2.2 通知变量</a></li></ul></li><li class="sidebar-sub-header"><a href="/doc/specification/data_transfer.html#_3-3-scopedataoperator对象" class="sidebar-link">3.3 ScopeDataOperator对象</a></li><li class="sidebar-sub-header"><a href="/doc/specification/data_transfer.html#_3-4-参数校验" class="sidebar-link">3.4 参数校验</a></li><li class="sidebar-sub-header"><a href="/doc/specification/data_transfer.html#_3-5-参数生命周期" class="sidebar-link">3.5 参数生命周期</a></li><li class="sidebar-sub-header"><a href="/doc/specification/data_transfer.html#_3-6-参数类型转换器" class="sidebar-link">3.6 参数类型转换器</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/doc/specification/data_transfer.html#_3-6-1-类型转换器定义" class="sidebar-link">3.6.1 类型转换器定义</a></li><li class="sidebar-sub-header"><a href="/doc/specification/data_transfer.html#_3-6-2-类型转换器使用" class="sidebar-link">3.6.2 类型转换器使用</a></li><li class="sidebar-sub-header"><a href="/doc/specification/data_transfer.html#_3-6-3-默认转换器" class="sidebar-link">3.6.3 默认转换器</a></li></ul></li><li class="sidebar-sub-header"><a href="/doc/specification/data_transfer.html#_3-7-配置节点方法入参" class="sidebar-link">3.7 配置节点方法入参</a></li></ul></li><li><a href="/doc/specification/rbac_model.html" class="sidebar-link">四、RBAC模式</a></li><li><a href="/doc/specification/use_variable.html" class="sidebar-link">五、变量</a></li><li><a href="/doc/specification/link_tracing.html" class="sidebar-link">六、链路追踪</a></li><li><a href="/doc/specification/appendix.html" class="sidebar-link">附录</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>前面演示了流程、节点、网关、事件、指令如何通过合适的编排来应对层出不穷的业务变化所带来的挑战。编排好的流程图中节点与节点之间并非是完全独立的。前几个服务节点的出参可能会是后一个节点所需要的几个入参。节点间数据关联无处不在。Kstry中承载节点间通信工作的角色就是 <strong>StoryBus</strong></p></div> <h2 id="_3-1-storybus介绍"><a href="#_3-1-storybus介绍" class="header-anchor">#</a> 3.1 StoryBus介绍</h2> <p><a data-fancybox="" title="a.drawio (1)" href="http://cdn.kstry.cn/doc/img/story-bus.png"><img src="http://cdn.kstry.cn/doc/img/story-bus.png" alt="a.drawio (1)"></a></p> <p>    🟢 每一个服务节点如果有需要，都可以从 StoryBus 中获取需要的参数，执行完之后，将需要的结果通知到 StoryBus</p> <p>    🟢 StoryBus 中有四个数据域，分别是：</p> <p>        🔷 <strong>req</strong>：保存请求传入的request对象，request对象本身不会发生变化。但对象里面的值允许通过后期的变量通知发生更新</p> <p>        🔷 <strong>sta</strong>：保存节点执行完成后产生的变量，一经设置，将不再发生变化，如果出现重复设置会有警告日志（当只有对象的引用在sta域时，对象里面的字段还是可以发生更新的，这点与req相同）</p> <p>        🔷 <strong>var</strong>：保存节点执行完成后产生的变量，可以被重复替换，对象里面的字段性质同上</p> <p>        🔷 <strong>res</strong>：保存最终结果，作为 Story 执行完成后最终的结果返回给调用者（<strong>1.0.9版本开始，result更名为res</strong>）</p> <p>    🟢 节点出度中，可以定义条件表达式直接引用这四个域做条件判断，如流程编排中出现的：<code>res.img != null</code>、<code>req.source!='app'</code></p> <p>    🟢 四个作用域被读写锁保护着，get获取读锁，notice获取写锁，防止出现并发问题</p> <p>    🟢 开启异步模式后，同时创建的子任务都可以读写 StoryBus 中的变量，所以<strong>数据方面有前后依赖关系的节点，不能被创建到同一时间段执行的不同子任务中</strong>，可以通过聚合节点来保证节点执行时数据依赖的先后顺序</p> <h2 id="_3-2-变量注解"><a href="#_3-2-变量注解" class="header-anchor">#</a> 3.2 变量注解</h2> <h3 id="_3-2-1-获取变量"><a href="#_3-2-1-获取变量" class="header-anchor">#</a> 3.2.1 获取变量</h3> <p><strong>@XxxTaskParam 注解：</strong></p> <p>标注在服务节点入参前，从 StoryBus 中获取到变量后，直接赋值给参数变量，例如：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@NoticeSta</span>
<span class="token annotation punctuation">@TaskService</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;get-evaluation-info&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">EvaluationInfo</span> <span class="token function">getEvaluationInfo</span><span class="token punctuation">(</span><span class="token annotation punctuation">@ReqTaskParam</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> goodsId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">EvaluationInfo</span> evaluationInfo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EvaluationInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    evaluationInfo<span class="token punctuation">.</span><span class="token function">setEvaluateCount</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;goods id: {}, get EvaluationInfo: {}&quot;</span><span class="token punctuation">,</span> goodsId<span class="token punctuation">,</span> JSON<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>evaluationInfo<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> evaluationInfo<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>    🟢 <code>@TaskParam</code>：从 StoryBus 的 req、sta、var 域获取变量值，直接赋值给被标注参数</p> <p>        🔷 <code>value</code>：来源字段名</p> <p>        🔷 <code>scopeEnum</code>：指定是从哪个域获取字段，可取参数：<code>ScopeTypeEnum.STABLE</code>、<code>ScopeTypeEnum.VARIABLE</code>、<code>ScopeTypeEnum.REQUEST</code></p> <p>        🔷 <code>converter</code>：指定使用的类型转换器名称，默认不指定，类型转换时自动匹配转换器</p> <p>    🟢 <code>@ReqTaskParam</code>：从 StoryBus 的 req 域获取变量值，直接赋值给被标注参数</p> <p>        🔷 <code>value</code>：来源字段名</p> <p>        🔷 <code>reqSelf</code>：是否将客户端传入的 request 对象整体赋值给该参数，默认为：false</p> <p>        🔷 <code>converter</code>：指定使用的类型转换器名称，默认不指定，类型转换时自动匹配转换器</p> <p>    🟢 <code>@StaTaskParam</code>：从 StoryBus 的 sta 域获取变量值，直接赋值给被标注参数</p> <p>        🔷 <code>value</code>：来源字段名</p> <p>        🔷 <code>converter</code>：指定使用的类型转换器名称，默认不指定，类型转换时自动匹配转换器</p> <p>    🟢 <code>@VarTaskParam</code>：从 StoryBus 的 var 域获取变量值，直接赋值给被标注参数</p> <p>        🔷 <code>value</code>：来源字段名</p> <p>        🔷 <code>converter</code>：指定使用的类型转换器名称，默认不指定，类型转换时自动匹配转换器</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>value中支持使用$前缀来使用<a href="https://github.com/alibaba/fastjson/wiki/JSONPath" target="_blank" rel="noopener noreferrer">JSONPath<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>语法获取变量。</p> <p>比如<code>$.var.studyExperienceList[*].classId</code>就是从studyExperienceList对象集合中取出每一个对象的classId，然后将classId列表返回给目标变量</p></div> <p><strong>@XxxTaskField 注解：</strong></p> <p>标注在服务节点入参对象中的字段上，从 StoryBus 中获取到变量后，直接赋值给被标注字段，例如：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@TaskComponent</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;logistic&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LogisticService</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@NoticeSta</span>
    <span class="token annotation punctuation">@TaskService</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;get-logistic-insurance&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">LogisticInsurance</span> <span class="token function">getLogisticInsurance</span><span class="token punctuation">(</span><span class="token class-name">GetLogisticInsuranceRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;request source：{}&quot;</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">getSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">LogisticInsurance</span> logisticInsurance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LogisticInsurance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        logisticInsurance<span class="token punctuation">.</span><span class="token function">setDesc</span><span class="token punctuation">(</span><span class="token string">&quot;运费险描述&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        logisticInsurance<span class="token punctuation">.</span><span class="token function">setType</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> logisticInsurance<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GetLogisticInsuranceRequest</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@ReqTaskField</span><span class="token punctuation">(</span><span class="token string">&quot;source&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> source<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>    🟢 <code>@TaskField</code>：从 StoryBus 的 req、sta、var 域获取变量值，赋值给被标注字段</p> <p>        🔷 <code>value</code>：来源字段名</p> <p>        🔷 <code>scopeEnum</code>：指定是从哪个域获取字段，可取参数：<code>ScopeTypeEnum.STABLE</code>、<code>ScopeTypeEnum.VARIABLE</code>、<code>ScopeTypeEnum.REQUEST</code></p> <p>        🔷 <code>converter</code>：指定使用的类型转换器名称，默认不指定，类型转换时自动匹配转换器</p> <p>    🟢 <code>@ReqTaskField</code>：从 StoryBus 的 req 域获取变量值，赋值给被标注字段</p> <p>        🔷 <code>value</code>：来源字段名</p> <p>        🔷 <code>converter</code>：指定使用的类型转换器名称，默认不指定，类型转换时自动匹配转换器</p> <p>    🟢 <code>@StaTaskField</code>：从 StoryBus 的 sta 域获取变量值，赋值给被标注字段</p> <p>        🔷 <code>value</code>：来源字段名</p> <p>        🔷 <code>converter</code>：指定使用的类型转换器名称，默认不指定，类型转换时自动匹配转换器</p> <p>    🟢 <code>@VarTaskField</code>：从 StoryBus 的 var 域获取变量值，赋值给被标注字段</p> <p>        🔷 <code>value</code>：来源字段名</p> <p>        🔷 <code>converter</code>：指定使用的类型转换器名称，默认不指定，类型转换时自动匹配转换器</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>value中支持使用$前缀来使用<a href="https://github.com/alibaba/fastjson/wiki/JSONPath" target="_blank" rel="noopener noreferrer">JSONPath<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>语法获取变量。</p> <p>比如<code>$.var.studyExperienceList[*].classId</code>就是从studyExperienceList对象集合中取出每一个对象的classId，然后将classId列表返回给目标变量</p></div> <h3 id="_3-2-2-通知变量"><a href="#_3-2-2-通知变量" class="header-anchor">#</a> 3.2.2 通知变量</h3> <p>注解可以与<code>@TaskService</code> 一起使用，指定服务节点的结果返回值通知到 StoryBus 的哪些作用域中</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@TaskComponent</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;order&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderService</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@NoticeScope</span><span class="token punctuation">(</span>scope <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token class-name">ScopeTypeEnum</span><span class="token punctuation">.</span>STABLE<span class="token punctuation">,</span> <span class="token class-name">ScopeTypeEnum</span><span class="token punctuation">.</span>VARIABLE<span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@TaskService</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;get-order-info&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">OrderInfo</span> <span class="token function">getOrderInfo</span><span class="token punctuation">(</span><span class="token annotation punctuation">@ReqTaskParam</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> goodsId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">OrderInfo</span> orderInfo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrderInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderInfo<span class="token punctuation">.</span><span class="token function">setOrderedCount</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;goods id: {}, get OrderInfo: {}&quot;</span><span class="token punctuation">,</span> goodsId<span class="token punctuation">,</span> JSON<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>orderInfo<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> orderInfo<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>注解可以标注在服务节点方法的结果类上，也可以标注在结果类的字段上，例如：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@NoticeSta</span><span class="token punctuation">(</span>targrt <span class="token operator">=</span> <span class="token string">&quot;goodsDetail&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GoodsDetail</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@Builder</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">InitSkuResponse</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@NoticeSta</span><span class="token punctuation">(</span>targrt <span class="token operator">=</span> <span class="token string">&quot;goodsDetail.skuInfos&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SkuInfo</span><span class="token punctuation">&gt;</span></span> skuInfos<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>    🟢 <code>@NoticeSta</code>：可以与<code>@TaskService</code> 一起使用，还可以标注在方法返回结果的类上或者类字段上，字段结果被通知到 StoryBus 中的 sta 域中</p> <p>        🔷 <code>targrt</code>：通知到指定作用域的字段名</p> <p>        🔷 <code>converter</code>：指定使用的类型转换器名称，默认不指定，类型转换时自动匹配转换器</p> <p>    🟢 <code>@NoticeVar</code>：可以与<code>@TaskService</code> 一起使用，还可以标注在方法返回结果的类上或者类字段上，字段结果被通知到 StoryBus 中的 var 域中</p> <p>        🔷 <code>targrt</code>：通知到指定作用域的字段名</p> <p>        🔷 <code>converter</code>：指定使用的类型转换器名称，默认不指定，类型转换时自动匹配转换器</p> <p>    🟢 <code>@NoticeResult</code>：可以与<code>@TaskService</code> 一起使用，还可以标注在方法返回结果的类上或者类字段上，字段结果被通知到 StoryBus 中的 result 域中</p> <p>        🔷 <code>converter</code>：指定使用的类型转换器名称，默认不指定，类型转换时自动匹配转换器</p> <p>    🟢 <code>@NoticeScope</code>：可以与<code>@TaskService</code> 一起使用，还可以标注在方法返回结果的类上或者类字段上，字段结果默认被通知到 StoryBus 中的 sta 和 var两个域中</p> <p>        🔷 <code>targrt</code>：通知到指定作用域的字段名</p> <p>        🔷 <code>scope</code>：未指定时，默认将结果通知到 StoryBus 中的 sta 和 var两个域中。指定后以实际指定域为准</p> <p>        🔷 <code>converter</code>：指定使用的类型转换器名称，默认不指定，类型转换时自动匹配转换器</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>如果需要在一个服务节点方法结束时通知多个变量至StoryBus，除了上面定义对象的方式，还可以使用ScopeDataNotice对象。比如：<code>return ScopeDataNotice.sta().notice(&quot;age&quot;, 1).notice(&quot;name&quot;, &quot;name&quot;);</code>就是将<code>age</code>、<code>name</code>两个变量通知到了sta域</p></div> <h2 id="_3-3-scopedataoperator对象"><a href="#_3-3-scopedataoperator对象" class="header-anchor">#</a> 3.3 ScopeDataOperator对象</h2> <p>ScopeDataOperator 提供了操作StoryBus中各个数据域变量的入口。可以直接作为服务节点的入参被定义</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@TaskService</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;increase-one&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">increaseOne</span><span class="token punctuation">(</span><span class="token class-name">ScopeDataOperator</span> operator<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">ReentrantReadWriteLock<span class="token punctuation">.</span>WriteLock</span> writeLock <span class="token operator">=</span> operator<span class="token punctuation">.</span><span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    writeLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token class-name">MethodInvokeBo</span> reqScope <span class="token operator">=</span> operator<span class="token punctuation">.</span><span class="token function">getReqScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        reqScope<span class="token punctuation">.</span><span class="token function">setA</span><span class="token punctuation">(</span>reqScope<span class="token punctuation">.</span><span class="token function">getA</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        writeLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>具体功能如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>
<span class="token comment">/**
 * 获取 Req 对象
 *
 * @return 数据结果
 */</span>
<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">T</span> <span class="token function">getReqScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 获取 Sta 对象
 *
 * @return 数据结果
 */</span>
<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span> <span class="token keyword">extends</span> <span class="token class-name">ScopeData</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">T</span> <span class="token function">getStaScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 获取 Var 对象
 *
 * @return 数据结果
 */</span>
<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span> <span class="token keyword">extends</span> <span class="token class-name">ScopeData</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">T</span> <span class="token function">getVarScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 获取 Result 对象
 *
 * @return 数据结果
 */</span>
<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">getResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 请求 ID
 *
 * @return 请求 ID
 */</span>
<span class="token class-name">String</span> <span class="token function">getRequestId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 获取开始事件 ID
 *
 * @return 开始事件 ID
 */</span>
<span class="token class-name">String</span> <span class="token function">getStartId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 获取业务 ID
 *
 * @return 业务 ID
 */</span>
<span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">getBusinessId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 从 Req 域获取数据
 *
 * @param name 数据名称
 * @return 数据结果
 */</span>
<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">getReqData</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 从 Sta 域获取数据
 *
 * @param name 数据名称
 * @return 数据结果
 */</span>
<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">getStaData</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 从 Var 域获取数据
 *
 * @param name 数据名称
 * @return 数据结果
 */</span>
<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">getVarData</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 使用取值表达式获取数据
 *
 * @param expression 取值表达式
 * @return 数据结果
 */</span>
<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">getData</span><span class="token punctuation">(</span><span class="token class-name">String</span> expression<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 获取服务节点属性，服务节点属性在节点定义时指定
 *
 * @return 服务节点属性
 */</span>
<span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">getTaskProperty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 遍历执行迭代器的每一项数据时，获取当前项数据
 *
 * @return 数据结果
 */</span>
<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">iterDataItem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 拿到 StoryBus 中的读锁
 *
 * @return 读锁
 */</span>
<span class="token class-name">ReentrantReadWriteLock<span class="token punctuation">.</span>ReadLock</span> <span class="token function">readLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 使用取值表达式获取数据, 如果不存在会创建并赋值到表达式指定位置，创建失败或指定位置失败返回空值
 *
 * @param expression 取值表达式
 * @param supplier 没有获取到目标值时调用获取默认值
 *
 * @return 数据结果
 */</span>
<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">computeIfAbsent</span><span class="token punctuation">(</span><span class="token class-name">String</span> expression<span class="token punctuation">,</span> <span class="token class-name">Supplier</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> supplier<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 设置数据
 *
 * @param expression 取值表达式
 * @param target 变量值
 *
 * @return 是否设置成功，如果已经存在将会设置失败
 */</span>
<span class="token keyword">boolean</span> <span class="token function">setData</span><span class="token punctuation">(</span><span class="token class-name">String</span> expression<span class="token punctuation">,</span> <span class="token class-name">Object</span> target<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 设置 Sta 域变量
 *
 * @param name 变量名
 * @param target 变量值
 *
 * @return 是否设置成功，如果已经存在将会设置失败
 */</span>
<span class="token keyword">boolean</span> <span class="token function">setStaData</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token class-name">Object</span> target<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 设置 Var 域变量
 *
 * @param name 变量名
 * @param target 变量值
 *
 * @return 是否设置成功
 */</span>
<span class="token keyword">boolean</span> <span class="token function">setVarData</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token class-name">Object</span> target<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 设置 Result
 *
 * @param target Result对象
 * @return 是否设置成功，如果已经存在将会设置失败
 */</span>
<span class="token keyword">boolean</span> <span class="token function">setResult</span><span class="token punctuation">(</span><span class="token class-name">Object</span> target<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 拿到 StoryBus 中的写锁
 *
 * @return 写锁
 */</span>
<span class="token class-name">ReentrantReadWriteLock<span class="token punctuation">.</span>WriteLock</span> <span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br></div></div><h2 id="_3-4-参数校验"><a href="#_3-4-参数校验" class="header-anchor">#</a> 3.4 参数校验</h2> <p>    🟢 服务节点方法参数如果是自定义对象时，对象中的字段支持JSR303格式校验</p> <p>    🟢 项目中需要引入<code>hibernate-validator</code>依赖，然后使用注解标注参数就会生效，如下<code>@NotBlank</code>：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@TaskComponent</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;logistic&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LogisticService</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@NoticeSta</span>
    <span class="token annotation punctuation">@TaskService</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;get-logistic-insurance&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">LogisticInsurance</span> <span class="token function">getLogisticInsurance</span><span class="token punctuation">(</span><span class="token class-name">GetLogisticInsuranceRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;request source：{}&quot;</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">getSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">LogisticInsurance</span> logisticInsurance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LogisticInsurance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        logisticInsurance<span class="token punctuation">.</span><span class="token function">setDesc</span><span class="token punctuation">(</span><span class="token string">&quot;运费险描述&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        logisticInsurance<span class="token punctuation">.</span><span class="token function">setType</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> logisticInsurance<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GetLogisticInsuranceRequest</span> <span class="token punctuation">{</span>

    <span class="token comment">// 判断 source 不为空</span>
    <span class="token annotation punctuation">@NotBlank</span>
    <span class="token annotation punctuation">@ReqTaskField</span><span class="token punctuation">(</span><span class="token string">&quot;source&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> source<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>    🟢 校验参数发现异常后，会中止 Story 流程，以异常的方式返回校验结果</p> <h2 id="_3-5-参数生命周期"><a href="#_3-5-参数生命周期" class="header-anchor">#</a> 3.5 参数生命周期</h2> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>Kstry 提供了服务节点入参的生成方式自定义和生命周期方法。默认情况下入参对象是通过反射方式创建的，但如果有必要时可指定将参数交由 Spring 容器维护创建，这样就可以用到 Bean 对象的注入、生命周期方法等功能。</p></div> <p><strong>服务节点入参类：</strong></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@SpringInitialization</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DetailPostProcessRequest</span> <span class="token keyword">implements</span> <span class="token class-name">ParamLifecycle</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">ShopService</span> shopService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@StaTaskField</span><span class="token punctuation">(</span><span class="token string">&quot;shopInfo&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">ShopInfo</span> shopInfo<span class="token punctuation">;</span>
    
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">before</span><span class="token punctuation">(</span><span class="token class-name">ScopeDataOperator</span> scopeDataOperator<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ParamLifecycle</span><span class="token punctuation">.</span><span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">before</span><span class="token punctuation">(</span>scopeDataOperator<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">after</span><span class="token punctuation">(</span><span class="token class-name">ScopeDataOperator</span> scopeDataOperator<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>shopInfo <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            shopService<span class="token punctuation">.</span><span class="token function">makeLabel</span><span class="token punctuation">(</span>shopInfo<span class="token punctuation">.</span><span class="token function">getLabels</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>    🟢 定义 <code>ShopService</code> 变量，默认反射创建的情况下，该变量是不会被赋值的。参数类上标注<code>@SpringInitialization</code>注解，告知 Kstry 这个节点参数需要托管给 Spring 容器，此时 <code>ShopService</code> 变量就会被 Spring 容器注入值</p> <p>    🟢 参数类实现 <code>ParamLifecycle</code> 接口进行生命周期方法定义，接口有两个方法可以被重写</p> <p>        🔷 <code>before(ScopeDataOperator scopeDataOperator)</code>：参数对象创建后就会被调用，发生在Spring容器注入值之后，Kstry字段赋值之前</p> <p>        🔷 <code>after(ScopeDataOperator scopeDataOperator)</code>：发生在字段赋值之后，用于对赋值后的参数进行再一步的处理</p> <p>    🟢 在 <code>after()</code>方法中调用 ShopService 的打标能力进行打标操作</p> <p>    🟢 <code>ParamLifecycle</code>存在一个子类<code>SpringParamLifecycle</code>，实现<code>SpringParamLifecycle</code>时可以获取Spring容器的<code>ApplicationContext</code></p> <div class="custom-block warning"><p class="custom-block-title">注意</p> <p>节点方法参数被 @XxxTaskParam 注解修饰时，参数Bean字段装配、字段校验、Spring容器初始化、生命周期方法都会失效。原因是被 @XxxTaskParam 修饰的参数无需进行初始化和任何操作，会被 StoryBus 中获取到的值直接赋值</p></div> <h2 id="_3-6-参数类型转换器"><a href="#_3-6-参数类型转换器" class="header-anchor">#</a> 3.6 参数类型转换器</h2> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>流程中参数无论是从StoryBus中读取到服务节点方法，还是方法执行完成之后通知到StoryBus中。都有可能出现实际参数与接收类型不匹配的情况。框架支持显式和隐式两种方式来使用类型转换器</p></div> <h3 id="_3-6-1-类型转换器定义"><a href="#_3-6-1-类型转换器定义" class="header-anchor">#</a> 3.6.1 类型转换器定义</h3> <p>项目中需要新增类型转换器时，可以定义转换器类实现<code>TypeConverter</code>接口，然后将自定义转换器托管给Spring容器即可</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">TypeConverter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span><span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">Ordered</span> <span class="token punctuation">{</span>

    <span class="token class-name">T</span> <span class="token function">doConvert</span><span class="token punctuation">(</span><span class="token class-name">S</span> source<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> needType<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 获取源数据类型
     */</span>
    <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span><span class="token punctuation">&gt;</span></span> <span class="token function">getSourceType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 获取目标数据类型
     */</span>
    <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">getTargetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 获取转换器名称
     */</span>
    <span class="token class-name">String</span> <span class="token function">getConvertName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 默认的类型转换器匹配规则
     * 使用类型转换器时，如果指定了转换器名字，直接使用指定的转换器不会进行转换器匹配操作，只有未指定转换器名字时才会使用match匹配合适的类型转换器
     *
     * @param collGeneric needType为List、Set时，collGeneric是集合上的泛型
     */</span>
    <span class="token keyword">default</span> <span class="token keyword">boolean</span> <span class="token function">match</span><span class="token punctuation">(</span><span class="token class-name">Object</span> source<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> needType<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> collGeneric<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>source <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> needType <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token class-name">ElementParserUtil</span><span class="token punctuation">.</span><span class="token function">isAssignable</span><span class="token punctuation">(</span><span class="token function">getSourceType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> source<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token class-name">ElementParserUtil</span><span class="token punctuation">.</span><span class="token function">isAssignable</span><span class="token punctuation">(</span><span class="token function">getTargetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> needType<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 对外暴露使用的转换方法。
     * 默认不支持同类型转换（同类型转换会返回原值），需要同类型转换时可以覆写该方法实现
     *
     * @param collGeneric needType为List、Set时，collGeneric是集合上的泛型
     */</span>
    <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">&quot;unchecked&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">default</span> <span class="token class-name">T</span> <span class="token function">convert</span><span class="token punctuation">(</span><span class="token class-name">S</span> source<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> needType<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> collGeneric<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">AssertUtil</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ElementParserUtil</span><span class="token punctuation">.</span><span class="token function">isAssignable</span><span class="token punctuation">(</span><span class="token function">getTargetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> source<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>needType <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token class-name">ElementParserUtil</span><span class="token punctuation">.</span><span class="token function">isAssignable</span><span class="token punctuation">(</span>needType<span class="token punctuation">,</span> source<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span> source<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token function">doConvert</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> needType<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 同时匹配多个转换器时，使用优先级最高的
     */</span>
    <span class="token keyword">default</span> <span class="token keyword">int</span> <span class="token function">getOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br></div></div><p>类型转换器定义样例：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Map2BusTestRequestConverter</span> <span class="token keyword">implements</span> <span class="token class-name">TypeConverter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">,</span> <span class="token class-name">BusTestRequest</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">BusTestRequest</span> <span class="token function">doConvert</span><span class="token punctuation">(</span><span class="token class-name">Map</span> source<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> needType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> JSON<span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>JSON<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getTargetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&gt;</span></span> <span class="token function">getSourceType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BusTestRequest</span><span class="token punctuation">&gt;</span></span> <span class="token function">getTargetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">BusTestRequest</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getConvertName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;MAP-TO-BUS-TEST&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>    🟢 一般情况下实现<code>TypeConverter</code>接口后，重写以下四个方法即可：</p> <p>        🔷 <code>T doConvert(S source, Class&lt;?&gt; needType)</code>：定义实际转换的逻辑。source是源数据，needType是需要转换成为的类型，这个类型是允许出现空的</p> <p>        🔷 <code>Class&lt;S&gt; getSourceType()</code>：返回转换器适配的源数据类型</p> <p>        🔷 <code>Class&lt;T&gt; getTargetType()</code>：返回转换器适配的目标数据类型</p> <p>        🔷 <code>String getConvertName()</code>：返回转换器名字</p> <p>    🟢 <code>TypeConverter</code>接口继承了Spring中的<code>Ordered</code>接口，当同时匹配到多个转换器时，<code>getOrder()</code>返回值越小优先级越高。不指定默认返回0</p> <p>    🟢 转换器实际使用时，可以分别通过指定转换结果的类型、转换器名称两种方式来使用类型转换器。指定名称的方式优先级会高于指定类型。当指定名称时转换器会跳过<code>match(Object source, Class&lt;?&gt; needType, Class&lt;?&gt; collGeneric)</code>方法的匹配，直接调用匹配成功转换器的<code>convert(S source, Class&lt;?&gt; needType, Class&lt;?&gt; collGeneric)</code>方法。</p> <p>    🟢 当以指定返回值类型方式使用转换器时，<code>match(Object source, Class&lt;?&gt; needType, Class&lt;?&gt; collGeneric)</code>方法会被执行，用来进行转换器的匹配。默认情况下该方法会根据实际源类型、目标类型与转换器中指定的源类型、目标类型是否匹配来判断是否使用当前类型转换器。如果定义一个类型转换器并且不希望它通过类型被匹配到时，可以重写该方法直接返回false。这样新定义的类型转换器就只能用指定名称的方式使用了</p> <p>    🟢 类型转换时容器会先调用<code>convert(S source, Class&lt;?&gt; needType, Class&lt;?&gt; collGeneric)</code>方法，默认情况下，该方法会判断实际需要的类型与源数据类型是否相同，如果相同将不做任何转换直接返回源数据。若想要跳过这个限制可以在转换器中重写此方法</p> <p>    🟢 无论是指定类型还是指定名称的方式使用类型转换器，如果源数据类型和需要的目标类型（如果有）中存在与类型转换器不匹配的，类型转换器将不会生效</p> <h3 id="_3-6-2-类型转换器使用"><a href="#_3-6-2-类型转换器使用" class="header-anchor">#</a> 3.6.2 类型转换器使用</h3> <h4 id="隐式使用方式"><a href="#隐式使用方式" class="header-anchor">#</a> 隐式使用方式</h4> <p>    隐式使用方式无需任何操作，框架默认开启。服务节点方法从StoryBus中获取数据、执行完成后通知数据到StoryBus中时都会经过类型转换器的隐式处理。比如实际类型是个Map，接收变量的类型是Bean。此时就会匹配合适的转换器进行类型转换。</p> <p>类型转换器会在以下场景中隐式生效：</p> <p>    🟢 使用@XxxTaskParam、@XxxTaskField注解从StoryBus中获取变量</p> <p>    🟢 使用@NoticeXxx注解或者ScopeDataNotice对象将方法返回值通知到StoryBus中</p> <p>    🟢 调用ScopeDataOperator对象的各种set方法，往StoryBus中写数据</p> <h4 id="显示使用方式"><a href="#显示使用方式" class="header-anchor">#</a> 显示使用方式</h4> <p>显示使用方式需要显示指定要使用哪个类型转换器。显示使用类型转换器场景如下：</p> <p>    🟢 使用@XxxTaskParam、@XxxTaskField注解从StoryBus中获取变量</p> <p>    🟢 使用@NoticeXxx注解或者ScopeDataNotice对象将方法返回值通知到StoryBus中</p> <p>    🟢 EnhancedDataOperator（ScopeDataOperator子类）对象从StoryBus中获取变量</p> <p>    🟢 <code>task-params</code>属性配置节点方法入参</p> <h4 id="使用类型转换器对象"><a href="#使用类型转换器对象" class="header-anchor">#</a> 使用类型转换器对象</h4> <p>    类型转换器是托管在Spring容器中的<code>TypeConverterProcessor</code>对象。需要使用时直接从Spring上下文中注入即可。该对象提供以下几个方法：</p> <p>    🟢 <code>convert(S source, Class&lt;T&gt; targetType)</code>：指定返回值类型的方式使用类型转换器</p> <p>    🟢 <code>convert(String convertName, S source)</code>：指定名称的方式使用类型转换器</p> <p>    🟢 <code>convert(String convertName, S source, Class&lt;T&gt; targetType)</code>：同时指定名称和返回值类型的方式使用类型转换器</p> <p>    🟢 <code>convert(String convertName, S source, Class&lt;T&gt; targetType, Class&lt;?&gt; collGeneric)</code>：同时指定名称和返回值类型的方式使用类型转换器，targetType是List、Set类型时可以指定集合上的泛型</p> <p>    以上这些方法，均返回<code>Pair&lt;String, T&gt;</code>对象。key：实际使用到的类型转换器名称，value：转换后的对象。如果未匹配到转换器，key返回null，value返回原来的source。下面是在js指令的片段代码，演示类型转换器的实际使用：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// JS 脚本获取结果</span>
<span class="token class-name">Object</span> result <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Invocable</span><span class="token punctuation">)</span> jsEngine<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">invokeFunction</span><span class="token punctuation">(</span>invokeMethodName<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 对结果进行转换</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> property <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isAllBlank</span><span class="token punctuation">(</span>property<span class="token punctuation">.</span><span class="token function">getReturnType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> property<span class="token punctuation">.</span><span class="token function">getResultConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">// 使用类型转换器，可以指定名称也可以指定类型</span>
    result <span class="token operator">=</span> typeConverterProcessor<span class="token punctuation">.</span><span class="token function">convert</span><span class="token punctuation">(</span>property<span class="token punctuation">.</span><span class="token function">getResultConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> result<span class="token punctuation">,</span> <span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">ofNullable</span><span class="token punctuation">(</span>property<span class="token punctuation">.</span><span class="token function">getReturnType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token operator">::</span><span class="token function">isNotBlank</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>rt <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span>rt<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h3 id="_3-6-3-默认转换器"><a href="#_3-6-3-默认转换器" class="header-anchor">#</a> 3.6.3 默认转换器</h3> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>针对一些比较常见的格式转换，框架提供了一些可以直接使用的默认转换器</p></div> <table><thead><tr><th>转换器类名</th> <th>转换器名称</th> <th>默认开启</th> <th>入参类型</th> <th>出参类型</th> <th>优先级</th></tr></thead> <tbody><tr><td>Object2BooleanTypeConverter</td> <td>OBJECT_TO_BOOLEAN</td> <td>是</td> <td>Object</td> <td>Boolean</td> <td>0</td></tr> <tr><td>Date2StringTypeConverter</td> <td>DATE_TO_STRING</td> <td>是</td> <td>Date</td> <td>String</td> <td>0</td></tr> <tr><td>String2DateTypeConverter</td> <td>STRING_TO_DATE</td> <td>是</td> <td>String</td> <td>Date</td> <td>0</td></tr> <tr><td>LocalDateTime2StringTypeConverter</td> <td>LOCAL_DATETIME_TO_STRING</td> <td>是</td> <td>LocalDateTime</td> <td>String</td> <td>0</td></tr> <tr><td>String2LocalDateTimeTypeConverter</td> <td>STRING_TO_LOCAL_DATETIME</td> <td>是</td> <td>String</td> <td>LocalDateTime</td> <td>0</td></tr> <tr><td>CollectionGenericTypeConverter</td> <td>COLLECTION_GENERIC_TYPE_CONVERTER</td> <td>是</td> <td>Collection(A)</td> <td>Collection(B)</td> <td>1000</td></tr> <tr><td>BasicTypeConverter</td> <td>BASIC_CONVERTER</td> <td>是</td> <td>Object</td> <td>Object</td> <td>2147483647</td></tr> <tr><td>OneItem2ListTypeConverter</td> <td>ONE_ITEM_TO_LIST</td> <td>否</td> <td>Object</td> <td>List</td> <td>0</td></tr> <tr><td>OneItem2SetTypeConverter</td> <td>ONE_ITEM_TO_SET</td> <td>否</td> <td>Object</td> <td>Set</td> <td>0</td></tr> <tr><td>FirstItemFromListTypeConverter</td> <td>FIRST_ITEM_FROM_LIST</td> <td>否</td> <td>List</td> <td>Object</td> <td>0</td></tr></tbody></table> <h2 id="_3-7-配置节点方法入参"><a href="#_3-7-配置节点方法入参" class="header-anchor">#</a> 3.7 配置节点方法入参</h2> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>框架最初通过配置侧指定<code>task-property</code>属性，然后在服务节点方法中获取，以此来满足不同配置节点引用同一服务节点方法时在个性化差异上的诉求。但是这种方式不够灵活，不能满足参数中存在变量的情况。目前框架支持了<code>task-params</code>属性，做到了更加精细化的支持配置侧指定服务节点方法入参</p></div> <p><strong>配置演示</strong></p> <p><a data-fancybox="" title="参数指定演示" href="../img2/63860bd414901524254021fc792dd321.png"><img src="/assets/img/63860bd414901524254021fc792dd321.64d2b1df.png" alt="63860bd414901524254021fc792dd321"></a></p> <p><code>task-params</code>内容：</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;params&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;busTest[t:map-to-bus-test]&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token number">12</span><span class="token punctuation">,</span>
            <span class="token property">&quot;desc&quot;</span><span class="token operator">:</span> <span class="token string">&quot;描述信息12&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;ar&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;@var.arName&quot;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token property">&quot;localNow[t:string_to_local_datetime]&quot;</span><span class="token operator">:</span> <span class="token string">&quot;@var.dateStr&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 定义有常量也有从StoryBus中获取变量的map结构。然后指定转换器，将map转成BusTestRequest对象。</span>
        <span class="token property">&quot;requests&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
            <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;@$.var.requests[0].id&quot;</span><span class="token punctuation">,</span> <span class="token comment">// task-params同样支持在表达式加$使用JSONPath获取参数</span>
            <span class="token property">&quot;desc&quot;</span><span class="token operator">:</span> <span class="token string">&quot;@var.requests.[0].desc&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;@var.requests.[1].id&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;desc&quot;</span><span class="token operator">:</span> <span class="token string">&quot;@var.requests.[1].desc&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;now[t:string_to_date]&quot;</span><span class="token operator">:</span> <span class="token string">&quot;@var.dateStr&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token number">19</span><span class="token punctuation">,</span>
            <span class="token property">&quot;desc&quot;</span><span class="token operator">:</span> <span class="token string">&quot;描述信息19&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 对集合的支持，以及集合中定义对象的支持</span>
        <span class="token property">&quot;reqDescList2&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">[</span><span class="token string">&quot;@var.requests.[0].desc&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token punctuation">[</span><span class="token string">&quot;@var.requests.[0].desc&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;@var.requests.[1].desc&quot;</span><span class="token punctuation">]</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 对集合中直接获取StoryBus中变量的支持</span>
        <span class="token property">&quot;requests2&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">[</span>
                <span class="token punctuation">[</span><span class="token punctuation">{</span>
                    <span class="token property">&quot;descList&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;@var.requests.[0].desc&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;@var.requests.[1].desc&quot;</span><span class="token punctuation">]</span>
                <span class="token punctuation">}</span><span class="token punctuation">]</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">]</span> <span class="token comment">// 多重集合的支持</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;reqDescList[t:basic_converter]&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;@var.requests.[0].desc&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;@var.requests.[1].desc&quot;</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><p>服务节点方法：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@TaskService</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testConverterMapping</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> params<span class="token punctuation">,</span> <span class="token class-name">String</span> reqDescList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertNotNull</span><span class="token punctuation">(</span>params<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;busTest&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertTrue</span><span class="token punctuation">(</span>params<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;busTest&quot;</span><span class="token punctuation">)</span> <span class="token keyword">instanceof</span> <span class="token class-name">BusTestRequest</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertNotNull</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">BusTestRequest</span><span class="token punctuation">)</span> params<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;busTest&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getLocalNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">BusTestRequest</span><span class="token punctuation">)</span> params<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;busTest&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;AR名称&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> params<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;requests&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertNotNull</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> params<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;requests&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;now&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token number">54</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> params<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;requests&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mapToInt</span><span class="token punctuation">(</span>m <span class="token operator">-&gt;</span> <span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> m<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertNotNull</span><span class="token punctuation">(</span>reqDescList<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> params<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;reqDescList2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> params<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;reqDescList2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> params<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;reqDescList2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> params<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;reqDescList2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertTrue</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> params<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;requests2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">instanceof</span> <span class="token class-name">Map</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>JSON<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>测试方法：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test04</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">InScopeData</span> varScopeData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InScopeData</span><span class="token punctuation">(</span><span class="token class-name">ScopeTypeEnum</span><span class="token punctuation">.</span>VARIABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    varScopeData<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;dateStr&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;2022-02-03 11:00:00&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    varScopeData<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;arName&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;AR名称&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    varScopeData<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;requests&quot;</span><span class="token punctuation">,</span> <span class="token class-name">Lists</span><span class="token punctuation">.</span><span class="token function">newArrayList</span><span class="token punctuation">(</span>
            <span class="token class-name">BusTestRequest</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token number">17</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">desc</span><span class="token punctuation">(</span><span class="token string">&quot;描述信息17&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">BusTestRequest</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">desc</span><span class="token punctuation">(</span><span class="token string">&quot;描述信息18&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">StoryRequest</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> fireRequest <span class="token operator">=</span> <span class="token class-name">ReqBuilder</span><span class="token punctuation">.</span><span class="token function">returnType</span><span class="token punctuation">(</span><span class="token class-name">Void</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">trackingType</span><span class="token punctuation">(</span><span class="token class-name">TrackingTypeEnum</span><span class="token punctuation">.</span>SERVICE_DETAIL<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">varScopeData</span><span class="token punctuation">(</span>varScopeData<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">startId</span><span class="token punctuation">(</span><span class="token string">&quot;testConverterMappingProcess&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">TaskResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> storyEngine<span class="token punctuation">.</span><span class="token function">fire</span><span class="token punctuation">(</span>fireRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertTrue</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">isSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>JSON<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>    🟢 <code>task-params</code>属性要求必须是JSON对象格式。上面例子中JSON对象中的params、reqDescList对应服务节点方法的两个入参</p> <p>    🟢 默认情况框架会拿到方法入参名从JSON对象中获取指定参数项。也可以使用<code>@TaskParam(&quot;reqId&quot;)</code>注解指定方法入参名</p> <p>    🟢 <code>task-params</code>中的变量获取表达式格式：<code>@{数据位置}</code>，比如：<code>@var.arName</code></p> <p>    🟢 <code>task-params</code>中的变量获取，同样支持表达式加$使用JSONPath获取参数。比如：<code>@$.var.requests[0].id</code></p> <p>    🟢 使用类型转换器格式：<code>{字段名}[t:{转换器名字}]</code>，比如：<code>busTest[t:map-to-bus-test]</code>，其中t不区分大小写</p> <p>    🟢 如果代码、<code>task-params</code>中同时指定某个参数的赋值，最终会以<code>task-params</code>中的为准</p> <p>    🟢 <code>task-params</code>默认开启，也可以在application.yml中配置<code>kstry.story.define-node-params=false</code>来禁用</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/doc/specification/process_choreography.html" class="prev">
        二、流程编排
      </a></span> <span class="next"><a href="/doc/specification/rbac_model.html">
        四、RBAC模式
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.fc8f11ce.js" defer></script><script src="/assets/js/2.6d18f2ff.js" defer></script><script src="/assets/js/9.c1a65384.js" defer></script>
  </body>
</html>
