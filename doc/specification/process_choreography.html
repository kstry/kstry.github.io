<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Kstry业务架构首选框架</title>
    <meta name="generator" content="VuePress 1.9.7">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.slim.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.2/jquery.fancybox.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.2/jquery.fancybox.min.css">
    <meta name="description" content="Kstry使用文档">
    
    <link rel="preload" href="/assets/css/0.styles.9634fd34.css" as="style"><link rel="preload" href="/assets/js/app.fc8f11ce.js" as="script"><link rel="preload" href="/assets/js/2.6d18f2ff.js" as="script"><link rel="preload" href="/assets/js/3.84f41dcf.js" as="script"><link rel="prefetch" href="/assets/js/10.976139c2.js"><link rel="prefetch" href="/assets/js/11.cee08e74.js"><link rel="prefetch" href="/assets/js/12.b8c547b5.js"><link rel="prefetch" href="/assets/js/13.63a0d034.js"><link rel="prefetch" href="/assets/js/14.8cab9faf.js"><link rel="prefetch" href="/assets/js/15.349558f5.js"><link rel="prefetch" href="/assets/js/16.0d2fbd26.js"><link rel="prefetch" href="/assets/js/17.af43253d.js"><link rel="prefetch" href="/assets/js/4.32e6db9d.js"><link rel="prefetch" href="/assets/js/5.a021e58e.js"><link rel="prefetch" href="/assets/js/6.8b7c2b97.js"><link rel="prefetch" href="/assets/js/7.c487ae2f.js"><link rel="prefetch" href="/assets/js/8.81adceba.js"><link rel="prefetch" href="/assets/js/9.c1a65384.js">
    <link rel="stylesheet" href="/assets/css/0.styles.9634fd34.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="http://cdn.kstry.cn/doc/img/title-field.png" alt="Kstry业务架构首选框架" class="logo"> <span class="site-name can-hide">Kstry业务架构首选框架</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/doc/understandkstry/use_case_demo.html" class="nav-link">
  使用场景
</a></div><div class="nav-item"><a href="/doc/specification/quick_start.html" class="nav-link">
  使用文档
</a></div><div class="nav-item"><a href="http://kstry.cn/modeler" target="_blank" rel="noopener noreferrer" class="nav-link external">
  配置台
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="/doc/release/kstry-release.html" class="nav-link">
  发布记录
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="推荐" class="dropdown-title"><span class="title">推荐</span> <span class="arrow down"></span></button> <button type="button" aria-label="推荐" class="mobile-dropdown-title"><span class="title">推荐</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="http://waitmoon.com/zh/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  规则引擎—ice
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="https://github.com/kstry/kstry-core" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://gitee.com/kstry/kstry-core" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Gitee
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/doc/understandkstry/use_case_demo.html" class="nav-link">
  使用场景
</a></div><div class="nav-item"><a href="/doc/specification/quick_start.html" class="nav-link">
  使用文档
</a></div><div class="nav-item"><a href="http://kstry.cn/modeler" target="_blank" rel="noopener noreferrer" class="nav-link external">
  配置台
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="/doc/release/kstry-release.html" class="nav-link">
  发布记录
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="推荐" class="dropdown-title"><span class="title">推荐</span> <span class="arrow down"></span></button> <button type="button" aria-label="推荐" class="mobile-dropdown-title"><span class="title">推荐</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="http://waitmoon.com/zh/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  规则引擎—ice
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="https://github.com/kstry/kstry-core" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://gitee.com/kstry/kstry-core" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Gitee
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><a href="/doc/specification/quick_start" class="sidebar-heading clickable open"><span>使用文档</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/doc/specification/quick_start.html" class="sidebar-link">一、快速开始</a></li><li><a href="/doc/specification/process_choreography.html" aria-current="page" class="active sidebar-link">二、流程编排</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/doc/specification/process_choreography.html#_2-1-顺序流连线" class="sidebar-link">2.1 顺序流连线</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/doc/specification/process_choreography.html#_2-1-1-使用条件表达式" class="sidebar-link">2.1.1 使用条件表达式</a></li><li class="sidebar-sub-header"><a href="/doc/specification/process_choreography.html#_2-1-2-条件表达式函数" class="sidebar-link">2.1.2 条件表达式函数</a></li><li class="sidebar-sub-header"><a href="/doc/specification/process_choreography.html#_2-1-3-条件表达式执行顺序" class="sidebar-link">2.1.3 条件表达式执行顺序</a></li></ul></li><li class="sidebar-sub-header"><a href="/doc/specification/process_choreography.html#_2-2-并行网关" class="sidebar-link">2.2 并行网关</a></li><li class="sidebar-sub-header"><a href="/doc/specification/process_choreography.html#_2-3-排他网关" class="sidebar-link">2.3 排他网关</a></li><li class="sidebar-sub-header"><a href="/doc/specification/process_choreography.html#_2-4-包含网关" class="sidebar-link">2.4 包含网关</a></li><li class="sidebar-sub-header"><a href="/doc/specification/process_choreography.html#_2-5-子流程" class="sidebar-link">2.5 子流程</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/doc/specification/process_choreography.html#_2-5-1-子流程使用" class="sidebar-link">2.5.1 子流程使用</a></li><li class="sidebar-sub-header"><a href="/doc/specification/process_choreography.html#_2-5-2-子流程拦截器" class="sidebar-link">2.5.2 子流程拦截器</a></li><li class="sidebar-sub-header"><a href="/doc/specification/process_choreography.html#_2-5-3-子流程控制" class="sidebar-link">2.5.3 子流程控制</a></li></ul></li><li class="sidebar-sub-header"><a href="/doc/specification/process_choreography.html#_2-6-节点控制" class="sidebar-link">2.6 节点控制</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/doc/specification/process_choreography.html#_2-6-1-允许服务为空" class="sidebar-link">2.6.1 允许服务为空</a></li><li class="sidebar-sub-header"><a href="/doc/specification/process_choreography.html#_2-6-2-设置超时时间" class="sidebar-link">2.6.2 设置超时时间</a></li><li class="sidebar-sub-header"><a href="/doc/specification/process_choreography.html#_2-6-3-节点异常重试" class="sidebar-link">2.6.3 节点异常重试</a></li><li class="sidebar-sub-header"><a href="/doc/specification/process_choreography.html#_2-6-4-节点异常降级" class="sidebar-link">2.6.4 节点异常降级</a></li><li class="sidebar-sub-header"><a href="/doc/specification/process_choreography.html#_2-6-5-忽略执行时异常" class="sidebar-link">2.6.5 忽略执行时异常</a></li><li class="sidebar-sub-header"><a href="/doc/specification/process_choreography.html#_2-6-6-各机制生效顺序" class="sidebar-link">2.6.6 各机制生效顺序</a></li></ul></li><li class="sidebar-sub-header"><a href="/doc/specification/process_choreography.html#_2-7-流程遍历" class="sidebar-link">2.7 流程遍历</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/doc/specification/process_choreography.html#_2-7-1-遍历属性配置" class="sidebar-link">2.7.1 遍历属性配置</a></li><li class="sidebar-sub-header"><a href="/doc/specification/process_choreography.html#_2-7-2-遍历服务节点" class="sidebar-link">2.7.2 遍历服务节点</a></li><li class="sidebar-sub-header"><a href="/doc/specification/process_choreography.html#_2-7-3-遍历子流程节点" class="sidebar-link">2.7.3 遍历子流程节点</a></li></ul></li><li class="sidebar-sub-header"><a href="/doc/specification/process_choreography.html#_2-8-服务节点拦截器" class="sidebar-link">2.8 服务节点拦截器</a></li><li class="sidebar-sub-header"><a href="/doc/specification/process_choreography.html#_2-9-自定义指令" class="sidebar-link">2.9 自定义指令</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/doc/specification/process_choreography.html#_2-9-1-定义指令" class="sidebar-link">2.9.1 定义指令</a></li><li class="sidebar-sub-header"><a href="/doc/specification/process_choreography.html#_2-9-2-使用指令" class="sidebar-link">2.9.2 使用指令</a></li></ul></li><li class="sidebar-sub-header"><a href="/doc/specification/process_choreography.html#_2-10-脚本指令" class="sidebar-link">2.10 脚本指令</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/doc/specification/process_choreography.html#_2-10-1-实现脚本指令" class="sidebar-link">2.10.1 实现脚本指令</a></li><li class="sidebar-sub-header"><a href="/doc/specification/process_choreography.html#_2-10-2-默认脚本功能" class="sidebar-link">2.10.2 默认脚本功能</a></li></ul></li><li class="sidebar-sub-header"><a href="/doc/specification/process_choreography.html#_2-11-代码方式定义流程" class="sidebar-link">2.11 代码方式定义流程</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/doc/specification/process_choreography.html#_2-11-1-主流程定义" class="sidebar-link">2.11.1 主流程定义</a></li><li class="sidebar-sub-header"><a href="/doc/specification/process_choreography.html#_2-11-2-子流程定义" class="sidebar-link">2.11.2 子流程定义</a></li><li class="sidebar-sub-header"><a href="/doc/specification/process_choreography.html#_2-11-3-解析文件定义流程" class="sidebar-link">2.11.3 解析文件定义流程</a></li></ul></li><li class="sidebar-sub-header"><a href="/doc/specification/process_choreography.html#_2-12-动态流程配置" class="sidebar-link">2.12 动态流程配置</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/doc/specification/process_choreography.html#_2-12-1-使用动态流程" class="sidebar-link">2.12.1 使用动态流程</a></li><li class="sidebar-sub-header"><a href="/doc/specification/process_choreography.html#_2-12-2-使用动态子流程" class="sidebar-link">2.12.2 使用动态子流程</a></li><li class="sidebar-sub-header"><a href="/doc/specification/process_choreography.html#_2-12-3-动态与静态流程关系" class="sidebar-link">2.12.3 动态与静态流程关系</a></li></ul></li><li class="sidebar-sub-header"><a href="/doc/specification/process_choreography.html#_2-13-使用异步流程" class="sidebar-link">2.13 使用异步流程</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/doc/specification/process_choreography.html#_2-13-1-开启异步" class="sidebar-link">2.13.1 开启异步</a></li><li class="sidebar-sub-header"><a href="/doc/specification/process_choreography.html#_2-13-2-异步化生命周期" class="sidebar-link">2.13.2 异步化生命周期</a></li><li class="sidebar-sub-header"><a href="/doc/specification/process_choreography.html#_2-13-3-线程切换钩子" class="sidebar-link">2.13.3 线程切换钩子</a></li><li class="sidebar-sub-header"><a href="/doc/specification/process_choreography.html#_2-13-4-reactor模型" class="sidebar-link">2.13.4 Reactor模型</a></li></ul></li></ul></li><li><a href="/doc/specification/data_transfer.html" class="sidebar-link">三、数据流转</a></li><li><a href="/doc/specification/rbac_model.html" class="sidebar-link">四、RBAC模式</a></li><li><a href="/doc/specification/use_variable.html" class="sidebar-link">五、变量</a></li><li><a href="/doc/specification/link_tracing.html" class="sidebar-link">六、链路追踪</a></li><li><a href="/doc/specification/appendix.html" class="sidebar-link">附录</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>流程编排可以让系统提供的服务能力做到可视化，业务逻辑一目了然。BPMN图形中支持普通流程图和泳道图</p></div> <p><strong>普通流程图：</strong></p> <p><a data-fancybox="" title="普通流程图" href="http://cdn.kstry.cn/doc/img/image-20211219163540179.png"><img src="http://cdn.kstry.cn/doc/img/image-20211219163540179.png" alt="image-20211219163540179"></a></p> <p><strong>泳道图：</strong></p> <p><a data-fancybox="" title="泳道图" href="http://cdn.kstry.cn/doc/img/image-20211219163429668.png"><img src="http://cdn.kstry.cn/doc/img/image-20211219163429668.png" alt="image-20211219163429668"></a></p> <h2 id="_2-1-顺序流连线"><a href="#_2-1-顺序流连线" class="header-anchor">#</a> 2.1 顺序流连线</h2> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>Kstry框架沿用了BPMN协议中的概念，流程图中节点与节点之间需要以有向线段连接，以此来定义组件间的前后调用关系。判断是否继续执行下一节点的条件表达式也是定义在这里的</p></div> <h3 id="_2-1-1-使用条件表达式"><a href="#_2-1-1-使用条件表达式" class="header-anchor">#</a> 2.1.1 使用条件表达式</h3> <p><strong>BPMN图示如下：</strong></p> <p><a data-fancybox="" title="开始事件流程判断" href="../img2/d063abb195251c78b57c4135f9585366.png"><img src="/assets/img/d063abb195251c78b57c4135f9585366.2d8a3375.png" alt="WX20231009"></a></p> <blockquote><p><strong>代码方式定义上述流程：</strong></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">ProcessLink</span> <span class="token function">startEventSequenceFlowProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">StartProcessLink</span> processLink <span class="token operator">=</span> <span class="token class-name">StartProcessLink</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token class-name">ProcessConfig</span><span class="token operator">::</span><span class="token function">startEventSequenceFlowProcess</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    processLink<span class="token punctuation">.</span><span class="token function">nextService</span><span class="token punctuation">(</span><span class="token string">&quot;var.type == 1&quot;</span><span class="token punctuation">,</span> <span class="token class-name">CalculateService</span><span class="token operator">::</span><span class="token function">plusCalculate</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    processLink<span class="token punctuation">.</span><span class="token function">nextService</span><span class="token punctuation">(</span><span class="token string">&quot;var.type == 2&quot;</span><span class="token punctuation">,</span> <span class="token class-name">CalculateService</span><span class="token operator">::</span><span class="token function">multiplyCalculate</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> processLink<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div></blockquote> <p><strong>定义服务组件并测试：</strong></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@TaskComponent</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CalculateService</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@NoticeResult</span>
    <span class="token annotation punctuation">@TaskService</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">plusCalculate</span><span class="token punctuation">(</span><span class="token annotation punctuation">@VarTaskParam</span> <span class="token keyword">int</span> a<span class="token punctuation">,</span> <span class="token annotation punctuation">@VarTaskParam</span> <span class="token keyword">int</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> a <span class="token operator">+</span> b<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@NoticeResult</span>
    <span class="token annotation punctuation">@TaskService</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">multiplyCalculate</span><span class="token punctuation">(</span><span class="token annotation punctuation">@VarTaskParam</span> <span class="token keyword">int</span> a<span class="token punctuation">,</span> <span class="token annotation punctuation">@VarTaskParam</span> <span class="token keyword">int</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> a <span class="token operator">*</span> b<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * type = 1 时执行加法
 */</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testPlusCalculateByType1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">InScopeData</span> varScopeData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InScopeData</span><span class="token punctuation">(</span><span class="token class-name">ScopeTypeEnum</span><span class="token punctuation">.</span>VARIABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    varScopeData<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">CommonFields<span class="token punctuation">.</span>F</span><span class="token punctuation">.</span>type<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    varScopeData<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">CommonFields<span class="token punctuation">.</span>F</span><span class="token punctuation">.</span>a<span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    varScopeData<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">CommonFields<span class="token punctuation">.</span>F</span><span class="token punctuation">.</span>b<span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">StoryRequest</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> fireRequest <span class="token operator">=</span> <span class="token class-name">ReqBuilder</span><span class="token punctuation">.</span><span class="token function">returnType</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">trackingType</span><span class="token punctuation">(</span><span class="token class-name">TrackingTypeEnum</span><span class="token punctuation">.</span>SERVICE_DETAIL<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">varScopeData</span><span class="token punctuation">(</span>varScopeData<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">startId</span><span class="token punctuation">(</span><span class="token string">&quot;start-event-sequence-flow-test&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">TaskResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> storyEngine<span class="token punctuation">.</span><span class="token function">fire</span><span class="token punctuation">(</span>fireRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertTrue</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">isSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token number">17</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> result<span class="token punctuation">.</span><span class="token function">getResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * type = 2 时执行乘法
 */</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testMultiplyCalculateByType2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">InScopeData</span> varScopeData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InScopeData</span><span class="token punctuation">(</span><span class="token class-name">ScopeTypeEnum</span><span class="token punctuation">.</span>VARIABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    varScopeData<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">CommonFields<span class="token punctuation">.</span>F</span><span class="token punctuation">.</span>type<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    varScopeData<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">CommonFields<span class="token punctuation">.</span>F</span><span class="token punctuation">.</span>a<span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    varScopeData<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">CommonFields<span class="token punctuation">.</span>F</span><span class="token punctuation">.</span>b<span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">StoryRequest</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> fireRequest <span class="token operator">=</span> <span class="token class-name">ReqBuilder</span><span class="token punctuation">.</span><span class="token function">returnType</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">trackingType</span><span class="token punctuation">(</span><span class="token class-name">TrackingTypeEnum</span><span class="token punctuation">.</span>SERVICE_DETAIL<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">varScopeData</span><span class="token punctuation">(</span>varScopeData<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">startId</span><span class="token punctuation">(</span><span class="token string">&quot;start-event-sequence-flow-test&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">TaskResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> storyEngine<span class="token punctuation">.</span><span class="token function">fire</span><span class="token punctuation">(</span>fireRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertTrue</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">isSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token number">66</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> result<span class="token punctuation">.</span><span class="token function">getResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br></div></div><p>    🟢 如上所示定义了<code>CalculateService</code>服务组件，里面分别包含一个加法和乘法运算。两服务节点前的连线分别定义了<code>var.type == 1</code>和<code>var.type == 2</code>两个表达式，当type被分别指定1、2时，程序会执行对应的加法或乘法运算</p> <p>    🟢 Kstry 引擎中条件表达式解析器有三个，boolean解析器、角色鉴权解析器、Spel表达式解析器</p> <p>        🔷 如果是直接输入boolean值，比如 true、y、no等会被认定为 boolean 值，使用 boolean 解析器解析判断</p> <p>        🔷 如果符合权限定义的格式，使用角色鉴权解析器解析判断，后面讲到角色权限时会再详细介绍</p> <p>        🔷 前两者都不符合时则使用Spel表达式解析器，解析引擎是 Spring 的 Spel 解析器，表达式格式解析失败时会报错。解析结果一定得是Boolean值</p> <p>    🟢 事件（Event）、服务节点（ServiceTask）、网关（Gateway）都可以从当前节点引出多个支路（也叫允许有多个出度），但是<strong>只有并行网关、包含网关、结束事件可以接收多个入度</strong>，其他节点有多个入度时会出现配置文件解析失败的报错</p> <p>    🟢 服务节点（ServiceTask）、事件（Event）后面的出度如果没有定义表达式时，默认为true。不同类型的网关（Gateway）特点不同，后面会详细介绍</p> <h3 id="_2-1-2-条件表达式函数"><a href="#_2-1-2-条件表达式函数" class="header-anchor">#</a> 2.1.2 条件表达式函数</h3> <p>    在流程定义中，如果遇到了比较复杂的条件表达式，仅仅使用普通条件表达式无法满足诉求时，就需要考虑使用条件表达式函数了。假设需要将上述例子中的<code>var.type == 1</code>改成使用Java中的<code>Objects.equals()</code>函数来进行判断，可以按以下方式来定义：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomExpressionFunction</span> <span class="token keyword">implements</span> <span class="token class-name">ExpressionAliasRegister</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ExpressionAlias</span><span class="token punctuation">&gt;</span></span> <span class="token function">registerAlias</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Lists</span><span class="token punctuation">.</span><span class="token function">newArrayList</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ExpressionAlias</span><span class="token punctuation">(</span><span class="token string">&quot;eq&quot;</span><span class="token punctuation">,</span> <span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">&quot;equals&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>上述定义完成之后，<code>var.type == 1</code>表达式就可以改成<code>@eq(var.type, 1)</code>了。表达式函数使用格式是：<code>@{函数别名}({方法入参...})</code></p> <p>    🟢 任意定义一个类实现<code>ExpressionAliasRegister</code>接口，并将该类放到Spring容器中</p> <p>    🟢 实现<code>ExpressionAliasRegister</code>接口后需要实现<code>registerAlias()</code>方法，该方法返回一个<code>ExpressionAlias</code>对象的集合</p> <p>    🟢 <code>ExpressionAlias</code>对象构造函数有三个入参，含义依次是：使用函数时的别名、使用代码中的哪个类、使用类中的哪个静态方法的方法名 <strong>（需要注意一定得是类中静态的Public方法）</strong></p> <p>    🟢 表达式函数支持并列和嵌套，类似这种<code>@eq(@toInt(@toString(var.type)), @toInt('1')) &amp;&amp; @noneNull(var.type)</code>抽风的表达式也是可以正常执行的</p> <p>    🟢 <strong>可以定义与业务强相关的表达式函数来进行路由判断。当然表达式函数的功能之强大并不仅仅局限在条件判断上，甚至可以通过自定义函数接收数据域中的对象来进行操作。</strong> 比如类型转换、加工对象中的某些字段等</p> <p>    为了方便使用，框架提供了一些默认的表达式函数，在需要这些函数时无需额外定义就可以直接使用了。默认表达式函数的定义也同样使用了上述的方式，可以参考源码中的<code>BasicExpressionAliasRegister</code>来了解具体支持了哪些默认函数。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BasicExpressionAliasRegister</span> <span class="token keyword">implements</span> <span class="token class-name">ExpressionAliasRegister</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ExpressionAlias</span><span class="token punctuation">&gt;</span></span> <span class="token function">registerAlias</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Lists</span><span class="token punctuation">.</span><span class="token function">newArrayList</span><span class="token punctuation">(</span>
                <span class="token comment">// object util</span>
                <span class="token keyword">new</span> <span class="token class-name">ExpressionAlias</span><span class="token punctuation">(</span><span class="token class-name">Exp</span><span class="token punctuation">.</span>equals<span class="token punctuation">,</span> <span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">&quot;equals&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">ExpressionAlias</span><span class="token punctuation">(</span><span class="token class-name">Exp</span><span class="token punctuation">.</span>notEquals<span class="token punctuation">,</span> <span class="token class-name">ExpressionAliasUtil</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">&quot;notEquals&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">ExpressionAlias</span><span class="token punctuation">(</span><span class="token class-name">Exp</span><span class="token punctuation">.</span>isNull<span class="token punctuation">,</span> <span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">&quot;isNull&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">ExpressionAlias</span><span class="token punctuation">(</span><span class="token class-name">Exp</span><span class="token punctuation">.</span>notNull<span class="token punctuation">,</span> <span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">&quot;nonNull&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">ExpressionAlias</span><span class="token punctuation">(</span><span class="token class-name">Exp</span><span class="token punctuation">.</span>anyNull<span class="token punctuation">,</span> <span class="token class-name">ExpressionAliasUtil</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">&quot;anyNull&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">ExpressionAlias</span><span class="token punctuation">(</span><span class="token class-name">Exp</span><span class="token punctuation">.</span>noneNull<span class="token punctuation">,</span> <span class="token class-name">ObjectUtils</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">&quot;allNotNull&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

                <span class="token comment">// string util</span>
                <span class="token keyword">new</span> <span class="token class-name">ExpressionAlias</span><span class="token punctuation">(</span><span class="token class-name">Exp</span><span class="token punctuation">.</span>isBlank<span class="token punctuation">,</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">&quot;isBlank&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">ExpressionAlias</span><span class="token punctuation">(</span><span class="token class-name">Exp</span><span class="token punctuation">.</span>notBlank<span class="token punctuation">,</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">&quot;isNotBlank&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">ExpressionAlias</span><span class="token punctuation">(</span><span class="token class-name">Exp</span><span class="token punctuation">.</span>noneBlank<span class="token punctuation">,</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">&quot;isNoneBlank&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">ExpressionAlias</span><span class="token punctuation">(</span><span class="token class-name">Exp</span><span class="token punctuation">.</span>allBlank<span class="token punctuation">,</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">&quot;isAllBlank&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">ExpressionAlias</span><span class="token punctuation">(</span><span class="token class-name">Exp</span><span class="token punctuation">.</span>anyBlank<span class="token punctuation">,</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">&quot;isAnyBlank&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">ExpressionAlias</span><span class="token punctuation">(</span><span class="token class-name">Exp</span><span class="token punctuation">.</span>toString<span class="token punctuation">,</span> <span class="token class-name">ExpressionAliasUtil</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">&quot;toString&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

                <span class="token comment">// number util</span>
                <span class="token keyword">new</span> <span class="token class-name">ExpressionAlias</span><span class="token punctuation">(</span><span class="token class-name">Exp</span><span class="token punctuation">.</span>isNumber<span class="token punctuation">,</span> <span class="token class-name">NumberUtils</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">&quot;isCreatable&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">ExpressionAlias</span><span class="token punctuation">(</span><span class="token class-name">Exp</span><span class="token punctuation">.</span>toInt<span class="token punctuation">,</span> <span class="token class-name">NumberUtils</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">&quot;toInt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">ExpressionAlias</span><span class="token punctuation">(</span><span class="token class-name">Exp</span><span class="token punctuation">.</span>toLong<span class="token punctuation">,</span> <span class="token class-name">NumberUtils</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">&quot;toLong&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">ExpressionAlias</span><span class="token punctuation">(</span><span class="token class-name">Exp</span><span class="token punctuation">.</span>toDouble<span class="token punctuation">,</span> <span class="token class-name">NumberUtils</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">&quot;toDouble&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">ExpressionAlias</span><span class="token punctuation">(</span><span class="token class-name">Exp</span><span class="token punctuation">.</span>toFloat<span class="token punctuation">,</span> <span class="token class-name">NumberUtils</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">&quot;toFloat&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">ExpressionAlias</span><span class="token punctuation">(</span><span class="token class-name">Exp</span><span class="token punctuation">.</span>toByte<span class="token punctuation">,</span> <span class="token class-name">NumberUtils</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">&quot;toByte&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">ExpressionAlias</span><span class="token punctuation">(</span><span class="token class-name">Exp</span><span class="token punctuation">.</span>toShort<span class="token punctuation">,</span> <span class="token class-name">NumberUtils</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">&quot;toShort&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

                <span class="token comment">// bool util</span>
                <span class="token keyword">new</span> <span class="token class-name">ExpressionAlias</span><span class="token punctuation">(</span><span class="token class-name">Exp</span><span class="token punctuation">.</span>toBool<span class="token punctuation">,</span> <span class="token class-name">BooleanUtils</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">&quot;toBoolean&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">ExpressionAlias</span><span class="token punctuation">(</span><span class="token class-name">Exp</span><span class="token punctuation">.</span>isTrue<span class="token punctuation">,</span> <span class="token class-name">BooleanUtils</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">&quot;isTrue&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">ExpressionAlias</span><span class="token punctuation">(</span><span class="token class-name">Exp</span><span class="token punctuation">.</span>isFalse<span class="token punctuation">,</span> <span class="token class-name">BooleanUtils</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">&quot;isFalse&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">ExpressionAlias</span><span class="token punctuation">(</span><span class="token class-name">Exp</span><span class="token punctuation">.</span>notFalse<span class="token punctuation">,</span> <span class="token class-name">BooleanUtils</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">&quot;isNotFalse&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">ExpressionAlias</span><span class="token punctuation">(</span><span class="token class-name">Exp</span><span class="token punctuation">.</span>notTrue<span class="token punctuation">,</span> <span class="token class-name">BooleanUtils</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">&quot;isNotTrue&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

                <span class="token comment">// common util</span>
                <span class="token keyword">new</span> <span class="token class-name">ExpressionAlias</span><span class="token punctuation">(</span><span class="token class-name">Exp</span><span class="token punctuation">.</span>max<span class="token punctuation">,</span> <span class="token class-name">ObjectUtils</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">&quot;max&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">ExpressionAlias</span><span class="token punctuation">(</span><span class="token class-name">Exp</span><span class="token punctuation">.</span>min<span class="token punctuation">,</span> <span class="token class-name">ObjectUtils</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">&quot;min&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">ExpressionAlias</span><span class="token punctuation">(</span><span class="token class-name">Exp</span><span class="token punctuation">.</span>isEmpty<span class="token punctuation">,</span> <span class="token class-name">ExpressionAliasUtil</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">&quot;isEmpty&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">ExpressionAlias</span><span class="token punctuation">(</span><span class="token class-name">Exp</span><span class="token punctuation">.</span>notEmpty<span class="token punctuation">,</span> <span class="token class-name">ExpressionAliasUtil</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">&quot;notEmpty&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">ExpressionAlias</span><span class="token punctuation">(</span><span class="token class-name">Exp</span><span class="token punctuation">.</span>contains<span class="token punctuation">,</span> <span class="token class-name">ExpressionAliasUtil</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">&quot;contains&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">ExpressionAlias</span><span class="token punctuation">(</span><span class="token class-name">Exp</span><span class="token punctuation">.</span>size<span class="token punctuation">,</span> <span class="token class-name">ExpressionAliasUtil</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">&quot;size&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">ExpressionAlias</span><span class="token punctuation">(</span><span class="token class-name">Exp</span><span class="token punctuation">.</span>validId<span class="token punctuation">,</span> <span class="token class-name">ExpressionAliasUtil</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">&quot;validId&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br></div></div><p>    当通过代码方式定义流程时，框架还提供了<code>Exp</code>类来辅助定义条件表达式，比如上面的流程就可以写成下面这种</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">ProcessLink</span> <span class="token function">startEventSequenceFlowProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">StartProcessLink</span> processLink <span class="token operator">=</span> <span class="token class-name">StartProcessLink</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token class-name">ProcessConfig</span><span class="token operator">::</span><span class="token function">startEventSequenceFlowProcess</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    processLink<span class="token punctuation">.</span><span class="token function">nextService</span><span class="token punctuation">(</span><span class="token class-name">Exp</span><span class="token punctuation">.</span><span class="token function">b</span><span class="token punctuation">(</span>e <span class="token operator">-&gt;</span> e<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;var.type&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">CalculateService</span><span class="token operator">::</span><span class="token function">plusCalculate</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    processLink<span class="token punctuation">.</span><span class="token function">nextService</span><span class="token punctuation">(</span><span class="token class-name">Exp</span><span class="token punctuation">.</span><span class="token function">b</span><span class="token punctuation">(</span>e <span class="token operator">-&gt;</span> e<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;var.type&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">CalculateService</span><span class="token operator">::</span><span class="token function">multiplyCalculate</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> processLink<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>    自定义函数时，还可以自定义工具类继承<code>Exp</code>来扩展支持</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * 扩展工具类
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Ex</span> <span class="token keyword">extends</span> <span class="token class-name">Exp</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Ex</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token class-name">Ex</span> <span class="token function">customEquals</span><span class="token punctuation">(</span><span class="token class-name">String</span> left<span class="token punctuation">,</span> <span class="token class-name">String</span> right<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>expression <span class="token operator">=</span> <span class="token class-name">GlobalUtil</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;{}@eq({}, {})&quot;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>expression<span class="token punctuation">,</span> left<span class="token punctuation">,</span> right<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">bu</span><span class="token punctuation">(</span><span class="token class-name">Consumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Ex</span><span class="token punctuation">&gt;</span></span> builder<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">b</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Ex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> builder<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">ProcessLink</span> <span class="token function">startEventSequenceFlowProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">StartProcessLink</span> processLink <span class="token operator">=</span> <span class="token class-name">StartProcessLink</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token class-name">ProcessConfig</span><span class="token operator">::</span><span class="token function">startEventSequenceFlowProcess</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    processLink<span class="token punctuation">.</span><span class="token function">nextService</span><span class="token punctuation">(</span><span class="token class-name">Ex</span><span class="token punctuation">.</span><span class="token function">bu</span><span class="token punctuation">(</span>e <span class="token operator">-&gt;</span> e<span class="token punctuation">.</span><span class="token function">customEquals</span><span class="token punctuation">(</span><span class="token string">&quot;var.type&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">CalculateService</span><span class="token operator">::</span><span class="token function">plusCalculate</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    processLink<span class="token punctuation">.</span><span class="token function">nextService</span><span class="token punctuation">(</span><span class="token class-name">Ex</span><span class="token punctuation">.</span><span class="token function">bu</span><span class="token punctuation">(</span>e <span class="token operator">-&gt;</span> e<span class="token punctuation">.</span><span class="token function">customEquals</span><span class="token punctuation">(</span><span class="token string">&quot;var.type&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">CalculateService</span><span class="token operator">::</span><span class="token function">multiplyCalculate</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> processLink<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h3 id="_2-1-3-条件表达式执行顺序"><a href="#_2-1-3-条件表达式执行顺序" class="header-anchor">#</a> 2.1.3 条件表达式执行顺序</h3> <p>    支持<code>o{数字}: 表达式</code>(比如：<code>o1: var.type == 1</code> )，来定义各个支路上表达式的执行顺序，数字越小优先级越高。<strong>未指定顺序时表达式默认为最低优先级</strong></p> <p><a data-fancybox="" title="条件表达式指定执行顺序" href="../img2/42c62ea012598b30abebc0bfc4786141.png"><img src="/assets/img/42c62ea012598b30abebc0bfc4786141.875e0fd5.png" alt="42c62ea012598b30abebc0bfc4786141"></a></p> <p>     上图由于指定了流程表达式优先级为1，所以乘法计算服务节点前的表达式会先被执行，之后才会是加法计算服务节前的表达式。</p> <p>     再一个场景排他网关出度连线上的表达式，只要有一个执行结果为true，其他出度后面的流程都不会再执行了，同样的与他们相关的条件表达式也不会再执行。此时就可能需要指定哪个条件先判断。节点多个出度表达式分别设置执行顺序就相当于是代码中的<code>if... else if... else if... else</code></p> <h2 id="_2-2-并行网关"><a href="#_2-2-并行网关" class="header-anchor">#</a> 2.2 并行网关</h2> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>程序中经常会遇到一些通过并发调用各类接口来加载各类资源信息的例子，通过并发操作可以获取更短的响应时长。在Kstry框架中只要后一个节点的入参和前一个节点的出参没有前后依赖关系就可以通过并行网关配置并行</p></div> <p><strong>BPMN图示如下：</strong></p> <p><a data-fancybox="" title="并行网关演示" href="../img2/ea9b796b911997a82d0058487f0e8deb.png"><img src="/assets/img/ea9b796b911997a82d0058487f0e8deb.e88ff160.png" alt="ea9b796b911997a82d0058487f0e8deb"></a></p> <blockquote><p><strong>代码方式定义上述流程：</strong></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">ProcessLink</span> <span class="token function">testParallelGatewayDemoProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">StartProcessLink</span> processLink <span class="token operator">=</span> <span class="token class-name">StartProcessLink</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token class-name">ProcessConfig</span><span class="token operator">::</span><span class="token function">testParallelGatewayDemoProcess</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ParallelJoinPoint</span> parallelJoinPoint <span class="token operator">=</span> processLink<span class="token punctuation">.</span><span class="token function">nextParallel</span><span class="token punctuation">(</span>processLink<span class="token punctuation">.</span><span class="token function">parallel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">openAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    processLink<span class="token punctuation">.</span><span class="token function">parallel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">joinLinks</span><span class="token punctuation">(</span>
            parallelJoinPoint<span class="token punctuation">.</span><span class="token function">nextService</span><span class="token punctuation">(</span><span class="token class-name">FlowDemoService</span><span class="token operator">::</span><span class="token function">getStudentInfo</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            parallelJoinPoint<span class="token punctuation">.</span><span class="token function">nextService</span><span class="token punctuation">(</span><span class="token class-name">FlowDemoService</span><span class="token operator">::</span><span class="token function">getClassInfo</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> processLink<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div></blockquote> <p><strong>定义服务组件：</strong></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@NoticeVar</span>
<span class="token annotation punctuation">@TaskService</span><span class="token punctuation">(</span>desc <span class="token operator">=</span> <span class="token string">&quot;获取学生信息&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">Student</span> <span class="token function">getStudentInfo</span><span class="token punctuation">(</span><span class="token annotation punctuation">@VarTaskParam</span> <span class="token class-name">Long</span> studentId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Student</span> student <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    student<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>studentId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    student<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">&quot;Name&quot;</span> <span class="token operator">+</span> studentId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> student<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@NoticeVar</span>
<span class="token annotation punctuation">@TaskService</span><span class="token punctuation">(</span>desc <span class="token operator">=</span> <span class="token string">&quot;获取班级信息&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">ClassInfo</span> <span class="token function">getClassInfo</span><span class="token punctuation">(</span><span class="token annotation punctuation">@VarTaskParam</span> <span class="token class-name">Long</span> classId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">ClassInfo</span> classInfo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    classInfo<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>classId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    classInfo<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">&quot;Name&quot;</span> <span class="token operator">+</span> classId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> classInfo<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p><strong>测试执行：</strong></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testParallelGatewayDemo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// var 域初始化数据</span>
    <span class="token class-name">InScopeData</span> varScopeData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InScopeData</span><span class="token punctuation">(</span><span class="token class-name">ScopeTypeEnum</span><span class="token punctuation">.</span>VARIABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    varScopeData<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">CommonFields<span class="token punctuation">.</span>F</span><span class="token punctuation">.</span>studentId<span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    varScopeData<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">CommonFields<span class="token punctuation">.</span>F</span><span class="token punctuation">.</span>classId<span class="token punctuation">,</span> <span class="token number">66</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 构造request</span>
    <span class="token class-name">StoryRequest</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> fireRequest <span class="token operator">=</span> <span class="token class-name">ReqBuilder</span><span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token function">resultType</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">trackingType</span><span class="token punctuation">(</span><span class="token class-name">TrackingTypeEnum</span><span class="token punctuation">.</span>SERVICE_DETAIL<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">varScopeData</span><span class="token punctuation">(</span>varScopeData<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">startId</span><span class="token punctuation">(</span><span class="token string">&quot;start-event-parallel-gateway-demo&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">resultBuilder</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Object</span> r<span class="token punctuation">,</span> <span class="token class-name">ScopeDataQuery</span> query<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span> <span class="token comment">// r: 流程执行完返回的结果（如果有）</span>
                <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> objMap <span class="token operator">=</span> <span class="token class-name">Maps</span><span class="token punctuation">.</span><span class="token function">newHashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                objMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">CommonFields<span class="token punctuation">.</span>F</span><span class="token punctuation">.</span>student<span class="token punctuation">,</span> query<span class="token punctuation">.</span><span class="token function">getVarData</span><span class="token punctuation">(</span><span class="token class-name">CommonFields<span class="token punctuation">.</span>F</span><span class="token punctuation">.</span>student<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                objMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">CommonFields<span class="token punctuation">.</span>F</span><span class="token punctuation">.</span>classInfo<span class="token punctuation">,</span> query<span class="token punctuation">.</span><span class="token function">getVarData</span><span class="token punctuation">(</span><span class="token class-name">CommonFields<span class="token punctuation">.</span>F</span><span class="token punctuation">.</span>classInfo<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> objMap<span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 执行</span>
    <span class="token class-name">TaskResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> storyEngine<span class="token punctuation">.</span><span class="token function">fire</span><span class="token punctuation">(</span>fireRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertTrue</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">isSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertNotNull</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">CommonFields<span class="token punctuation">.</span>F</span><span class="token punctuation">.</span>student<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertNotNull</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">CommonFields<span class="token punctuation">.</span>F</span><span class="token punctuation">.</span>classInfo<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>    🟢 使用并行网关时，一般会有前后两个并行网关节点一起出现，前面将一个分支拆解成多个，后面将多个分支进行聚合</p> <p>    🟢 并行网关支持开启异步流程。未开启异步流程时，并行网关拆分出的多个分支还是一个线程逐一执行，开启异步流程后，每个分支都会被构建成异步任务提交到线程池中执行</p> <p>    🟢 当并行网关后要执行的分支数量为1时，开启并发的操作无效，还会是当前线程同步执行后面一个分支的任务</p> <p>    🟢 并行网关后面的出度如果有表达式，表达式会被忽略，无论设置与否都不会解析，都会默认为true</p> <p>    🟢 <strong>并行网关要求所有入度全部执行完才能向下继续</strong>，否则将一直等待。如果并行网关入度中由于表达式执行结果为false等原因导致不可达时会有类似报错：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>[K1040008] A process branch that cannot reach the ParallelGateway appears! sequence flow: SEQUENCE_FLOW:[id: c9c35988942e4ac79bab9a5689522887-7, name: ], parallel gateway: PARALLEL_GATEWAY:[id: 154a637311c646b1ad54e969eaa52b41-10, name: null]
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>    🟢 解决这个问题有两种方式：</p> <p>        🔷 将并行网关改为包含网关，包含网关不要求所有入度分支都必须被执行，并且还拥有并行网关开启并发、汇聚并行分支等特性</p> <p>        🔷 如下图，关闭并行网关的严格模式：<code>strict-mode=false</code>。关闭严格模式的并行网关，不再限制网关入度必须都被执行。关闭严格模式的并行网关与包含网关也并非是完全等价的。因为并行网关后面出度的条件表达式是被忽略的，但是包含网关后面出度的条件表达式是会被解析执行起到决策作用的</p> <p><a data-fancybox="" title="并行网关设置成非严格模式" href="../img2/c7566eadd23cf8f33b54a6bec6b210e8.png"><img src="/assets/img/c7566eadd23cf8f33b54a6bec6b210e8.8e9bc50b.png" alt="c7566eadd23cf8f33b54a6bec6b210e8"></a></p> <h2 id="_2-3-排他网关"><a href="#_2-3-排他网关" class="header-anchor">#</a> 2.3 排他网关</h2> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>程序中经常会使用<code>if... else if... else if... else...</code>的逻辑。Kstry框架中可以使用排他网关实现完全相同的逻辑。“排他”顾名思义，网关后面最终只有一个分支被执行，其他分支都会被中断</p></div> <p><strong>BPMN图示如下：</strong></p> <p><a data-fancybox="" title="排他网关演示" href="../img2/77160e7ab6d657b90d0604442caaf9f9.png"><img src="/assets/img/77160e7ab6d657b90d0604442caaf9f9.0be516a6.png" alt="77160e7ab6d657b90d0604442caaf9f9"></a></p> <blockquote><p>介绍顺序流连线时有提及，框架支持o{数字}: 表达式(比如：<code>O1: @equals(var.factor, '+')</code> )，来定义各个支路上表达式的执行顺序，数字越小优先级越高。未指定顺序时表达式默认为最低优先级</p></blockquote> <blockquote><p><strong>代码方式定义上述流程：</strong></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">ProcessLink</span> <span class="token function">testExclusiveGatewayDemoProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">StartProcessLink</span> processLink <span class="token operator">=</span> <span class="token class-name">StartProcessLink</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token class-name">ProcessConfig</span><span class="token operator">::</span><span class="token function">testExclusiveGatewayDemoProcess</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ProcessLink</span> exclusive <span class="token operator">=</span> processLink<span class="token punctuation">.</span><span class="token function">nextExclusive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    exclusive<span class="token punctuation">.</span><span class="token function">nextService</span><span class="token punctuation">(</span><span class="token class-name">Ex</span><span class="token punctuation">.</span><span class="token function">b</span><span class="token punctuation">(</span>e <span class="token operator">-&gt;</span> e<span class="token punctuation">.</span><span class="token function">order</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;var.factor&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;'+'&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">CalculateService</span><span class="token operator">::</span><span class="token function">plusCalculate</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    exclusive<span class="token punctuation">.</span><span class="token function">nextService</span><span class="token punctuation">(</span><span class="token class-name">Ex</span><span class="token punctuation">.</span><span class="token function">b</span><span class="token punctuation">(</span>e <span class="token operator">-&gt;</span> e<span class="token punctuation">.</span><span class="token function">order</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;var.factor&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;'*'&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">CalculateService</span><span class="token operator">::</span><span class="token function">multiplyCalculate</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    exclusive<span class="token punctuation">.</span><span class="token function">nextService</span><span class="token punctuation">(</span><span class="token class-name">CalculateService</span><span class="token operator">::</span><span class="token function">minusCalculate</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> processLink<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div></blockquote> <p><strong>定义服务组件：</strong></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@NoticeResult</span>
<span class="token annotation punctuation">@TaskService</span>
<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">plusCalculate</span><span class="token punctuation">(</span><span class="token annotation punctuation">@VarTaskParam</span> <span class="token keyword">int</span> a<span class="token punctuation">,</span> <span class="token annotation punctuation">@VarTaskParam</span> <span class="token keyword">int</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> a <span class="token operator">+</span> b<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@NoticeResult</span>
<span class="token annotation punctuation">@TaskService</span>
<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">multiplyCalculate</span><span class="token punctuation">(</span><span class="token annotation punctuation">@VarTaskParam</span> <span class="token keyword">int</span> a<span class="token punctuation">,</span> <span class="token annotation punctuation">@VarTaskParam</span> <span class="token keyword">int</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> a <span class="token operator">*</span> b<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@NoticeResult</span>
<span class="token annotation punctuation">@TaskService</span>
<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">minusCalculate</span><span class="token punctuation">(</span><span class="token annotation punctuation">@VarTaskParam</span> <span class="token keyword">int</span> a<span class="token punctuation">,</span> <span class="token annotation punctuation">@VarTaskParam</span> <span class="token keyword">int</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> a <span class="token operator">-</span> b<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p><strong>测试执行：</strong></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testExclusiveGatewayDemo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// var 域初始化数据</span>
    <span class="token class-name">InScopeData</span> varScopeData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InScopeData</span><span class="token punctuation">(</span><span class="token class-name">ScopeTypeEnum</span><span class="token punctuation">.</span>VARIABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    varScopeData<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">CommonFields<span class="token punctuation">.</span>F</span><span class="token punctuation">.</span>a<span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    varScopeData<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">CommonFields<span class="token punctuation">.</span>F</span><span class="token punctuation">.</span>b<span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 构造request</span>
    <span class="token class-name">StoryRequest</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> fireRequest <span class="token operator">=</span> <span class="token class-name">ReqBuilder</span><span class="token punctuation">.</span><span class="token function">returnType</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">trackingType</span><span class="token punctuation">(</span><span class="token class-name">TrackingTypeEnum</span><span class="token punctuation">.</span>SERVICE_DETAIL<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">varScopeData</span><span class="token punctuation">(</span>varScopeData<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">startId</span><span class="token punctuation">(</span><span class="token string">&quot;start-event-exclusive-gateway-demo&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 执行 默认</span>
    <span class="token class-name">TaskResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> storyEngine<span class="token punctuation">.</span><span class="token function">fire</span><span class="token punctuation">(</span>fireRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertTrue</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">isSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> result<span class="token punctuation">.</span><span class="token function">getResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 执行 +</span>
    varScopeData<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">CommonFields<span class="token punctuation">.</span>F</span><span class="token punctuation">.</span>factor<span class="token punctuation">,</span> <span class="token string">&quot;+&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    result <span class="token operator">=</span> storyEngine<span class="token punctuation">.</span><span class="token function">fire</span><span class="token punctuation">(</span>fireRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertTrue</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">isSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> result<span class="token punctuation">.</span><span class="token function">getResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">17</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 执行 *</span>
    varScopeData<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">CommonFields<span class="token punctuation">.</span>F</span><span class="token punctuation">.</span>factor<span class="token punctuation">,</span> <span class="token string">&quot;*&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    result <span class="token operator">=</span> storyEngine<span class="token punctuation">.</span><span class="token function">fire</span><span class="token punctuation">(</span>fireRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertTrue</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">isSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> result<span class="token punctuation">.</span><span class="token function">getResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">66</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><p>    🟢 之前有提到过<strong>只有并行网关、包含网关、结束事件可以接收归并多个入度</strong>，显然排他网关并不在此列，也就是说排他网关只能接收一个入度，不允许多个箭头指向同一个排他网关</p> <p>    🟢 排他网关入度只能有一个，出度可以多个。出度上面的条件表达式会被解析执行，如果没有条件表达式时会默认是true</p> <p>    🟢 排他网关有多个出度表达式被解析成true时，会选择第一个为true的分支继续向下执行，其他的将会被忽略。图示中出度的前后并不代表程序解析时出度上表达式判断执行的先后顺序，需要指定顺序时可以使用<code>o{数字}: 表达式</code></p> <p>    🟢 当全部出度上的表达式都解析为false时会抛出异常并结束流程，异常信息`：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>[K1040008] Match to the next process node as empty! current node identity: EXCLUSIVE_GATEWAY:[id: eeec292f8c5e47919238eb9acd031ce5-3, name: null], desired list of possible nodes for later execution: SERVICE_TASK:[id: 1a5bda10f58a41f1a0c80bbcdcfc9b59-5, name: null, component: calculateService, service: plusCalculate], SERVICE_TASK:[id: bb2806a1ec3f4464a3333cde5c7feabf-8, name: null, component: calculateService, service: multiplyCalculate], SERVICE_TASK:[id: c108dc8d31bf4a71bebf97fedf66432e-11, name: null, component: calculateService, service: minusCalculate]
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>    🟢 由于排他网关最终执行的只有一条链路，所以排他网关是不支持开启异步的，因为没啥意义</p> <h2 id="_2-4-包含网关"><a href="#_2-4-包含网关" class="header-anchor">#</a> 2.4 包含网关</h2> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>包含网关是并行网关和排他网关的结合。包含网关可以像排他网关一样执行后面出度上的表达式，还不像排他网关一样有最多执行一个分支的限制。包含网关可以像并行网关一样聚合分支、开启后续分支的并发，还不会像并行网关一样要求全部入度都必须被执行</p></div> <p><strong>BPMN图示如下：</strong></p> <p><a data-fancybox="" title="包含网关演示" href="../img2/ea543c4264453eeed6c96169c83655ec.png"><img src="/assets/img/ea543c4264453eeed6c96169c83655ec.e674e8af.png" alt="ea543c4264453eeed6c96169c83655ec"></a></p> <blockquote><p><strong>代码方式定义上述流程：</strong></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">ProcessLink</span> <span class="token function">testInclusiveGatewayDemoProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">StartProcessLink</span> processLink <span class="token operator">=</span> <span class="token class-name">StartProcessLink</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token class-name">ProcessConfig</span><span class="token operator">::</span><span class="token function">testInclusiveGatewayDemoProcess</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">InclusiveJoinPoint</span> inclusiveJoinPoint <span class="token operator">=</span> processLink<span class="token punctuation">.</span><span class="token function">nextInclusive</span><span class="token punctuation">(</span>processLink<span class="token punctuation">.</span><span class="token function">inclusive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">openAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    processLink<span class="token punctuation">.</span><span class="token function">inclusive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">joinLinks</span><span class="token punctuation">(</span>
            inclusiveJoinPoint<span class="token punctuation">.</span><span class="token function">nextService</span><span class="token punctuation">(</span><span class="token class-name">Ex</span><span class="token punctuation">.</span><span class="token function">b</span><span class="token punctuation">(</span>e <span class="token operator">-&gt;</span> e<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;var.factor&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;'+'&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">CalculateService</span><span class="token operator">::</span><span class="token function">plusCalculate</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            inclusiveJoinPoint<span class="token punctuation">.</span><span class="token function">nextService</span><span class="token punctuation">(</span><span class="token class-name">Ex</span><span class="token punctuation">.</span><span class="token function">b</span><span class="token punctuation">(</span>e <span class="token operator">-&gt;</span> e<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;var.factor&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;'*'&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">CalculateService</span><span class="token operator">::</span><span class="token function">multiplyCalculate</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            inclusiveJoinPoint<span class="token punctuation">.</span><span class="token function">nextService</span><span class="token punctuation">(</span><span class="token class-name">Ex</span><span class="token punctuation">.</span><span class="token function">b</span><span class="token punctuation">(</span>e <span class="token operator">-&gt;</span> e<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;var.factor&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;'-'&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">CalculateService</span><span class="token operator">::</span><span class="token function">minusCalculate</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> processLink<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div></blockquote> <p><strong>测试执行：</strong></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testInclusiveGatewayDemo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// var 域初始化数据</span>
    <span class="token class-name">InScopeData</span> varScopeData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InScopeData</span><span class="token punctuation">(</span><span class="token class-name">ScopeTypeEnum</span><span class="token punctuation">.</span>VARIABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    varScopeData<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">CommonFields<span class="token punctuation">.</span>F</span><span class="token punctuation">.</span>a<span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    varScopeData<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">CommonFields<span class="token punctuation">.</span>F</span><span class="token punctuation">.</span>b<span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 构造request</span>
    <span class="token class-name">StoryRequest</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> fireRequest <span class="token operator">=</span> <span class="token class-name">ReqBuilder</span><span class="token punctuation">.</span><span class="token function">returnType</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">trackingType</span><span class="token punctuation">(</span><span class="token class-name">TrackingTypeEnum</span><span class="token punctuation">.</span>SERVICE_DETAIL<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">varScopeData</span><span class="token punctuation">(</span>varScopeData<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">startId</span><span class="token punctuation">(</span><span class="token string">&quot;start-event-inclusive-gateway-demo&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 执行 -</span>
    varScopeData<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">CommonFields<span class="token punctuation">.</span>F</span><span class="token punctuation">.</span>factor<span class="token punctuation">,</span> <span class="token string">&quot;-&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">TaskResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> storyEngine<span class="token punctuation">.</span><span class="token function">fire</span><span class="token punctuation">(</span>fireRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertTrue</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">isSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> result<span class="token punctuation">.</span><span class="token function">getResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 执行 +</span>
    varScopeData<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">CommonFields<span class="token punctuation">.</span>F</span><span class="token punctuation">.</span>factor<span class="token punctuation">,</span> <span class="token string">&quot;+&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    result <span class="token operator">=</span> storyEngine<span class="token punctuation">.</span><span class="token function">fire</span><span class="token punctuation">(</span>fireRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertTrue</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">isSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> result<span class="token punctuation">.</span><span class="token function">getResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">17</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 执行 *</span>
    varScopeData<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">CommonFields<span class="token punctuation">.</span>F</span><span class="token punctuation">.</span>factor<span class="token punctuation">,</span> <span class="token string">&quot;*&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    result <span class="token operator">=</span> storyEngine<span class="token punctuation">.</span><span class="token function">fire</span><span class="token punctuation">(</span>fireRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertTrue</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">isSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> result<span class="token punctuation">.</span><span class="token function">getResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">66</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p>    🟢 包含网关与并行网关一样，支持开启异步流程，支持接收多个入度</p> <p>    🟢 包含网关没有所有入度必须被执行的限制，等待全部入度执行完成或者得知其中可能有部分入度不满足条件不再执行后，会继续向下执行</p> <p>    🟢 包含网关后面出度可以设置条件表达式，表达式解析规则与排他网关出度解析规则相同，但没有最多执行一个分支的限制，只要出度上的表达式解析为true都会被执行</p> <p>    🟢 如果需要指定包含网关前面入度任务完成几个便可继续向下执行时，可以使用<code>completed-count</code>属性</p> <p>        🔷 <code>completed-count</code>设置时要求必须小于等于包含网关入度数量，否则启动时报错：<code>[K1030005] completed-count cannot be greater than comingList size!</code></p> <p>        🔷 假设一个包含网关入度是3，<code>completed-count</code>指定2，执行时当网关前面有两个入度完成时便可以继续向下执行。如果最终只有1个入度能完成则会抛出<code>[K1040008] The actual completed flow does not meet the requirements of completedCount!</code>异常结束流程</p> <p>        🔷 未指定<code>completed-count</code>属性时，默认是等待全部入度反馈到达或不能到达信号才会继续流程，如果最终没有一个入度到达网关流程也会被异常终止</p> <p>    🟢 包含网关支持定义<code>midway-start-id</code>属性来指定中途开始节点ID，结合request中传入的<code>midwayStartId</code>属性值<strong>可以使流程从中间节点开始执行</strong></p> <p><a data-fancybox="" title="指定midway-start-id属性" href="../img2/d69c55115d24c536a59abdbb89465715.png"><img src="/assets/img/d69c55115d24c536a59abdbb89465715.57592784.png" alt="d69c55115d24c536a59abdbb89465715"></a></p> <p>调用时时指定<code>midwayStartId</code>属性，让上述流程从包含网关开始执行</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testInclusiveMidwayStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// var 域初始化数据</span>
    <span class="token class-name">InScopeData</span> varScopeData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InScopeData</span><span class="token punctuation">(</span><span class="token class-name">ScopeTypeEnum</span><span class="token punctuation">.</span>VARIABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    varScopeData<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">CommonFields<span class="token punctuation">.</span>F</span><span class="token punctuation">.</span>a<span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    varScopeData<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">CommonFields<span class="token punctuation">.</span>F</span><span class="token punctuation">.</span>b<span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 构造request</span>
    <span class="token class-name">StoryRequest</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> fireRequest <span class="token operator">=</span> <span class="token class-name">ReqBuilder</span><span class="token punctuation">.</span><span class="token function">returnType</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">midwayStartId</span><span class="token punctuation">(</span><span class="token string">&quot;9a350816bf823d30e5ca2865dd3a147f&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">trackingType</span><span class="token punctuation">(</span><span class="token class-name">TrackingTypeEnum</span><span class="token punctuation">.</span>ALL<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">varScopeData</span><span class="token punctuation">(</span>varScopeData<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">startId</span><span class="token punctuation">(</span><span class="token string">&quot;start-event-inclusive-gateway-demo&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 执行 -</span>
    varScopeData<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">CommonFields<span class="token punctuation">.</span>F</span><span class="token punctuation">.</span>factor<span class="token punctuation">,</span> <span class="token string">&quot;-&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">TaskResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> storyEngine<span class="token punctuation">.</span><span class="token function">fire</span><span class="token punctuation">(</span>fireRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertTrue</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">isSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> result<span class="token punctuation">.</span><span class="token function">getResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>        🔷 子流程中的包含网关不能定义<code>midway-start-id</code>属性，即只有主流程中才能从中间节点开始执行</p> <p>        🔷 如果request中指定了<code>midwayStartId</code>但在实际执行时却没有找到对应节点会报错，未指定<code>midwayStartId</code>时默认从startEvent开始执行</p> <p>        🔷 <strong>一定需要注意！！！指定<code>midwayStartId</code>属性从流程中间开始执行的包含网关后面出现的所有包含网关、并行网关、排他网关前面的入度要保证经过此包含网关都是可达的，不然会出现因为等待永不可达流程导致调用超时的问题！！！</strong></p> <p>        🔷 下图所示的流程中出现的包含网关就不能配置<code>midway-start-id</code>。因为从包含网关开始后，结束节点下方的入度是永不可达的，会出现等待超时异常</p> <p><a data-fancybox="" title="错误流程" href="../img2/f601e5f121daf90c1cc0105be69b5785.png"><img src="/assets/img/f601e5f121daf90c1cc0105be69b5785.f316228b.png" alt="f601e5f121daf90c1cc0105be69b5785"></a></p> <h2 id="_2-5-子流程"><a href="#_2-5-子流程" class="header-anchor">#</a> 2.5 子流程</h2> <h3 id="_2-5-1-子流程使用"><a href="#_2-5-1-子流程使用" class="header-anchor">#</a> 2.5.1 子流程使用</h3> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>框架支持定义子流程。可以用来进行复杂流程的拆分、通用流程的复用、流程事务管理等。子流程可以做到逻辑的抽离，以便之后进行单独维护升级。这样也使原来比较复杂的流程图得到了简化，理解起来会更加方便</p></div> <p><strong>BPMN图示如下：</strong></p> <p><a data-fancybox="" title="子流程演示" href="../img2/a5c4cb55480a1209ebe56b9e5de76458.png"><img src="/assets/img/a5c4cb55480a1209ebe56b9e5de76458.c033ba88.png" alt="a5c4cb55480a1209ebe56b9e5de76458"></a></p> <p><strong>注意！图中<code>SUB_PROCESS_ID_001</code>关联ID，是子流程的ID，不是子流程中开始事件的ID</strong></p> <blockquote><p><strong>代码方式定义上述流程：</strong></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * 定义子流程
 */</span>
<span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">SubProcessLink</span> <span class="token function">calculateSubProcessDemo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token class-name">SubProcessLink</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token class-name">ProcessConfig</span><span class="token operator">::</span><span class="token function">calculateSubProcessDemo</span><span class="token punctuation">,</span> link <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token class-name">InclusiveJoinPoint</span> inclusiveJoinPoint <span class="token operator">=</span> link<span class="token punctuation">.</span><span class="token function">nextInclusive</span><span class="token punctuation">(</span>link<span class="token punctuation">.</span><span class="token function">inclusive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">openAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        link<span class="token punctuation">.</span><span class="token function">inclusive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">joinLinks</span><span class="token punctuation">(</span>
                inclusiveJoinPoint<span class="token punctuation">.</span><span class="token function">nextService</span><span class="token punctuation">(</span><span class="token class-name">Ex</span><span class="token punctuation">.</span><span class="token function">b</span><span class="token punctuation">(</span>e <span class="token operator">-&gt;</span> e<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;var.factor&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;'+'&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">CalculateService</span><span class="token operator">::</span><span class="token function">plusCalculate</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                inclusiveJoinPoint<span class="token punctuation">.</span><span class="token function">nextService</span><span class="token punctuation">(</span><span class="token class-name">Ex</span><span class="token punctuation">.</span><span class="token function">b</span><span class="token punctuation">(</span>e <span class="token operator">-&gt;</span> e<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;var.factor&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;'*'&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">CalculateService</span><span class="token operator">::</span><span class="token function">multiplyCalculate</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                inclusiveJoinPoint<span class="token punctuation">.</span><span class="token function">nextService</span><span class="token punctuation">(</span><span class="token class-name">Ex</span><span class="token punctuation">.</span><span class="token function">b</span><span class="token punctuation">(</span>e <span class="token operator">-&gt;</span> e<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;var.factor&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;'-'&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">CalculateService</span><span class="token operator">::</span><span class="token function">minusCalculate</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">ProcessLink</span> <span class="token function">testCalculateSubProcessDemo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">StartProcessLink</span> processLink <span class="token operator">=</span> <span class="token class-name">StartProcessLink</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token class-name">ProcessConfig</span><span class="token operator">::</span><span class="token function">testCalculateSubProcessDemo</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    processLink
            <span class="token punctuation">.</span><span class="token function">nextService</span><span class="token punctuation">(</span><span class="token class-name">CalculateService</span><span class="token operator">::</span><span class="token function">setCalculateNumber</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">params</span><span class="token punctuation">(</span><span class="token string">&quot;{'a': 11, 'b': 6}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">nextSubProcess</span><span class="token punctuation">(</span><span class="token class-name">ProcessConfig</span><span class="token operator">::</span><span class="token function">calculateSubProcessDemo</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 引用子流程</span>
            <span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> processLink<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div></blockquote> <p><strong>测试执行：</strong></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testSubProcessDemo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 执行 *</span>
    <span class="token class-name">InScopeData</span> varScopeData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InScopeData</span><span class="token punctuation">(</span><span class="token class-name">ScopeTypeEnum</span><span class="token punctuation">.</span>VARIABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    varScopeData<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">CommonFields<span class="token punctuation">.</span>F</span><span class="token punctuation">.</span>factor<span class="token punctuation">,</span> <span class="token string">&quot;*&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 构造request</span>
    <span class="token class-name">StoryRequest</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> fireRequest <span class="token operator">=</span> <span class="token class-name">ReqBuilder</span><span class="token punctuation">.</span><span class="token function">returnType</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">trackingType</span><span class="token punctuation">(</span><span class="token class-name">TrackingTypeEnum</span><span class="token punctuation">.</span>SERVICE_DETAIL<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">varScopeData</span><span class="token punctuation">(</span>varScopeData<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">startId</span><span class="token punctuation">(</span><span class="token string">&quot;start-test-event-sub-process-demo&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">TaskResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> storyEngine<span class="token punctuation">.</span><span class="token function">fire</span><span class="token punctuation">(</span>fireRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertTrue</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">isSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> result<span class="token punctuation">.</span><span class="token function">getResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">66</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 代码方式定义流程</span>
    varScopeData<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">CommonFields<span class="token punctuation">.</span>F</span><span class="token punctuation">.</span>factor<span class="token punctuation">,</span> <span class="token string">&quot;+&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    fireRequest <span class="token operator">=</span> <span class="token class-name">ReqBuilder</span><span class="token punctuation">.</span><span class="token function">returnType</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">trackingType</span><span class="token punctuation">(</span><span class="token class-name">TrackingTypeEnum</span><span class="token punctuation">.</span>SERVICE_DETAIL<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">varScopeData</span><span class="token punctuation">(</span>varScopeData<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">startProcess</span><span class="token punctuation">(</span><span class="token class-name">ProcessConfig</span><span class="token operator">::</span><span class="token function">testCalculateSubProcessDemo</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    result <span class="token operator">=</span> storyEngine<span class="token punctuation">.</span><span class="token function">fire</span><span class="token punctuation">(</span>fireRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertTrue</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">isSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> result<span class="token punctuation">.</span><span class="token function">getResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">17</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>    🟢 子流程有独立于父流程之外的开始事件、结束事件</p> <p>    🟢 子流程是支持嵌套的，A子流程可以依赖B子流程，但是自身依赖自身是非法的</p> <p>    🟢 子流程中的包含网关、并行网关也支持开启异步模式</p> <p>    🟢 BPMN文件中定义<code>bpmn:callActivity</code>引用子流程，代码定义中使用<code>.nextSubProcess(Xxx).build()</code>引用子流程。程序运行到此时会跳转至子流程执行，子流程执行完成后才会跳转回主流程继续执行</p> <h3 id="_2-5-2-子流程拦截器"><a href="#_2-5-2-子流程拦截器" class="header-anchor">#</a> 2.5.2 子流程拦截器</h3> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>业务动作复用、复杂业务动作抽离并单独维护、第三方提供的一些服务能力等，都需要定义子流程来进行业务间隔离。被划分出来的子流程可以被看作一个整体被单独维护。框架提供了定义子流程拦截器的能力，可以在子流程执行前、执行后、出现异常（链路中出现异常或者超时）时自定义操作。除此之外，还可以定义无论是否出现异常都一定会执行的最终通知</p></div> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StatisticsInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">SubProcessInterceptor</span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * 子流程拦截器的切入点
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">pointcut</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Sets</span><span class="token punctuation">.</span><span class="token function">newHashSet</span><span class="token punctuation">(</span><span class="token string">&quot;Event_1h3q9xl&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Event_08xh60r&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 这里指定的是子流程中的开始事件ID</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">beforeProcessor</span><span class="token punctuation">(</span><span class="token class-name">ScopeDataOperator</span> dataOperator<span class="token punctuation">,</span> <span class="token class-name">Role</span> role<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 开始统计</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;开始统计...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterProcessor</span><span class="token punctuation">(</span><span class="token class-name">ScopeDataOperator</span> dataOperator<span class="token punctuation">,</span> <span class="token class-name">Role</span> role<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 统计结束</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;统计结束...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">errorProcessor</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> exception<span class="token punctuation">,</span> <span class="token class-name">ScopeDataOperator</span> dataOperator<span class="token punctuation">,</span> <span class="token class-name">Role</span> role<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 统计异常</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;统计异常...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">finallyProcessor</span><span class="token punctuation">(</span><span class="token class-name">ScopeDataOperator</span> dataOperator<span class="token punctuation">,</span> <span class="token class-name">Role</span> role<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 兜底逻辑</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;兜底逻辑...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><p>    🟢 定义实现<code>SubProcessInterceptor</code>接口的子流程拦截器，并交给Spring容器管理，拦截器即可生效</p> <p>    🟢 <code>pointcut()</code> 方法需要被实现，返回子流程中开始事件ID的Set集合，以此告知框架哪些子流程需要被拦截器处理</p> <p>    🟢 不同流程共同引用一个子流程时，拦截器如果要区分不同的主流程 <code>pointcut()</code> 方法就无法支持了。此时需要实现<code>getSubProcessIdentity()</code>方法，它返回一个<code>SubProcessIdentity</code>对象的Set集合。框架用<code>SubProcessIdentity</code>对象集合来判断当前拦截器是否生效。<code>SubProcessIdentity</code>有两种构造参数：</p> <p>        🔷 传入子流程的<code>startEventId</code>，运行过程中拦截器定义的<code>startEventId</code>与子流程的<code>startEventId</code>相同时当前拦截器生效</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">SubProcessIdentity</span><span class="token punctuation">(</span><span class="token class-name">String</span> startEventId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">(</span>startEventId<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>        🔷 传入子流程的<code>startEventId</code>和<code>storyId</code>（最外层流程中的<code>startEventId</code>），运行过程中<code>startEventId</code>和<code>storyId</code>都匹配成功时当前拦截器生效</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">SubProcessIdentity</span><span class="token punctuation">(</span><span class="token class-name">String</span> startEventId<span class="token punctuation">,</span> <span class="token class-name">String</span> storyId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token class-name">TaskServiceUtil</span><span class="token punctuation">.</span><span class="token function">joinName</span><span class="token punctuation">(</span>startEventId<span class="token punctuation">,</span> storyId<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">IdentityTypeEnum</span><span class="token punctuation">.</span>SUB_PROCESS<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>    🟢 <code>beforeProcessor</code>是子流程的前置通知方法，拦截器匹配成功后，进入子流程之前被执行。用来实现一些子流程执行之前的业务动作。它返回一个boolean变量。true代表进入子流程，fasle代表跳过子流程继续执行下一节点</p> <p>    🟢 <code>afterProcessor</code>是子流程的后置通知，拦截器匹配成功，子流程执行完成之后会执行其中定义的业务动作</p> <p>    🟢 <code>errorProcessor</code>是子流程的异常通知，拦截器匹配成功后，子流程执行中出现异常或超时时会执行其中定义的业务动作</p> <p>    🟢 <code>finallyProcessor</code>是子流程的最终通知，拦截器匹配成功后，无论子流程是否执行成功，只要进入了子流程最终一定会执行其中定义的业务动作</p> <p>    🟢 <code>getOrder()</code>可以控制多个拦截器生效的前后顺序。与Spring中的Order相同，返回的变量值越小优先级越高。没有复写该方法时默认返回1000</p> <h3 id="_2-5-3-子流程控制"><a href="#_2-5-3-子流程控制" class="header-anchor">#</a> 2.5.3 子流程控制</h3> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>并非所有子流程都是业务的核心逻辑，也并非所有子流程执行时间都与父流程相同。所以框架提供了给子流程设置严格模式和超时时间的入口</p></div> <p><a data-fancybox="" title="子流程参数设置" href="../img2/82fd682de5086dc5a85165bad37d51b4.png"><img src="/assets/img/82fd682de5086dc5a85165bad37d51b4.84a72d9a.png" alt="82fd682de5086dc5a85165bad37d51b4"></a></p> <p>    🟢 <code>timeout</code>以ms为单位。当<code>timeout</code>存在且大于等于0时，即可控制允许子流程执行的最大超时时间。达到最大超时时间之后，如果子流程还未结束就会抛出超时异常</p> <p>    🟢 <code>strict-mode</code>未被显示设置时默认为true，子流程出现异常或执行超时时会结束整个流程。<code>strict-mode</code>被设置成false后，如果子流程出现异常或执行超时，异常将会被忽略，当前子流程和所属当前子流程的子流程将会被中断。之后继续执行子流程后面的服务节点</p> <h2 id="_2-6-节点控制"><a href="#_2-6-节点控制" class="header-anchor">#</a> 2.6 节点控制</h2> <h3 id="_2-6-1-允许服务为空"><a href="#_2-6-1-允许服务为空" class="header-anchor">#</a> 2.6.1 允许服务为空</h3> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>默认情况下在配置文件中定义一个节点时，程序中必须要有一个服务节点方法与之相对应，否则容器在启动的时候就会报错。这个限制可以通过服务节点配置来绕过</p></div> <p>在程序中缺失与服务节点相对应的方法时，会出现两种情况的报错：</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token comment">// 报错一</span>
<span class="token punctuation">[</span>K1040004<span class="token punctuation">]</span> No available TaskService matched! service task identity<span class="token operator">:</span> SERVICE_TASK<span class="token operator">:</span><span class="token punctuation">[</span>id<span class="token operator">:</span> Activity_0ph90s5<span class="token punctuation">,</span> name<span class="token operator">:</span> 减法计算<span class="token punctuation">,</span> component<span class="token operator">:</span> calculateService<span class="token punctuation">,</span> service<span class="token operator">:</span> minusCalculate2<span class="token punctuation">]</span>

<span class="token comment">// 报错二</span>
<span class="token punctuation">[</span>K1030002<span class="token punctuation">]</span> TaskComponent cannot be empty! identity<span class="token operator">:</span> SERVICE_TASK<span class="token operator">:</span><span class="token punctuation">[</span>id<span class="token operator">:</span> Activity_0ph90s5<span class="token punctuation">,</span> name<span class="token operator">:</span> 减法计算<span class="token punctuation">,</span> component<span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span> service<span class="token operator">:</span> minusCalculate2<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>    🟢 服务节点在同时定义了<code>task-component</code>和<code>task-service</code>两个属性时，如果在程序中没有与之相对应的服务节点方法，启动时会出现报错一</p> <p>    🟢 如果服务节点只定义了<code>task-service</code>一个属性的话，如果没有与之相对应的服务节点方法，启动时会出现报错二</p> <p>    可通过节点设置：<code>allow-absent=true</code>，来解决上面的问题。该属性表示：允许服务节点在程序中找不到与之对应的服务节点方法。找不到时不会报错，会跳过继续执行</p> <p><a data-fancybox="" title="服务节点方法允许为空" href="../img2/880956347ce40f4e7072307b1b54068b.png"><img src="/assets/img/880956347ce40f4e7072307b1b54068b.5830096f.png" alt="880956347ce40f4e7072307b1b54068b"></a></p> <h3 id="_2-6-2-设置超时时间"><a href="#_2-6-2-设置超时时间" class="header-anchor">#</a> 2.6.2 设置超时时间</h3> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>框架允许通过设置服务节点的超时时间参数，来规定当前服务节点方法被允许执行的最大时长</p></div> <p><a data-fancybox="" title="设置超时时间" href="../img2/2e32af28c0ea97b98d0147154cc6d034.png"><img src="/assets/img/2e32af28c0ea97b98d0147154cc6d034.d475fc7b.png" alt="2e32af28c0ea97b98d0147154cc6d034"></a></p> <p>    🟢 超时时间的单位是ms，默认值-1代表不设置超时时间</p> <p>    🟢 除配置文件外还可以通过编码的方式定义节点方法的超时时间<code>@TaskService(invoke = @Invoke(timeout = 1000))</code></p> <p>    🟢 配置文件、代码中同时指定超时时间属性时，已配置文件中的时间为准，代码定义的值将会被忽略</p> <h3 id="_2-6-3-节点异常重试"><a href="#_2-6-3-节点异常重试" class="header-anchor">#</a> 2.6.3 节点异常重试</h3> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>服务节点方法执行异常或者超时后，可以通过指定异常重试次数来重新执行目标方法</p></div> <p><a data-fancybox="" title="节点异常重试" href="../img2/472b5c036e2397c14eb32686203ebbf9.png"><img src="/assets/img/472b5c036e2397c14eb32686203ebbf9.d0b1b79b.png" alt="472b5c036e2397c14eb32686203ebbf9"></a></p> <p>    🟢 服务节点执行失败时默认重试次数为0代表不重试。假设当重试次数被设置成2时，代表如果执行失败，将进行2次重试。最大执行次数是3次</p> <p>    🟢 除配置文件外还可以通过编码的方式定义节点方法的异常重试<code>@TaskService(invoke = @Invoke(retry = 2))</code></p> <p>    🟢 流程配置中也可指定服务节点失败重试次数属性，流程配置指定后，注解方式将会失效</p> <p>    🟢 超时时间、重试次数两个属性一起使用时需要注意一下两者叠加起来的时间是否在允许的范围内</p> <p>    🟢 <code>@Invoke</code>注解中除了<code>retry</code>这个属性外，还有两个属性是和重试次数联用的</p> <p>        🔷  <code>retryIncludeExp</code>：抛出异常包含指定异常时，进行重试。默认情况下列表为空，任何异常都将重试</p> <p>        🔷  <code>retryExcludeExp</code>：抛出异常不包含指定异常时，进行重试。默认情况下列表为空，任何异常都将重试</p> <h3 id="_2-6-4-节点异常降级"><a href="#_2-6-4-节点异常降级" class="header-anchor">#</a> 2.6.4 节点异常降级</h3> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>服务节点执行失败或超时后，并且未设置重试次数或者重试也失败时。如果设置了降级方法，此时降级方法将会被执行</p></div> <p><strong>定义服务节点方法和降级方法</strong></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@NoticeResult</span>
<span class="token annotation punctuation">@TaskService</span><span class="token punctuation">(</span>invoke <span class="token operator">=</span> <span class="token annotation punctuation">@Invoke</span><span class="token punctuation">(</span>retry <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span> demotion <span class="token operator">=</span> <span class="token string">&quot;pr:calculateService@calculateErrorDemotion&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">calculateError</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token number">1</span> <span class="token operator">/</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 定义降级方法
 */</span>
<span class="token annotation punctuation">@TaskService</span>
<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">calculateErrorDemotion</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token number">10</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p><strong>定义流程</strong></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">ProcessLink</span> <span class="token function">testCalculateErrorDemotionProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">StartProcessLink</span> processLink <span class="token operator">=</span> <span class="token class-name">StartProcessLink</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token class-name">ProcessConfig</span><span class="token operator">::</span><span class="token function">testCalculateErrorDemotionProcess</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    processLink<span class="token punctuation">.</span><span class="token function">nextService</span><span class="token punctuation">(</span><span class="token class-name">CalculateService</span><span class="token operator">::</span><span class="token function">calculateError</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> processLink<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><strong>测试执行</strong></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testCalculateErrorDemotion</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 构造request</span>
    <span class="token class-name">StoryRequest</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> fireRequest <span class="token operator">=</span> <span class="token class-name">ReqBuilder</span><span class="token punctuation">.</span><span class="token function">returnType</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">trackingType</span><span class="token punctuation">(</span><span class="token class-name">TrackingTypeEnum</span><span class="token punctuation">.</span>SERVICE_DETAIL<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">startProcess</span><span class="token punctuation">(</span><span class="token class-name">ProcessConfig</span><span class="token operator">::</span><span class="token function">testCalculateErrorDemotionProcess</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">TaskResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> storyEngine<span class="token punctuation">.</span><span class="token function">fire</span><span class="token punctuation">(</span>fireRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertTrue</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">isSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> result<span class="token punctuation">.</span><span class="token function">getResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>     实例中通过<code>demotion = &quot;pr:calculateService@calculateErrorDemotion&quot;</code>指定服务节点执行失败或超时后的降级方法。异常发生后会根据表达式从容器中找到对应的服务节点执行。如果demotion配置格式有问题，或者降级使用的服务节点方法未找到时降级策略将不会生效</p> <p>     降级方法表达式格式是：<code>pr:{task-component}@{task-service}</code>或者<code>pr:{task-component}@{task-service}@{ability}</code>。ability是<code>@TaskService</code>注解的属性，用来表示服务节点的子能力，后面RBAC模式时会详细介绍</p> <p><strong>     降级表达式举例：</strong></p> <p>    🟢 <code>pr:risk-control@check-img</code> 服务组件名是 <code>risk-control</code> 且节点方法名是 <code>check-img</code></p> <p>    🟢 <code>pr:risk-control@check-img@triple</code> 服务组件名是 <code>risk-control</code> 且节点方法名是 <code>check-img</code> 且能力点名是 <code>triple</code></p> <h3 id="_2-6-5-忽略执行时异常"><a href="#_2-6-5-忽略执行时异常" class="header-anchor">#</a> 2.6.5 忽略执行时异常</h3> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>默认情况下，服务节点方法在执行失败或者超时时程序会抛出异常结束整个流程。框架提供了配置属性可以屏蔽当前服务节点方法的运行时异常继续执行下一个节点</p></div> <p>    可通过给节点增加：<code>strict-mode=false</code>属性，来关闭服务节点的严格模式（并行网关也有一个严格模式，要分清两者作用的不同），跳过异常，让流程得以继续向下执行</p> <p><a data-fancybox="" title="屏蔽运行时异常" href="../img2/a3a350db7669c75358b94c39d4198849.png"><img src="/assets/img/a3a350db7669c75358b94c39d4198849.4b55bd1c.png" alt="a3a350db7669c75358b94c39d4198849"></a></p> <p>    🟢 除配置文件外还可以通过编码的方式定义节点方法的非严格模式<code>@TaskService(invoke = @Invoke(strictMode = false))</code></p> <p>    🟢 配置文件、代码两者同时为严格模式时才会是严格模式，有任一个是非严格模式时，任务就是非严格模式。默认情况下两种都是严格模式</p> <h3 id="_2-6-6-各机制生效顺序"><a href="#_2-6-6-各机制生效顺序" class="header-anchor">#</a> 2.6.6 各机制生效顺序</h3> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>以上介绍了多种节点控制的手段，要想合理使用的话，就需要了解各个机制的生效顺序及前后关联</p></div> <p>    1️⃣ 如果配置了大于-1的超时时间，目标方法调用会存在超时时间的限制，给定时间内未成功返回会抛出超时异常</p> <p>    2️⃣ 服务节点方法在出现超时异常或执行异常时，会判断是否设置了重试次数，如果重试次数大于0，会进行相应次数的重试操作</p> <p>    3️⃣ 未指定重试次数或指定次数的重试都失败后，如果指定了降级方法，则会在此时调用降级方法</p> <p>    4️⃣ 以上调用全部都失败后，会判断当前服务节点是否为严格模式，如果是非严格模式，异常将会被忽略，流程会继续向下执行</p> <h2 id="_2-7-流程遍历"><a href="#_2-7-流程遍历" class="header-anchor">#</a> 2.7 流程遍历</h2> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>在日常研发工作中，不难遇到一些需要对数据集合进行遍历处理的工作。比如集合中的每项数据依次使用给定的计算规则进行遍历计算。再比如电商场景中订单列表、商品列表、SKU列表等，在返回给前端界面渲染展示前都需要对列表的每一项进行相关资源的加载计算和赋值。在以上场景中，都有一个相同的特点，就是虽然计算规则复杂且场景多样，但是作用到集合中每项数据的规则都是一致且统一的</p> <p>Kstry提供能力：对选定集合中的每一项数据在服务节点、子流程两个维度进行指定规则的加工计算</p></div> <h3 id="_2-7-1-遍历属性配置"><a href="#_2-7-1-遍历属性配置" class="header-anchor">#</a> 2.7.1 遍历属性配置</h3> <p><a data-fancybox="" title="迭代属性配置" href="../img2/07274707655320bb71a6dbbe6821035a.png"><img src="/assets/img/07274707655320bb71a6dbbe6821035a.482fbd57.png" alt="07274707655320bb71a6dbbe6821035a"></a></p> <p><strong><code>ite-source</code>：</strong> 指定数据集合资源的位置，格式为正常的取值表达式，如：<code>req.numList</code>。甚至还可以对集合中对象的某个字段做遍历，比如：<code>$.studyExperienceList[*].classId</code>，此时需要注意最前面的<code>$</code>一定要有，其取值逻辑可以参考fastjson的<code>JSONPath</code>使用</p> <p>    🟢 只有指定正确格式的<code>ite-source</code>属性，才会开启遍历动作</p> <p>    🟢 <code>ite-source</code>指定的资源一定是实现<code>java.lang.Iterable</code>接口或者数组格式，否则不会开启遍历动作</p> <p>    🟢 如果指定的集合资源未找到，则对应的服务节点或者子任务将直接跳过不再执行</p> <p><strong><code>ite-strategy</code>：</strong> 指定遍历策略，有三个取值</p> <p>    🟢 <code>all</code>：不指定时的默认策略，集合中全部元素在遍历中都需要获取到正确的结果，只要有一个不满足会抛出异常，是否结束流程受<code>strict-mode</code>影响。</p> <p>    🟢 <code>best</code>：集合中全部元素进行遍历，尽量多的拿到正确结果，如果有数据项执行期间抛出异常，流程会忽略异常不会结束</p> <p>    🟢 <code>any</code>：集合中只要有一项数据执行成功，就会结束遍历过程</p> <p><strong><code>ite-async</code>：</strong> 遍历动作是否并发进行</p> <p><strong><code>ite-stride</code>：</strong> 遍历步长。用来指定每次遍历时从集合或者数组中拿取多少个元素。默认为1代表逐个遍历。最后一次遍历集合中数据项数量小于步长时会全部返回</p> <p><strong><code>ite-align-index</code>：</strong> 迭代时，是否将返回值、入参两集合中的索引进行一一对应，比如：入参5个元素，经过处理后出参有三个元素有值，另外两个为null。选择出入参对齐，返回结果将是包含有null的5个元素的List，反之将返回包含有三个结果元素的List。默认false意指不进行索引对齐</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>定义服务节点方法时，以上属性均可以在@TaskService注解中指定</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@TaskService</span><span class="token punctuation">(</span>
    iterator <span class="token operator">=</span> <span class="token annotation punctuation">@Iterator</span><span class="token punctuation">(</span>sourceScope <span class="token operator">=</span> <span class="token class-name">ScopeTypeEnum</span><span class="token punctuation">.</span>VARIABLE<span class="token punctuation">,</span> source <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> async <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> strategy <span class="token operator">=</span> <span class="token class-name">IterateStrategyEnum</span><span class="token punctuation">.</span>BEST_SUCCESS<span class="token punctuation">)</span>
<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>代码、配置文件均指定同一值时，以配置文件中的值为准</p></div> <h3 id="_2-7-2-遍历服务节点"><a href="#_2-7-2-遍历服务节点" class="header-anchor">#</a> 2.7.2 遍历服务节点</h3> <blockquote><p>对集合中的一组数据求平方</p></blockquote> <p><strong>定义服务节点方法</strong></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@TaskComponent</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;calculate-service&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CalculateService</span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * 求平方再放回
     */</span>
    <span class="token annotation punctuation">@TaskService</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;batch-square2&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@NoticeScope</span><span class="token punctuation">(</span>target <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;squareResult&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;a&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span> scope <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token class-name">ScopeTypeEnum</span><span class="token punctuation">.</span>RESULT<span class="token punctuation">,</span> <span class="token class-name">ScopeTypeEnum</span><span class="token punctuation">.</span>STABLE<span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> <span class="token function">batchSquare2</span><span class="token punctuation">(</span><span class="token class-name">ScopeDataOperator</span> dataOperator<span class="token punctuation">,</span> <span class="token class-name">IterDataItem</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> data<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token comment">// 迭代项可以从dataOperator中取，如果步长&gt;1时，获取到的将是List类型</span>
        <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> iterDataItem <span class="token operator">=</span> dataOperator<span class="token punctuation">.</span><span class="token function">iterDataItem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span><span class="token function">getSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 也可以将IterDataItem对象放到入参上，迭代项会自动被注入到这个对象中</span>
        <span class="token class-name">AssertUtil</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>iterDataItem<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">CollectionUtils</span><span class="token operator">::</span><span class="token function">size</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">getDataList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">CollectionUtils</span><span class="token operator">::</span><span class="token function">size</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span>  <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> data<span class="token punctuation">.</span><span class="token function">getDataList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>i <span class="token operator">-&gt;</span> i <span class="token operator">*</span> i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>IterDataItem中有以下几个参数：</p> <p>    🟢 <code>data</code>：步长为1时，拿到迭代中的每一个遍历项</p> <p>    🟢 <code>dataList</code>：步长&gt;1时，拿到迭代中的每一个遍历项集合</p> <p>    🟢 <code>batchItem</code>：步长是否为1。步长为1时返回false，步长&gt;1时返回true</p> <p>    🟢 <code>index</code>：遍历中的每一项所在原来集合中的位置索引，从0开始</p> <p>    🟢 <code>size</code>：最终需要迭代的次数</p> <p>如果在遍历节点中设置了超时时间、重试次数、降级方法等，会对每一个遍历项生效，节点的严格模式属性对整个遍历动作生效。</p> <div class="custom-block danger"><p class="custom-block-title">注意：</p> <p>当遍历步长&gt;1时，服务节点方法返回值需要是List类型</p></div> <h3 id="_2-7-3-遍历子流程节点"><a href="#_2-7-3-遍历子流程节点" class="header-anchor">#</a> 2.7.3 遍历子流程节点</h3> <blockquote><p>如果一个集合中的数据都需要进行某些操作时，可以考虑将这些操作定义成子流程，然后指定子流程的遍历属性来依次处理这个集合中数据</p></blockquote> <p><a data-fancybox="" title="遍历子流程" href="../img2/11255a9dca07f908318ff0ff45c342a2.png"><img src="/assets/img/11255a9dca07f908318ff0ff45c342a2.a293d9a7.png" alt="11255a9dca07f908318ff0ff45c342a2"></a></p> <p>    🟢 子流程遍历属性可以设置在子流程上面对全部调用子流程的主流程都生效，也可以设置在调用子流程的<code>CallActivity</code>节点上，仅对当前主流程生效</p> <p>    🟢 框架中子流程遍历属性的实现原理，是在流程解析时将子流程上遍历相关的属性设置到了流程中的每一个服务节点上。所以实际的执行效果并不是流程的一遍遍执行。而是流程中的A节点全部遍历执行完之后，再进行B节点的遍历执行依次类推。</p> <h2 id="_2-8-服务节点拦截器"><a href="#_2-8-服务节点拦截器" class="header-anchor">#</a> 2.8 服务节点拦截器</h2> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>框架提供了服务节点拦截器，用来对流程中需要执行的服务节点进行拦截和控制</p></div> <p><strong>拦截器定义</strong></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ServiceNodeInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">TaskInterceptor</span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * 接口有默认行为，可以不实现该方法
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Ordered</span><span class="token punctuation">.</span>HIGHEST_PRECEDENCE<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 接口有默认行为，可以不实现该方法
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">match</span><span class="token punctuation">(</span><span class="token class-name">IterData</span> iterData<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ScopeDataOperator</span> dataOperator <span class="token operator">=</span> iterData<span class="token punctuation">.</span><span class="token function">getDataOperator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Iter</span> iter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ServiceNodeResource</span> serviceNode <span class="token operator">=</span> iter<span class="token punctuation">.</span><span class="token function">getServiceNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ScopeDataOperator</span> dataOperator <span class="token operator">=</span> iter<span class="token punctuation">.</span><span class="token function">getDataOperator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Role</span> role <span class="token operator">=</span> iter<span class="token punctuation">.</span><span class="token function">getRole</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Object</span> data <span class="token operator">=</span> iter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;ComponentName: {}, ServiceName: {}, AbilityName: {}, data: {}&quot;</span><span class="token punctuation">,</span> serviceNode<span class="token punctuation">.</span><span class="token function">getComponentName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> serviceNode<span class="token punctuation">.</span><span class="token function">getServiceName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> serviceNode<span class="token punctuation">.</span><span class="token function">getAbilityName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> data<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><p>    🟢 创建实现了<code>TaskInterceptor</code>接口的类实例并放入Spring容器中，服务节点拦截器便会生效</p> <p>    🟢 <code>TaskInterceptor</code>接口提供以下三个方法：</p> <p>        🔷 <code>getOrder()</code>：用来指定拦截器列表顺序，接口有默认实现可以不重写，默认返回0</p> <p>        🔷 <code>match(IterData iterData)</code>：用来判断当前拦截器是否生效。默认情况下，服务节点拦截器对全部服务节点生效，该方法可以过滤掉无需生效的拦截器。接口有默认实现可以不重写，默认返回：true</p> <p>        🔷 <code>invoke(Iter iter)</code>：拦截器实际生效的方法。提供<code>Iter</code>入参，可以凭此对象执行下一个拦截器或目标节点，获取<code>Role</code>、<code>ScopeDataOperator</code>、<code>ServiceNodeResource</code></p> <p>    🟢 服务节点拦截器在节点策略动作的最外层。也就是说出现重试、降级、迭代等动作时服务节点会被执行多次，但是拦截器只会执行一次。如果需要在服务节点方法被调用时进行拦截，可以使用Spring AOP，因为类组件本身就是Spring中的实例</p> <h2 id="_2-9-自定义指令"><a href="#_2-9-自定义指令" class="header-anchor">#</a> 2.9 自定义指令</h2> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>一些场景中需要对数据进行操作比如排序、过滤、计算等。这些操作服务节点可以完成，但它一般是以满足业务动作为目标，用来定义完成这种洗数据的工作太过于繁重，然而数据加工又不得不做。框架提供了自定义指令的功能，可以用来定义通用的工具，在流程中直接使用</p></div> <p>    自定义指令是在服务节点的基础上创建的，它实际上就是一个服务节点。只是此时的服务节点提供了一套更通用更便捷的使用方式，被定义用来解决一些与业务无关的通用性问题。这种更通用更便捷的使用方式就是自定义指令。</p> <h3 id="_2-9-1-定义指令"><a href="#_2-9-1-定义指令" class="header-anchor">#</a> 2.9.1 定义指令</h3> <blockquote><p>用来对StoryBus中的集合进行排序</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@TaskComponent</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;InstructService&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">InstructService</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@TaskInstruct</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;sort&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@TaskService</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;instruct-service-sort&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sort</span><span class="token punctuation">(</span><span class="token class-name">InstructContent</span> instructContent<span class="token punctuation">,</span> <span class="token class-name">ScopeDataOperator</span> operator<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SortContent</span> sortContent <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>instructContent<span class="token punctuation">.</span><span class="token function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">SortContent</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> dataOptional <span class="token operator">=</span> operator<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span>sortContent<span class="token punctuation">.</span><span class="token function">getSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dataOptional<span class="token punctuation">.</span><span class="token function">isPresent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token punctuation">(</span>dataOptional<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">instanceof</span> <span class="token class-name">List</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> dataOptional<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>sortContent<span class="token punctuation">.</span>asc<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            list<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token class-name">Comparator</span><span class="token punctuation">.</span><span class="token function">comparing</span><span class="token punctuation">(</span>o <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">Comparable</span><span class="token punctuation">)</span> <span class="token class-name">PropertyUtils</span><span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span>o<span class="token punctuation">,</span> sortContent<span class="token punctuation">.</span><span class="token function">getSortFieldName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            list<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token class-name">Comparator</span><span class="token punctuation">.</span><span class="token function">comparing</span><span class="token punctuation">(</span>o <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">Comparable</span><span class="token punctuation">)</span> <span class="token class-name">PropertyUtils</span><span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span>o<span class="token punctuation">,</span> sortContent<span class="token punctuation">.</span><span class="token function">getSortFieldName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reversed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        operator<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span>sortContent<span class="token punctuation">.</span><span class="token function">getTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> list<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Data</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">SortContent</span> <span class="token punctuation">{</span>

        <span class="token comment">/**
         * 要排序数据的位置
         */</span>
        <span class="token keyword">private</span> <span class="token class-name">String</span> source<span class="token punctuation">;</span>

        <span class="token comment">/**
         * 根据对象的哪个字段来排序
         */</span>
        <span class="token keyword">private</span> <span class="token class-name">String</span> sortFieldName<span class="token punctuation">;</span>

        <span class="token comment">/**
         * 排序后的集合放在什么地方
         */</span>
        <span class="token keyword">private</span> <span class="token class-name">String</span> target<span class="token punctuation">;</span>

        <span class="token comment">/**
         * 是否是升序
         */</span>
        <span class="token keyword">private</span> <span class="token keyword">boolean</span> asc<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br></div></div><p>    🟢 如果不考虑<code>@TaskInstruct(name = &quot;sort&quot;)</code>，仅仅是定义了一个名字为<code>instruct-service-sort</code>的服务节点，加上<code>@TaskInstruct</code>就是自定义指令</p> <p>    🟢 <code>@TaskInstruct</code>有一个<code>name</code>属性，用来定义指令的名称。在BPMN配置文件中使用指令时名称前面需要加<code>c-</code>，比如上面的例子就是<code>c-sort</code></p> <p>    🟢 <code>InstructContent</code>参数用来获取指令名称和内容。无需增加任何注解，直接使用即可</p> <h3 id="_2-9-2-使用指令"><a href="#_2-9-2-使用指令" class="header-anchor">#</a> 2.9.2 使用指令</h3> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>假设对一组商品标签进行排序</p></div> <p><a data-fancybox="" title="自定义指令使用" href="../img2/8330994eebbdbfa8a56a270c320ca0b7.png"><img src="/assets/img/8330994eebbdbfa8a56a270c320ca0b7.3cf0143d.png" alt="8330994eebbdbfa8a56a270c320ca0b7"></a></p> <p>指令名称是<code>c-sort</code>，内容是：</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;source&quot;</span><span class="token operator">:</span> <span class="token string">&quot;sta.shopInfo.labels&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 要排序数据的位置</span>
    <span class="token property">&quot;sortFieldName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;index&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 根据对象的哪个字段来排序</span>
    <span class="token property">&quot;target&quot;</span><span class="token operator">:</span> <span class="token string">&quot;var.labels&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 排序后的集合放在什么地方</span>
    <span class="token property">&quot;asc&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span> <span class="token comment">// 是否是升序</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>    🟢 上面例子中简单定义服务节点的指令名称和值，其他的并未定义</p> <p>    🟢 服务节点支持同时配置指令和服务节点名称，并且同一个服务节点支持同时配置多个不同指令</p> <p>    🟢 <code>c-</code>开头的指令如果和服务节点名称同时存在，默认会先执行名称对应的服务节点再执行指令。如果执行顺序要反过来需要在<code>c-</code>前面加<code>^</code>，例如：<code>^c-sort</code></p> <p>    🟢 包含网关、排他网关也支持同时配置一个或多个指令，定义的指令会在网关之前执行，使用场景是网关前面定义指令对数据进行加工，网关后面再跟条件表达式进行路由决策</p> <div class="custom-block warning"><p class="custom-block-title">注意：</p> <p>代码方式定义流程时是不支持增加<code>^</code>前缀来改变指令和节点方法执行顺序的</p></div> <h2 id="_2-10-脚本指令"><a href="#_2-10-脚本指令" class="header-anchor">#</a> 2.10 脚本指令</h2> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>Kstry服务节点支持JS脚本指令，实现方式就是自定义指令。如果当下的脚本引擎或者逻辑不满足现状的话，可以使用自定义指令进行定制化脚本引擎的开发</p></div> <h3 id="_2-10-1-实现脚本指令"><a href="#_2-10-1-实现脚本指令" class="header-anchor">#</a> 2.10.1 实现脚本指令</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@TaskInstruct</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;jscript&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@TaskService</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;js-script-instruct&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">instruct</span><span class="token punctuation">(</span><span class="token class-name">InstructContent</span> instructContent<span class="token punctuation">,</span> <span class="token class-name">ScopeDataOperator</span> scopeDataOperator<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>instructContent<span class="token punctuation">.</span><span class="token function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">JsScriptProperty</span> property <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>scopeDataOperator<span class="token punctuation">.</span><span class="token function">getTaskProperty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isPresent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            property <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>scopeDataOperator<span class="token punctuation">.</span><span class="token function">getTaskProperty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">JsScriptProperty</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            LOGGER<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;[{}] js script property parsing exception. instruct: '{}{}', property: {}&quot;</span><span class="token punctuation">,</span> <span class="token class-name">ExceptionEnum</span><span class="token punctuation">.</span>SCRIPT_PROPERTY_PARSER_ERROR<span class="token punctuation">.</span><span class="token function">getExceptionCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token class-name">BpmnElementProperties</span><span class="token punctuation">.</span>SERVICE_TASK_TASK_INSTRUCT<span class="token punctuation">,</span> instructContent<span class="token punctuation">.</span><span class="token function">getInstruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> scopeDataOperator<span class="token punctuation">.</span><span class="token function">getTaskProperty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span>EMPTY<span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">String</span> invokeMethodName <span class="token operator">=</span> <span class="token string">&quot;invoke&quot;</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> script <span class="token operator">=</span> instructContent<span class="token punctuation">.</span><span class="token function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>property <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>property<span class="token punctuation">.</span><span class="token function">getInvokeMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            invokeMethodName <span class="token operator">=</span> property<span class="token punctuation">.</span><span class="token function">getInvokeMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            script <span class="token operator">=</span> <span class="token class-name">GlobalUtil</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>DEFAULT_FUNCTION<span class="token punctuation">,</span> invokeMethodName<span class="token punctuation">,</span> script<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        LOGGER<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;invoke js script. instruct: '{}{}', script: {}, property: {}&quot;</span><span class="token punctuation">,</span>
                <span class="token class-name">BpmnElementProperties</span><span class="token punctuation">.</span>SERVICE_TASK_TASK_INSTRUCT<span class="token punctuation">,</span> instructContent<span class="token punctuation">.</span><span class="token function">getInstruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> script<span class="token punctuation">,</span> scopeDataOperator<span class="token punctuation">.</span><span class="token function">getTaskProperty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span>EMPTY<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ScriptEngine</span> jsEngine <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ScriptEngineManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getEngineByName</span><span class="token punctuation">(</span><span class="token string">&quot;javascript&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Bindings</span> bind <span class="token operator">=</span> jsEngine<span class="token punctuation">.</span><span class="token function">createBindings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        bind<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;ksta&quot;</span><span class="token punctuation">,</span> scopeDataOperator<span class="token punctuation">.</span><span class="token function">getStaScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        bind<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;kvar&quot;</span><span class="token punctuation">,</span> scopeDataOperator<span class="token punctuation">.</span><span class="token function">getVarScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        bind<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;kreq&quot;</span><span class="token punctuation">,</span> scopeDataOperator<span class="token punctuation">.</span><span class="token function">getReqScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        bind<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;kres&quot;</span><span class="token punctuation">,</span> scopeDataOperator<span class="token punctuation">.</span><span class="token function">getResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        jsEngine<span class="token punctuation">.</span><span class="token function">setBindings</span><span class="token punctuation">(</span>bind<span class="token punctuation">,</span> <span class="token class-name">ScriptContext</span><span class="token punctuation">.</span>ENGINE_SCOPE<span class="token punctuation">)</span><span class="token punctuation">;</span>

        jsEngine<span class="token punctuation">.</span><span class="token function">eval</span><span class="token punctuation">(</span>script<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Object</span> result <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Invocable</span><span class="token punctuation">)</span> jsEngine<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">invokeFunction</span><span class="token punctuation">(</span>invokeMethodName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> property <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isAllBlank</span><span class="token punctuation">(</span>property<span class="token punctuation">.</span><span class="token function">getReturnType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> property<span class="token punctuation">.</span><span class="token function">getResultConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            result <span class="token operator">=</span> typeConverterProcessor<span class="token punctuation">.</span><span class="token function">convert</span><span class="token punctuation">(</span>property<span class="token punctuation">.</span><span class="token function">getResultConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> result<span class="token punctuation">,</span> <span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">ofNullable</span><span class="token punctuation">(</span>property<span class="token punctuation">.</span><span class="token function">getReturnType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token operator">::</span><span class="token function">isNotBlank</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>rt <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span>rt<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>property <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>property<span class="token punctuation">.</span><span class="token function">getReturnTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> target <span class="token operator">:</span> property<span class="token punctuation">.</span><span class="token function">getReturnTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">boolean</span> setRes <span class="token operator">=</span> scopeDataOperator<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>setRes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    LOGGER<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;invoke js script set result fail. instruct: '{}{}', target: {}, result: {}&quot;</span><span class="token punctuation">,</span>
                            <span class="token class-name">BpmnElementProperties</span><span class="token punctuation">.</span>SERVICE_TASK_TASK_INSTRUCT<span class="token punctuation">,</span> instructContent<span class="token punctuation">.</span><span class="token function">getInstruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> target<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        LOGGER<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;invoke js script success. instruct: '{}{}', result: {}&quot;</span><span class="token punctuation">,</span> <span class="token class-name">BpmnElementProperties</span><span class="token punctuation">.</span>SERVICE_TASK_TASK_INSTRUCT<span class="token punctuation">,</span> instructContent<span class="token punctuation">.</span><span class="token function">getInstruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token class-name">ExceptionUtil</span><span class="token punctuation">.</span><span class="token function">buildException</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> <span class="token class-name">ExceptionEnum</span><span class="token punctuation">.</span>SCRIPT_EXECUTE_ERROR<span class="token punctuation">,</span> <span class="token class-name">GlobalUtil</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;js script execution exception! instruct: '{}{}', property: {}, script: \n{}&quot;</span><span class="token punctuation">,</span>
                <span class="token class-name">BpmnElementProperties</span><span class="token punctuation">.</span>SERVICE_TASK_TASK_INSTRUCT<span class="token punctuation">,</span> instructContent<span class="token punctuation">.</span><span class="token function">getInstruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> scopeDataOperator<span class="token punctuation">.</span><span class="token function">getTaskProperty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span>EMPTY<span class="token punctuation">)</span><span class="token punctuation">,</span> script<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br></div></div><p>    以上为使用自定义指令实现支持的服务节点脚本功能的源码，可直接使用默认脚本能力，也可作为参考实现自己的脚本引擎</p> <h3 id="_2-10-2-默认脚本功能"><a href="#_2-10-2-默认脚本功能" class="header-anchor">#</a> 2.10.2 默认脚本功能</h3> <p>下图是在服务节点上定义的一个脚本指令：</p> <p><a data-fancybox="" title="使用默认脚本" href="../img2/8ad19b3369c13a0afe54afc1a1be974b.png"><img src="/assets/img/8ad19b3369c13a0afe54afc1a1be974b.d0ad485c.png" alt="8ad19b3369c13a0afe54afc1a1be974b"></a></p> <p>    🟢 脚本指令需要指定脚本名称<code>c-jscript</code>，此名称是固定的，指令内容不能为空否则脚本不生效</p> <p>    🟢 如果指令和服务节点名称同时存在，并且想要在节点方法之前执行，可以在指令名称前加<code>^</code>，这也是自定义指令的功能</p> <p>    🟢 在服务节点或者网关上可以使用<code>task-property</code>来指定脚本属性，默认脚本支持的属性如下：</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;result-converter&quot;</span><span class="token operator">:</span> <span class="token string">&quot;object_to_long_list&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;return-target&quot;</span><span class="token operator">:</span> <span class="token string">&quot;var.classIds&quot;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>        🔷 <strong><code>invoke-method</code></strong>：指定脚本方法名称。默认无需设置，此时直接写脚本逻辑即可，如果该字段不为空，脚本内容需定义成方法格式如下，此时<code>&quot;invoke-method&quot;: &quot;inv&quot;</code>：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">inv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> 
    <span class="token keyword">var</span> classIds <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span> kvar<span class="token punctuation">.</span>studyExperienceList<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        classIds<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>kvar<span class="token punctuation">.</span>studyExperienceList<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>classId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>classIds<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>        🔷 <strong><code>return-type</code></strong>：脚本执行完之后结果的返回类型</p> <p>        🔷 <strong><code>return-target</code></strong>：脚本执行完之后最终的结果被放到StoryBus的什么位置，支持设置多个</p> <p>        🔷 <strong><code>result-converter</code></strong>：指定类型转换器，将脚本拿到的结果转换成需要的类型</p> <p>    🟢 包含网关、排他网关也支持配置自定义指令，脚本指令也是指令，所以也是支持的</p> <div class="custom-block warning"><p class="custom-block-title">注意：</p> <p>高版本JDK不支持JS引擎获取，<code>new ScriptEngineManager().getEngineByName(&quot;javascript&quot;);</code>会得到空值，此时需要在项目中加入依赖：</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.openjdk.nashorn<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>nashorn-core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>15.3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div></div> <h2 id="_2-11-代码方式定义流程"><a href="#_2-11-代码方式定义流程" class="header-anchor">#</a> 2.11 代码方式定义流程</h2> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>BPMN文件虽然有非常优秀的可视化特点，但是也有一些不足之处，比如ide中点击定义在配置文件中的服务节点无法快速定位到具体方法、无法识别自定义协议的流程文件等。Kstry提供代码定义流程的方式来平衡这些问题。</p></div> <p>     框架提供<code>ProcessLink</code>作为代码方式定义流程最核心的类，它提供了众多辅助流程节点彼此间拼接的方法：</p> <p>    🟢 <code>nextTask</code>：指定下一个服务节点，类组件和服务节点名称都需要提供</p> <p>    🟢 <code>nextService</code>：指定下一个服务节点，仅需要提供服务节点名称即可。在确保服务节点名称全局唯一时使用，可以节省代码量</p> <p>    🟢 <code>nextInstruct</code>：指定下一个指令。指令是一种特殊的服务节点。</p> <p>    🟢 <code>nextSubProcess</code>：指定下一个子流程</p> <p>    🟢 <code>nextExclusive</code>：指定下一个排他网关</p> <p>    🟢 <code>nextInclusive</code>：指定下一个包含网关</p> <p>    🟢 <code>nextParallel</code>：指定下一个并行网关</p> <p>    🟢 <code>joinTask</code>：将多个任务分支进行合并</p> <p>    🟢 <code>end</code>：指定下一个结束事件</p> <h3 id="_2-11-1-主流程定义"><a href="#_2-11-1-主流程定义" class="header-anchor">#</a> 2.11.1 主流程定义</h3> <p><a data-fancybox="" title="查询学生信息流程定义" href="../img2/e25009a28fddcdeed786aff92a414151.png"><img src="/assets/img/e25009a28fddcdeed786aff92a414151.ec6f83fc.png" alt="image-WX20230926"></a></p> <p><strong>代码方式定义此流程图如下：</strong></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">ProcessLink</span> <span class="token function">studentScoreQueryProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> instructContent <span class="token operator">=</span> <span class="token string">&quot;var classIds = [];&quot;</span>
            <span class="token operator">+</span> <span class="token string">&quot;for (var i = 0; i&lt; kvar.studyExperienceList.length; i++)&quot;</span>
            <span class="token operator">+</span> <span class="token string">&quot;{&quot;</span>
            <span class="token operator">+</span> <span class="token string">&quot;    classIds.push(kvar.studyExperienceList[i].classId);&quot;</span>
            <span class="token operator">+</span> <span class="token string">&quot;}&quot;</span>
            <span class="token operator">+</span> <span class="token string">&quot;return JSON.stringify(classIds)&quot;</span><span class="token punctuation">;</span>
    <span class="token class-name">StartProcessLink</span> processLink <span class="token operator">=</span> <span class="token class-name">StartProcessLink</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token class-name">DefProcess</span><span class="token operator">::</span><span class="token function">studentScoreQueryProcess</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">InclusiveJoinPoint</span> asyncInclusive <span class="token operator">=</span> processLink<span class="token punctuation">.</span><span class="token function">nextInclusive</span><span class="token punctuation">(</span>processLink<span class="token punctuation">.</span><span class="token function">inclusive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">openAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">InclusiveJoinPoint</span> asyncInclusive2 <span class="token operator">=</span> asyncInclusive
            <span class="token punctuation">.</span><span class="token function">nextService</span><span class="token punctuation">(</span><span class="token class-name">Exp</span><span class="token punctuation">.</span><span class="token function">b</span><span class="token punctuation">(</span>e <span class="token operator">-&gt;</span> e<span class="token punctuation">.</span><span class="token function">isTrue</span><span class="token punctuation">(</span><span class="token class-name">ScopeTypeEnum</span><span class="token punctuation">.</span>REQUEST<span class="token punctuation">,</span> <span class="token class-name">QueryScoreRequest<span class="token punctuation">.</span>F</span><span class="token punctuation">.</span>needScore<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">StudentScoreService</span><span class="token operator">::</span><span class="token function">getStudyExperienceList</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">nextInstruct</span><span class="token punctuation">(</span><span class="token string">&quot;jscript&quot;</span><span class="token punctuation">,</span> instructContent<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token string">&quot;JS脚本&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">property</span><span class="token punctuation">(</span><span class="token string">&quot;{\&quot;result-converter\&quot;: \&quot;object_to_long_list\&quot;,\&quot;return-target\&quot;: \&quot;var.classIds\&quot;}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">nextInclusive</span><span class="token punctuation">(</span>processLink<span class="token punctuation">.</span><span class="token function">inclusive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">openAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    processLink<span class="token punctuation">.</span><span class="token function">inclusive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">joinLinks</span><span class="token punctuation">(</span>
                    processLink<span class="token punctuation">.</span><span class="token function">parallel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">notStrictMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">joinLinks</span><span class="token punctuation">(</span>
                            asyncInclusive2<span class="token punctuation">.</span><span class="token function">nextService</span><span class="token punctuation">(</span><span class="token class-name">StudentScoreService</span><span class="token operator">::</span><span class="token function">getClasInfoById</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            asyncInclusive2<span class="token punctuation">.</span><span class="token function">nextService</span><span class="token punctuation">(</span><span class="token class-name">StudentScoreService</span><span class="token operator">::</span><span class="token function">getStudentScoreList</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextService</span><span class="token punctuation">(</span><span class="token class-name">StudentScoreService</span><span class="token operator">::</span><span class="token function">assembleScoreClassInfo</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    processLink<span class="token punctuation">.</span><span class="token function">inclusive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">joinLinks</span><span class="token punctuation">(</span>
                            asyncInclusive<span class="token punctuation">.</span><span class="token function">nextService</span><span class="token punctuation">(</span><span class="token class-name">StudentScoreService</span><span class="token operator">::</span><span class="token function">getStudentBasic</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            asyncInclusive<span class="token punctuation">.</span><span class="token function">nextService</span><span class="token punctuation">(</span><span class="token class-name">StudentScoreService</span><span class="token operator">::</span><span class="token function">getStudentPrivacy</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextService</span><span class="token punctuation">(</span><span class="token class-name">StudentScoreService</span><span class="token operator">::</span><span class="token function">assembleStudentInfo</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">nextService</span><span class="token punctuation">(</span><span class="token class-name">StudentScoreService</span><span class="token operator">::</span><span class="token function">getQueryScoreResponse</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> processLink<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><p>    🟢 定义<code>ProcessLink</code>对象，放入Spring容器中，流程在启动时就会被加载生效，这种生效方式是不支持动态变更的</p> <h3 id="_2-11-2-子流程定义"><a href="#_2-11-2-子流程定义" class="header-anchor">#</a> 2.11.2 子流程定义</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">SubProcessLink</span> <span class="token function">calculateSubProcessDemo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token class-name">SubProcessLink</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token class-name">ProcessConfig</span><span class="token operator">::</span><span class="token function">calculateSubProcessDemo</span><span class="token punctuation">,</span> link <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token class-name">InclusiveJoinPoint</span> inclusiveJoinPoint <span class="token operator">=</span> link<span class="token punctuation">.</span><span class="token function">nextInclusive</span><span class="token punctuation">(</span>link<span class="token punctuation">.</span><span class="token function">inclusive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">openAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        link<span class="token punctuation">.</span><span class="token function">inclusive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">joinLinks</span><span class="token punctuation">(</span>
                inclusiveJoinPoint<span class="token punctuation">.</span><span class="token function">nextService</span><span class="token punctuation">(</span><span class="token class-name">Ex</span><span class="token punctuation">.</span><span class="token function">b</span><span class="token punctuation">(</span>e <span class="token operator">-&gt;</span> e<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;var.factor&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;'+'&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">CalculateService</span><span class="token operator">::</span><span class="token function">plusCalculate</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                inclusiveJoinPoint<span class="token punctuation">.</span><span class="token function">nextService</span><span class="token punctuation">(</span><span class="token class-name">Ex</span><span class="token punctuation">.</span><span class="token function">b</span><span class="token punctuation">(</span>e <span class="token operator">-&gt;</span> e<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;var.factor&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;'*'&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">CalculateService</span><span class="token operator">::</span><span class="token function">multiplyCalculate</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                inclusiveJoinPoint<span class="token punctuation">.</span><span class="token function">nextService</span><span class="token punctuation">(</span><span class="token class-name">Ex</span><span class="token punctuation">.</span><span class="token function">b</span><span class="token punctuation">(</span>e <span class="token operator">-&gt;</span> e<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;var.factor&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;'-'&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">CalculateService</span><span class="token operator">::</span><span class="token function">minusCalculate</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>    🟢 子流程与主流程有相似之处，定义<code>SubProcessLink</code>对象放入Spring容器中，子流程在启动时就会被加载生效，同样不支持动态变更</p> <h3 id="_2-11-3-解析文件定义流程"><a href="#_2-11-3-解析文件定义流程" class="header-anchor">#</a> 2.11.3 解析文件定义流程</h3> <p>    代码定义流程看上去比BPMN可视化流程图复杂不少，为什么还要支持呢？</p> <p>    正如前面所说的，少量服务节点组成的流程，代码定义起来会更加方便。而更重要的一个原因则是，用代码方式定义流程可以支持任意协议的流程配置文件，可以按需解析开源或公司内部的前端流程组件，并配合Kstry完成最终的流程编排。</p> <p>    而框架本身，在1.1.x之后的版本里PBMN流程配置文件也是用这套API来解析的，具体可以参考Kstry源码中的实现： <a href="https://gitee.com/kstry/kstry-core/blob/master/src/main/java/cn/kstry/framework/core/component/bpmn/CamundaBpmnModelTransfer.java" target="_blank" rel="noopener noreferrer">CamundaBpmnModelTransfer<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。在后面的动态流程配置里，这套API也是必不可少的部分</p> <h2 id="_2-12-动态流程配置"><a href="#_2-12-动态流程配置" class="header-anchor">#</a> 2.12 动态流程配置</h2> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>定义路径扫描bpmn文件和创建<code>ProcessLink</code>实例放入Spring容器两种流程的定义方式是静态的，如果要修改只能重启应用。框架在1.1.x版本之后提供了动态获取流程配置的能力，并且动态化配置支持通过http或rpc调用、关系或者非关系型数据库查询、订阅消息队列、订阅注册中心、公司自定义存储介质查询等任意方式获取</p></div> <h3 id="_2-12-1-使用动态流程"><a href="#_2-12-1-使用动态流程" class="header-anchor">#</a> 2.12.1 使用动态流程</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DynamicProcessRegister</span> <span class="token keyword">implements</span> <span class="token class-name">DynamicProcess</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">version</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ProcessLink</span><span class="token punctuation">&gt;</span></span> <span class="token function">getProcessLink</span><span class="token punctuation">(</span><span class="token class-name">String</span> startId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">InputStream</span> inputStream <span class="token operator">=</span> <span class="token class-name">DynamicProcessRegister</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getResourceAsStream</span><span class="token punctuation">(</span><span class="token string">&quot;dynamic/goods.bpmn&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">BpmnProcessParser</span> parser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BpmnProcessParser</span><span class="token punctuation">(</span><span class="token string">&quot;动态获取流程&quot;</span><span class="token punctuation">,</span> inputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> parser<span class="token punctuation">.</span><span class="token function">getProcessLink</span><span class="token punctuation">(</span>startId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>    🟢 创建实现<code>DynamicProcess</code>接口的类实例，放入Spring容器中，动态流程组件即会生效</p> <p>    🟢 <code>DynamicProcess</code>提供两个方法：</p> <p>        🔷 <strong><code>version(String key)</code></strong>：传入startId返回当前流程的版本号，版本号没有变化并且流程缓存没有失效时，框架不会调用<code>getProcessLink(String startId)</code>来获取新的流程，反之则会重新获取新的流程。流程缓存的时长是1天。修改流程后控制该方法进行版本号升级，新的流程会即刻生效。如果想要删除某个流程，升级版本号后<code>getProcessLink(String startId)</code>返回空即可实现</p> <p>        🔷 <strong><code>getProcessLink(String startId)</code></strong>：根据startId获取流程配置。缓存未失效且版本未改变时该方法不会被调用。</p> <p>    🟢 上面代码演示的是从类路径下加载流程配置文件，通过流程解析器解析生成<code>ProcessLink</code>对象并返回的过程。可以根据需要从任意存储介质中获取流程配置信息</p> <p>    🟢 如果不需要缓存，每次都要获取最新的流程，将<code>version(String key)</code>的返回值设置成小于0的值即可</p> <h3 id="_2-12-2-使用动态子流程"><a href="#_2-12-2-使用动态子流程" class="header-anchor">#</a> 2.12.2 使用动态子流程</h3> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>框架同样提供了动态获取子流程的能力</p></div> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DynamicSubProcessRegister</span> <span class="token keyword">implements</span> <span class="token class-name">DynamicSubProcess</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SubProcessLink</span><span class="token punctuation">&gt;</span></span> <span class="token function">getSubProcessLinks</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">InputStream</span> inputStream <span class="token operator">=</span> <span class="token class-name">DynamicSubProcessRegister</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getResourceAsStream</span><span class="token punctuation">(</span><span class="token string">&quot;dynamic/goods.bpmn&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">BpmnProcessParser</span> parser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BpmnProcessParser</span><span class="token punctuation">(</span><span class="token string">&quot;动态获取流程&quot;</span><span class="token punctuation">,</span> inputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">Lists</span><span class="token punctuation">.</span><span class="token function">newArrayList</span><span class="token punctuation">(</span>parser<span class="token punctuation">.</span><span class="token function">getAllSubProcessLink</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>    🟢 创建实现<code>DynamicSubProcess</code>接口的类实例，放入Spring容器中，动态子流程组件即会生效</p> <p>    🟢 动态子流程没有版本的概念，只要是获取就是最新的。获取子流程动作是在创建主流程时被触发的，可以理解成主流程和子流程共用一个版本号</p> <h3 id="_2-12-3-动态与静态流程关系"><a href="#_2-12-3-动态与静态流程关系" class="header-anchor">#</a> 2.12.3 动态与静态流程关系</h3> <p>    只有<code>bpmnPath</code>一种流程配置途径时，下面这种可视化流程图就是被定义出来的流程，也是凭此来指导程序实际线路的执行。<code>ProcessLink</code>出现之后，框架提供了自定义流程的能力给使用者，在1.x之后的版本中，BPMN可视化流程图也是被解析成<code>ProcessLink</code>对象来生效的，此时的BPMN可视化流程就作为了流程定义的一个子集而存在。更多情况下使用者可以通过编码、解析各类配置文件等方式来创建<code>ProcessLink</code>实例，最终交付给框架的<code>ProcessLink</code>实例将会作为流程定义来指导程序的执行。</p> <p><a data-fancybox="" title="image-20211219163429668.png" href="http://cdn.kstry.cn/doc/img/image-20211219163429668.png" style="zoom:60%;"><img src="http://cdn.kstry.cn/doc/img/image-20211219163429668.png" alt="image-20211219163429668.png"></a></p> <p>    Kstry提供了三种方式来定义流程配置，分别是：</p> <p>    🟢 【<strong>基础流程配置</strong>】指定<code>@EnableKstry</code>注解的<code>bpmnPath</code>属性来扫描指定目录下的bpmn配置文件</p> <p>    🟢 【<strong>基础流程配置</strong>】创建<code>ProcessLink</code>实例放入Spring容器中</p> <p>    🟢 【<strong>动态流程配置</strong>】实现<code>DynamicProcess</code>接口的<code>getProcessLink</code>方法</p> <p>    前面两种方式定义的流程是应用启动前就必须要定义出来的属于基础流程配置，基础流程除非应用重启否则是不允许修改的。根据<code>startId</code>在基础流程配置库里获取不到流程配置时最后一种方式才会生效，其获取流程配置的方式是动态的，传入<code>startId</code>返回<code>ProcessLink</code>实例，其中所需的流程配置信息可以通过http或rpc调用、关系或者非关系型数据库查询、订阅消息队列、订阅注册中心、公司自定义存储介质查询等任意方式获取。</p> <img src="http://cdn.kstry.cn/doc/img/WX20221212-030616.png" alt="WX20221212-030616" style="zoom:90%;"> <p>    之所以没有使用动态改变基础流程配置库的方式来实现流程的动态配置能力，有以下原因：</p> <p>    🟢 【<strong>安全性</strong>】流程配置可能会分重要级别，核心的流程配置是被严格管控不允许随意变更的，所以这类配置应该放在代码中不允许随意变更。如果在流程配置基础库中找到与<code>startId</code>相匹配的流程，动态获取部分将失效，以此来保障流程的绝对安全。即便核心流程中有部分需要动态获取的扩展逻辑，也可以用动态子流程的形式来实现。</p> <p>    🟢 【<strong>兼容性</strong>】动态化配置可能比较适合使用注册中心来存储维护，这样当发生变更时能快速及时通知相关应用做流程变更。但并没有一个注册中心是所有公司都使用的，除了开源产品还有公司自研，如果想要一一支持是不现实的。选用其他中间件产品也是同样的道理。所以解决这个问题的方式就是提供一个动态获取流程配置的入口，至于流程配置在什么地方获取将是因人而异的。</p> <p>    在流程中出现可复用或者复杂的链路片段时，就可以将这些片段抽离出来定义子流程。父流程可以通过子流程Id来引用子流程。同样也有三种方式来定义子流程，分别是：</p> <p>    🟢 【<strong>基础子流程配置</strong>】指定<code>@EnableKstry</code>注解的<code>bpmnPath</code>属性来扫描指定目录下的bpmn配置文件</p> <p>    🟢 【<strong>基础子流程配置</strong>】创建<code>SubProcessLink</code>实例放入Spring容器中</p> <p>    🟢 【<strong>动态子流程配置</strong>】实现<code>DynamicSubProcess</code>接口的<code>getSubProcessLinks</code>方法</p> <p>    主流程有基础和动态之分，相对应也有基础和动态子流程的存在。下图为两者结合起来时，相互之间是否允许被引用的说明：</p> <img src="http://cdn.kstry.cn/doc/img/WX20221222-183429.png" alt="WX20221222-183429" style="zoom:90%;"> <p>    🟢 基础流程仅能引用基础子流程配置，动态流程可以引用基础子流程和动态子流程配置</p> <p>    🟢 两种子流程在各自的区域内可以相互引用，动态子流程中可以引用基础子流程配置，反之则不被允许</p> <div class="custom-block danger"><p class="custom-block-title">警告</p> <p>子流程相互间引用时，一定不能出现环状依赖，否则会出现异常❗️❗️❗️</p></div> <h2 id="_2-13-使用异步流程"><a href="#_2-13-使用异步流程" class="header-anchor">#</a> 2.13 使用异步流程</h2> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>流程配置中并行网关、包含网关后面的流程支持开启异步</p></div> <h3 id="_2-13-1-开启异步"><a href="#_2-13-1-开启异步" class="header-anchor">#</a> 2.13.1 开启异步</h3> <p>    🟢 <strong>目前支持配置异步开启的组件有：并行网关、包含网关两种</strong>，排他网关虽然是允许有多个出度，但最终只有一个出度被执行，所以开启异步的效果不大并未支持开启异步</p> <p>    🟢 在网关上配置<code>open-async=true</code>即可开启异步功能</p> <p>    🟢 和普通的多线程使用方式一样，并发度太高也并非一定是好事。每开启一个新线程都要创建新的计算任务，加上线程间的上下文切换，在一些本来就耗时很短的服务节点间开启异步大多时候会得不偿失</p> <h3 id="_2-13-2-异步化生命周期"><a href="#_2-13-2-异步化生命周期" class="header-anchor">#</a> 2.13.2 异步化生命周期</h3> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>在并行网关、包含网关上配置<code>open-async=true</code>属性即可开启异步流程。那么异步的开始是什么时候，结束又是在何处呢？</p></div> <h4 id="异步的开始"><a href="#异步的开始" class="header-anchor">#</a> 异步的开始</h4> <p><strong>开始流程如下：</strong></p> <p>    🟢 执行引擎检测到并行网关、包含网关上配置<code>open-async=true</code>属性后，会将网关后面的出度包装成异步任务，并行网关与包含网关执行策略又略显不同：</p> <p>        🔷 并行网关会将其后的全部出度逐一包装成异步任务，提交至线程池执行</p> <p>        🔷 包含网关会判断其后的出度是否有条件表达式，如果有会先解析条件表达式，将表达式结果为true和没有表达式的出度逐一包装成异步任务提交到线程池执行</p> <p>    🟢 提交完异步任务的线程会继续执行任务栈中的其他节点任务，不会再顾及异步网关出度及出度之后的节点，直至任务栈中没有了可执行节点时线程会归还至线程池，等待下一次被调用</p> <p>    🟢 线程池随机选择线程执行上述流程中创建的异步任务</p> <h4 id="异步的结束"><a href="#异步的结束" class="header-anchor">#</a> 异步的结束</h4> <p>    什么是异步？异步就是同一时间多个线程去做了多个事情，以此来节省需要一个线程做多个事情所花费的时间。这种模式有点像算法里面的空间换取时间的味道。Kstry中什么时候结束开启后的异步任务呢？答案是<strong>多个可以同一时间执行的异步任务被聚合网关聚合后异步流程就结束了</strong>。比如：</p> <p>    🟢 一个流程被并行网关拆分成了两个异步任务，这两个异步任务都遇到同一聚合节点后，任务就被聚合节点归拢了，异步任务也就结束了</p> <p>    🟢 一个流程被并行网关拆分成了两个异步任务，两个异步任务又分别拆分出了两个异步任务，只有四个异步任务全部聚合时，才算真正意义上的异步流程结束，如下的流程定义是允许的：</p> <p><a data-fancybox="" title="image-20211215163047312" href="http://cdn.kstry.cn/doc/img/image-20211215163047312.png" style="zoom:40%;"><img src="http://cdn.kstry.cn/doc/img/image-20211215163047312.png" alt="image-20211215163047312"></a></p> <p><strong>当前聚合节点的元素有：</strong></p> <p>    🟢 并行网关</p> <p>    🟢 包含网关</p> <p>    🟢 结束事件</p> <p><a data-fancybox="" title="image-20211215163704815" href="http://cdn.kstry.cn/doc/img/image-20211215163704815.png"><img src="http://cdn.kstry.cn/doc/img/image-20211215163704815.png" alt="image-20211215163704815"></a></p> <p><strong>聚合节点可以随心所欲的聚合多个流程。除聚合节点外的其他节点元素，只允许接收一个入度</strong></p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>之所以除聚合节点外的其他节点元素，只允许接收一个入度是因为：存在多个入度时，如果这些入度是异步的就会有多个线程执行到这个聚集点，假设Task节点可以支持多入度，那么Task节点就可能被执行多次。因为Task节点不具备聚合节点的能力，不能让前面的流程停下来等待全部流程都到达后才继续。换句话说只有聚合节点才能支持多入度</p></div> <h3 id="_2-13-3-线程切换钩子"><a href="#_2-13-3-线程切换钩子" class="header-anchor">#</a> 2.13.3 线程切换钩子</h3> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>框架提供了线程间切换时的回调钩子，用来传递线程切换前后的数据。钩子只对Kstry框架中执行的任务生效</p></div> <p><strong>使用线程切换钩子</strong></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SwitchHook</span> <span class="token keyword">implements</span> <span class="token class-name">ThreadSwitchHook</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> ITERATOR_THREAD_LOCAL <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getPreviousData</span><span class="token punctuation">(</span><span class="token class-name">ScopeDataQuery</span> scopeDataQuery<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> ITERATOR_THREAD_LOCAL<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">usePreviousData</span><span class="token punctuation">(</span><span class="token class-name">String</span> data<span class="token punctuation">,</span> <span class="token class-name">ScopeDataQuery</span> scopeDataQuery<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ITERATOR_THREAD_LOCAL<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>    🟢 用<code>ITERATOR_THREAD_LOCAL.set()</code>在调用<code>engine.fire()</code>前设置一个字符串，在后面的任意节点上都可以用<code>SwitchHook.ITERATOR_THREAD_LOCAL.get()</code>拿到</p> <p>    🟢 任务执行期间发生线程切换时，实现<code>ThreadSwitchHook</code>接口的Spring组件就会被调用</p> <p>    🟢 线程切换前调用<code>getPreviousData(ScopeDataQuery scopeDataQuery)</code>获取到要保存的值，线程切换后再调用<code>usePreviousData(String data, ScopeDataQuery scopeDataQuery)</code>将切换前拿到的数据传入，用以后续的使用</p> <p>    🟢 <code>ThreadSwitchHook</code>组件出现多个时，重写<code>getOrder()</code>方法即可支持排序</p> <h3 id="_2-13-4-reactor模型"><a href="#_2-13-4-reactor模型" class="header-anchor">#</a> 2.13.4 Reactor模型</h3> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>默认情况下节点方法中调用耗时长的接口时会产生工作线程的等待，从而影响整个系统的吞吐。方法支持返回Mono类型结果来释放工作线程并等待请求完成后的回调，后用回调来推进流程的下一步动作</p></div> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@TaskService</span>
<span class="token annotation punctuation">@NoticeVar</span><span class="token punctuation">(</span>target <span class="token operator">=</span> <span class="token class-name">QueryScoreVarScope<span class="token punctuation">.</span>F</span><span class="token punctuation">.</span>classInfos<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ClassInfo</span><span class="token punctuation">&gt;</span></span> <span class="token function">getClasInfoById</span><span class="token punctuation">(</span><span class="token class-name">IterDataItem</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> classIdItem<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">fromFuture</span><span class="token punctuation">(</span><span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">supplyAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// mock return result</span>
        <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> idOptional <span class="token operator">=</span> classIdItem<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ClassInfo</span> classInfo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        classInfo<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>idOptional<span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        classInfo<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">&quot;班级&quot;</span> <span class="token operator">+</span> idOptional<span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>classInfo<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> classInfo<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>    🟢 除了返回值类型变为Mono类型，其他地方与默认节点方法使用方式完全相同</p> <p>    🟢 示例中方法会直接返回Mono对象，期间不会出现任何停滞，执行引擎拿到Mono对象之后会释放当前线程，直至Mono返回成功或失败信号后，回调动作继续驱动流程向后执行</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/doc/specification/quick_start.html" class="prev">
        一、快速开始
      </a></span> <span class="next"><a href="/doc/specification/data_transfer.html">
        三、数据流转
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.fc8f11ce.js" defer></script><script src="/assets/js/2.6d18f2ff.js" defer></script><script src="/assets/js/3.84f41dcf.js" defer></script>
  </body>
</html>
