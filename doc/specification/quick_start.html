<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Kstry业务架构首选框架</title>
    <meta name="generator" content="VuePress 1.9.7">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.slim.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.2/jquery.fancybox.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.2/jquery.fancybox.min.css">
    <meta name="description" content="Kstry使用文档">
    
    <link rel="preload" href="/assets/css/0.styles.9634fd34.css" as="style"><link rel="preload" href="/assets/js/app.fc8f11ce.js" as="script"><link rel="preload" href="/assets/js/2.6d18f2ff.js" as="script"><link rel="preload" href="/assets/js/5.a021e58e.js" as="script"><link rel="prefetch" href="/assets/js/10.976139c2.js"><link rel="prefetch" href="/assets/js/11.cee08e74.js"><link rel="prefetch" href="/assets/js/12.b8c547b5.js"><link rel="prefetch" href="/assets/js/13.63a0d034.js"><link rel="prefetch" href="/assets/js/14.8cab9faf.js"><link rel="prefetch" href="/assets/js/15.349558f5.js"><link rel="prefetch" href="/assets/js/16.0d2fbd26.js"><link rel="prefetch" href="/assets/js/17.af43253d.js"><link rel="prefetch" href="/assets/js/3.84f41dcf.js"><link rel="prefetch" href="/assets/js/4.32e6db9d.js"><link rel="prefetch" href="/assets/js/6.8b7c2b97.js"><link rel="prefetch" href="/assets/js/7.c487ae2f.js"><link rel="prefetch" href="/assets/js/8.81adceba.js"><link rel="prefetch" href="/assets/js/9.c1a65384.js">
    <link rel="stylesheet" href="/assets/css/0.styles.9634fd34.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="http://cdn.kstry.cn/doc/img/title-field.png" alt="Kstry业务架构首选框架" class="logo"> <span class="site-name can-hide">Kstry业务架构首选框架</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/doc/understandkstry/use_case_demo.html" class="nav-link">
  使用场景
</a></div><div class="nav-item"><a href="/doc/specification/quick_start.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  使用文档
</a></div><div class="nav-item"><a href="http://kstry.cn/modeler" target="_blank" rel="noopener noreferrer" class="nav-link external">
  配置台
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="/doc/release/kstry-release.html" class="nav-link">
  发布记录
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="推荐" class="dropdown-title"><span class="title">推荐</span> <span class="arrow down"></span></button> <button type="button" aria-label="推荐" class="mobile-dropdown-title"><span class="title">推荐</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="http://waitmoon.com/zh/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  规则引擎—ice
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="https://github.com/kstry/kstry-core" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://gitee.com/kstry/kstry-core" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Gitee
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/doc/understandkstry/use_case_demo.html" class="nav-link">
  使用场景
</a></div><div class="nav-item"><a href="/doc/specification/quick_start.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  使用文档
</a></div><div class="nav-item"><a href="http://kstry.cn/modeler" target="_blank" rel="noopener noreferrer" class="nav-link external">
  配置台
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="/doc/release/kstry-release.html" class="nav-link">
  发布记录
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="推荐" class="dropdown-title"><span class="title">推荐</span> <span class="arrow down"></span></button> <button type="button" aria-label="推荐" class="mobile-dropdown-title"><span class="title">推荐</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="http://waitmoon.com/zh/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  规则引擎—ice
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="https://github.com/kstry/kstry-core" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://gitee.com/kstry/kstry-core" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Gitee
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><a href="/doc/specification/quick_start" class="sidebar-heading clickable open"><span>使用文档</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/doc/specification/quick_start.html" aria-current="page" class="active sidebar-link">一、快速开始</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/doc/specification/quick_start.html#_1-1-配置引入" class="sidebar-link">1.1 配置引入</a></li><li class="sidebar-sub-header"><a href="/doc/specification/quick_start.html#_1-2-项目引入" class="sidebar-link">1.2 项目引入</a></li><li class="sidebar-sub-header"><a href="/doc/specification/quick_start.html#_1-3-业务实体定义" class="sidebar-link">1.3 业务实体定义</a></li><li class="sidebar-sub-header"><a href="/doc/specification/quick_start.html#_1-4-定义出入参及数据传递类" class="sidebar-link">1.4 定义出入参及数据传递类</a></li><li class="sidebar-sub-header"><a href="/doc/specification/quick_start.html#_1-5-编写服务组件" class="sidebar-link">1.5 编写服务组件</a></li><li class="sidebar-sub-header"><a href="/doc/specification/quick_start.html#_1-6-定义服务流程" class="sidebar-link">1.6 定义服务流程</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/doc/specification/quick_start.html#_1-6-1-bpmn格式定义流程" class="sidebar-link">1.6.1 BPMN格式定义流程</a></li><li class="sidebar-sub-header"><a href="/doc/specification/quick_start.html#_1-6-2-json格式定义流程" class="sidebar-link">1.6.2 JSON格式定义流程</a></li><li class="sidebar-sub-header"><a href="/doc/specification/quick_start.html#_1-6-3-代码方式定义流程" class="sidebar-link">1.6.3 代码方式定义流程</a></li></ul></li><li class="sidebar-sub-header"><a href="/doc/specification/quick_start.html#_1-7-调用执行" class="sidebar-link">1.7 调用执行</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/doc/specification/quick_start.html#_1-7-1-同步方式调用执行" class="sidebar-link">1.7.1 同步方式调用执行</a></li><li class="sidebar-sub-header"><a href="/doc/specification/quick_start.html#_1-7-2-异步方式调用执行" class="sidebar-link">1.7.2 异步方式调用执行</a></li></ul></li></ul></li><li><a href="/doc/specification/process_choreography.html" class="sidebar-link">二、流程编排</a></li><li><a href="/doc/specification/data_transfer.html" class="sidebar-link">三、数据流转</a></li><li><a href="/doc/specification/rbac_model.html" class="sidebar-link">四、RBAC模式</a></li><li><a href="/doc/specification/use_variable.html" class="sidebar-link">五、变量</a></li><li><a href="/doc/specification/link_tracing.html" class="sidebar-link">六、链路追踪</a></li><li><a href="/doc/specification/appendix.html" class="sidebar-link">附录</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><br> <br> <br> <p><a data-fancybox="" title="查询学生信息流程定义" href="../img2/e25009a28fddcdeed786aff92a414151.png"><img src="/assets/img/e25009a28fddcdeed786aff92a414151.ec6f83fc.png" alt="image-WX20230926"></a></p> <p><strong>假设要实现以上 <em>学生信息查询流程</em> 中的逻辑：</strong></p> <p>    🟢 流程开始后分别查询学生基础信息、敏感信息，再将两种信息进行组合装配</p> <p>    🟢 如果需要展示分数列表的话，流程开始时还会查询学生学年列表，再通过学年列表分别查询班级和分数信息并组合装配</p> <p>    🟢 最后将学生信息和分数信息组合装配并返回结果</p> <h2 id="_1-1-配置引入"><a href="#_1-1-配置引入" class="header-anchor">#</a> 1.1 配置引入</h2> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>cn.kstry.framework<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>kstry-core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>最新版本<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><a href="https://central.sonatype.com/artifact/cn.kstry.framework/kstry-core/overview" target="_blank" rel="noopener noreferrer">查看最新版本<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="_1-2-项目引入"><a href="#_1-2-项目引入" class="header-anchor">#</a> 1.2 项目引入</h2> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>Kstry框架与Spring容器有较为密切的关联和依赖，当前版本暂时只能在Spring环境中运行</p></div> <div class="language-java line-numbers-mode"><pre class="language-java"><code>
<span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@EnableKstry</span><span class="token punctuation">(</span>bpmnPath <span class="token operator">=</span> <span class="token string">&quot;./bpmn/*.bpmn,./bpmn/*.json&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">KstryFluxDemoApplication</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">KstryFluxDemoApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p><strong><code>@EnableKstry</code>注解代表了要启动Kstry容器</strong></p> <p>    🟢 <code>bpmnPath</code>： 指定bpmn文件位置，多个路径可以通过<code>,</code>隔开。支持bpmn、json两种流程配置文件格式</p> <h2 id="_1-3-业务实体定义"><a href="#_1-3-业务实体定义" class="header-anchor">#</a> 1.3 业务实体定义</h2> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 学生基础信息</span>
<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StudentBasic</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> address<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 学生敏感信息</span>
<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StudentPrivacy</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> idCard<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> birthday<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 学生全量信息</span>
<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Student</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> address<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> idCard<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> birthday<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 学年信息</span>
<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@Builder</span>
<span class="token annotation punctuation">@NoArgsConstructor</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StudyExperience</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">Long</span> studentId<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">Long</span> classId<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> studyYear<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 分数信息</span>
<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@Builder</span>
<span class="token annotation punctuation">@NoArgsConstructor</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ScoreInfo</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">int</span> score<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">Long</span> studentId<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> studyYear<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> course<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">Long</span> classId<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">ClassInfo</span> classInfo<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 班级信息</span>
<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@Builder</span>
<span class="token annotation punctuation">@NoArgsConstructor</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ClassInfo</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br></div></div><h2 id="_1-4-定义出入参及数据传递类"><a href="#_1-4-定义出入参及数据传递类" class="header-anchor">#</a> 1.4 定义出入参及数据传递类</h2> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 入参</span>
<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@FieldNameConstants</span><span class="token punctuation">(</span>innerTypeName <span class="token operator">=</span> <span class="token string">&quot;F&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">QueryScoreRequest</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">Long</span> studentId<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">boolean</span> needScore<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 出参</span>
<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@FieldNameConstants</span><span class="token punctuation">(</span>innerTypeName <span class="token operator">=</span> <span class="token string">&quot;F&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">QueryScoreResponse</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">Student</span> student<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ScoreInfo</span><span class="token punctuation">&gt;</span></span> scoreInfos<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 对象形式定义var数据域</span>
<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@FieldNameConstants</span><span class="token punctuation">(</span>innerTypeName <span class="token operator">=</span> <span class="token string">&quot;F&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">QueryScoreVarScope</span> <span class="token keyword">implements</span> <span class="token class-name">ScopeData</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">StudentBasic</span> studentBasic<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">StudentPrivacy</span> studentPrivacy<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> student<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">StudyExperience</span><span class="token punctuation">&gt;</span></span> studyExperienceList<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> classIds<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ClassInfo</span><span class="token punctuation">&gt;</span></span> classInfos<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ScoreInfo</span><span class="token punctuation">&gt;</span></span> scoreInfos<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">ScopeTypeEnum</span> <span class="token function">getScopeDataEnum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">ScopeTypeEnum</span><span class="token punctuation">.</span>VARIABLE<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br></div></div><p>    🟢 <code>QueryScoreRequest</code>、<code>QueryScoreResponse</code>分别为流程执行的出入参</p> <p>    🟢 <code>@FieldNameConstants(innerTypeName = &quot;F&quot;)</code>是lombok工具注解，可以读取类中的字段并自动生成与字段名相同的类常量。比如<code>QueryScoreRequest</code>中的<code>studentId</code>变量，因为加了此注解，<code>QueryScoreRequest</code>类中会多出一个名为F的类，里面会定义<code>public static String studentId = &quot;studentId&quot;;</code>常量字段</p> <p>    🟢 Kstry框架中有req、var、sta、res四个数据域</p> <p>        🔷 <strong>req</strong>：保存请求传入的request对象，例子中便是指<code>QueryScoreRequest</code></p> <p>        🔷 <strong>var</strong>：保存节点执行完成后产生的变量。<code>QueryScoreVarScope</code>实现<code>ScopeData</code>接口，重写<code>getScopeDataEnum()</code>方法返回<code>ScopeTypeEnum.VARIABLE</code>。是以对象的形式定义了var数据域</p> <p>        🔷 <strong>sta</strong>：和var一样也是保存节点执行完成后产生的变量。只是保存后的结果不可变。可以理解成var是HasMap，sta是ImmutableMap</p> <p>        🔷 <strong>res</strong>：保存请求传入的response对象，例子中便是指<code>QueryScoreResponse</code></p> <h2 id="_1-5-编写服务组件"><a href="#_1-5-编写服务组件" class="header-anchor">#</a> 1.5 编写服务组件</h2> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@TaskComponent</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StudentScoreService</span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * 注册name为：getStudentBasic 描述信息为：查询学生基本信息 的服务节点方法
     *
     * @param id 从req域中获取变量名为studentId的值，并赋值给方法入参id
     * @return 将方法返回结果通知到var域的studentBasic变量上
     */</span>
    <span class="token annotation punctuation">@TaskService</span><span class="token punctuation">(</span>desc <span class="token operator">=</span> <span class="token string">&quot;查询学生基本信息&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@NoticeVar</span><span class="token punctuation">(</span>target <span class="token operator">=</span> <span class="token class-name">QueryScoreVarScope<span class="token punctuation">.</span>F</span><span class="token punctuation">.</span>studentBasic<span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">StudentBasic</span> <span class="token function">getStudentBasic</span><span class="token punctuation">(</span><span class="token annotation punctuation">@ReqTaskParam</span><span class="token punctuation">(</span><span class="token class-name">QueryScoreRequest<span class="token punctuation">.</span>F</span><span class="token punctuation">.</span>studentId<span class="token punctuation">)</span> <span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// mock return result</span>
        <span class="token class-name">StudentBasic</span> studentBasic <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StudentBasic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        studentBasic<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        studentBasic<span class="token punctuation">.</span><span class="token function">setAddress</span><span class="token punctuation">(</span><span class="token string">&quot;XX省XX市XX区&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        studentBasic<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">&quot;张一&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> studentBasic<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@TaskService</span><span class="token punctuation">(</span>desc <span class="token operator">=</span> <span class="token string">&quot;查询学生敏感信息&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@NoticeVar</span><span class="token punctuation">(</span>target <span class="token operator">=</span> <span class="token class-name">QueryScoreVarScope<span class="token punctuation">.</span>F</span><span class="token punctuation">.</span>studentPrivacy<span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">StudentPrivacy</span> <span class="token function">getStudentPrivacy</span><span class="token punctuation">(</span><span class="token annotation punctuation">@ReqTaskParam</span><span class="token punctuation">(</span><span class="token class-name">QueryScoreRequest<span class="token punctuation">.</span>F</span><span class="token punctuation">.</span>studentId<span class="token punctuation">)</span> <span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// mock return result</span>
        <span class="token class-name">StudentPrivacy</span> studentPrivacy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StudentPrivacy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        studentPrivacy<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        studentPrivacy<span class="token punctuation">.</span><span class="token function">setBirthday</span><span class="token punctuation">(</span><span class="token string">&quot;1994-01-01&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        studentPrivacy<span class="token punctuation">.</span><span class="token function">setIdCard</span><span class="token punctuation">(</span><span class="token string">&quot;133133199401012345&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> studentPrivacy<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@TaskService</span><span class="token punctuation">(</span>desc <span class="token operator">=</span> <span class="token string">&quot;装配学生信息&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@NoticeVar</span><span class="token punctuation">(</span>target <span class="token operator">=</span> <span class="token class-name">QueryScoreVarScope<span class="token punctuation">.</span>F</span><span class="token punctuation">.</span>student<span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Student</span> <span class="token function">assembleStudentInfo</span><span class="token punctuation">(</span><span class="token annotation punctuation">@VarTaskParam</span><span class="token punctuation">(</span><span class="token class-name">QueryScoreVarScope<span class="token punctuation">.</span>F</span><span class="token punctuation">.</span>studentBasic<span class="token punctuation">)</span> <span class="token class-name">StudentBasic</span> studentBasic<span class="token punctuation">,</span>
                                       <span class="token annotation punctuation">@VarTaskParam</span><span class="token punctuation">(</span><span class="token class-name">QueryScoreVarScope<span class="token punctuation">.</span>F</span><span class="token punctuation">.</span>studentPrivacy<span class="token punctuation">)</span> <span class="token class-name">StudentPrivacy</span> studentPrivacy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Student</span> student <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>studentBasic<span class="token punctuation">,</span> student<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>studentPrivacy<span class="token punctuation">,</span> student<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> student<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@TaskService</span><span class="token punctuation">(</span>desc <span class="token operator">=</span> <span class="token string">&quot;获取学生学年列表&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@NoticeVar</span><span class="token punctuation">(</span>target <span class="token operator">=</span> <span class="token class-name">QueryScoreVarScope<span class="token punctuation">.</span>F</span><span class="token punctuation">.</span>studyExperienceList<span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">StudyExperience</span><span class="token punctuation">&gt;</span></span> <span class="token function">getStudyExperienceList</span><span class="token punctuation">(</span><span class="token annotation punctuation">@ReqTaskParam</span><span class="token punctuation">(</span><span class="token class-name">QueryScoreRequest<span class="token punctuation">.</span>F</span><span class="token punctuation">.</span>studentId<span class="token punctuation">)</span> <span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// mock return result</span>
        <span class="token keyword">return</span> <span class="token class-name">Lists</span><span class="token punctuation">.</span><span class="token function">newArrayList</span><span class="token punctuation">(</span>
                <span class="token class-name">StudyExperience</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">studentId</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">classId</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">studyYear</span><span class="token punctuation">(</span><span class="token string">&quot;2013-1-2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token class-name">StudyExperience</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">studentId</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">classId</span><span class="token punctuation">(</span><span class="token number">2L</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">studyYear</span><span class="token punctuation">(</span><span class="token string">&quot;2014-1-2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token class-name">StudyExperience</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">studentId</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">classId</span><span class="token punctuation">(</span><span class="token number">3L</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">studyYear</span><span class="token punctuation">(</span><span class="token string">&quot;2015-1-2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 服务节点可以定义指定对数据域中的某个集合变量进行遍历执行
     *      sourceScope = ScopeTypeEnum.VARIABLE  指要对var域的变量进行遍历
     *      source = QueryScoreVarScope.F.classIds 指对var域中名为classIds的集合变量进行遍历
     *      async = true        指开启并发遍历模式
     *      strategy = IterateStrategyEnum.BEST_SUCCESS     指使用best策略遍历，best策略可以做到迭代集合中的全部项，执行失败会被忽略，将会尽量多的拿到成功项
     *
     * @param classIdItem  IterDataItem 类是框架内部类型，直接放到服务节点方法入参上，用来接收遍历项信息
     * @return @NoticeVar(target = QueryScoreVarScope.F.classInfos) 指定要将返回结果通知到var域中的classInfos变量上，classInfos变量是List类型，框架会自动将所有单个元素组合成List返回给变量
     */</span>
    <span class="token annotation punctuation">@TaskService</span><span class="token punctuation">(</span>desc <span class="token operator">=</span> <span class="token string">&quot;查询班级信息&quot;</span><span class="token punctuation">,</span>
            iterator <span class="token operator">=</span> <span class="token annotation punctuation">@Iterator</span><span class="token punctuation">(</span>sourceScope <span class="token operator">=</span> <span class="token class-name">ScopeTypeEnum</span><span class="token punctuation">.</span>VARIABLE<span class="token punctuation">,</span> source <span class="token operator">=</span> <span class="token class-name">QueryScoreVarScope<span class="token punctuation">.</span>F</span><span class="token punctuation">.</span>classIds<span class="token punctuation">,</span> async <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> strategy <span class="token operator">=</span> <span class="token class-name">IterateStrategyEnum</span><span class="token punctuation">.</span>BEST_SUCCESS<span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
    <span class="token annotation punctuation">@NoticeVar</span><span class="token punctuation">(</span>target <span class="token operator">=</span> <span class="token class-name">QueryScoreVarScope<span class="token punctuation">.</span>F</span><span class="token punctuation">.</span>classInfos<span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">ClassInfo</span> <span class="token function">getClasInfoById</span><span class="token punctuation">(</span><span class="token class-name">IterDataItem</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> classIdItem<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// mock return result</span>
        <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> idOptional <span class="token operator">=</span> classIdItem<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ClassInfo</span> classInfo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        classInfo<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>idOptional<span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        classInfo<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">&quot;班级&quot;</span> <span class="token operator">+</span> idOptional<span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> classInfo<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@TaskService</span><span class="token punctuation">(</span>desc <span class="token operator">=</span> <span class="token string">&quot;查询学生分数列表&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@NoticeVar</span><span class="token punctuation">(</span>target <span class="token operator">=</span> <span class="token class-name">QueryScoreVarScope<span class="token punctuation">.</span>F</span><span class="token punctuation">.</span>scoreInfos<span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ScoreInfo</span><span class="token punctuation">&gt;</span></span> <span class="token function">getStudentScoreList</span><span class="token punctuation">(</span><span class="token annotation punctuation">@VarTaskParam</span><span class="token punctuation">(</span><span class="token class-name">QueryScoreVarScope<span class="token punctuation">.</span>F</span><span class="token punctuation">.</span>studyExperienceList<span class="token punctuation">)</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">StudyExperience</span><span class="token punctuation">&gt;</span></span> studyExperienceList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// mock return result</span>
        <span class="token keyword">return</span> studyExperienceList<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span>se <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ScoreInfo</span><span class="token punctuation">&gt;</span></span> scoreInfos <span class="token operator">=</span> <span class="token class-name">Lists</span><span class="token punctuation">.</span><span class="token function">newArrayList</span><span class="token punctuation">(</span>
                    <span class="token class-name">ScoreInfo</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">studentId</span><span class="token punctuation">(</span>se<span class="token punctuation">.</span><span class="token function">getStudentId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">classId</span><span class="token punctuation">(</span>se<span class="token punctuation">.</span><span class="token function">getClassId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">studyYear</span><span class="token punctuation">(</span>se<span class="token punctuation">.</span><span class="token function">getStudyYear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">course</span><span class="token punctuation">(</span><span class="token string">&quot;语文&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">score</span><span class="token punctuation">(</span><span class="token number">99</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token class-name">ScoreInfo</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">studentId</span><span class="token punctuation">(</span>se<span class="token punctuation">.</span><span class="token function">getStudentId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">classId</span><span class="token punctuation">(</span>se<span class="token punctuation">.</span><span class="token function">getClassId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">studyYear</span><span class="token punctuation">(</span>se<span class="token punctuation">.</span><span class="token function">getStudyYear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">course</span><span class="token punctuation">(</span><span class="token string">&quot;数学&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">score</span><span class="token punctuation">(</span><span class="token number">88</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> scoreInfos<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@TaskService</span><span class="token punctuation">(</span>desc <span class="token operator">=</span> <span class="token string">&quot;组装成绩及班级信息&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">assembleScoreClassInfo</span><span class="token punctuation">(</span><span class="token annotation punctuation">@VarTaskParam</span><span class="token punctuation">(</span><span class="token class-name">QueryScoreVarScope<span class="token punctuation">.</span>F</span><span class="token punctuation">.</span>scoreInfos<span class="token punctuation">)</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ScoreInfo</span><span class="token punctuation">&gt;</span></span> scoreInfos<span class="token punctuation">,</span>
                                       <span class="token annotation punctuation">@VarTaskParam</span><span class="token punctuation">(</span><span class="token class-name">QueryScoreVarScope<span class="token punctuation">.</span>F</span><span class="token punctuation">.</span>classInfos<span class="token punctuation">)</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ClassInfo</span><span class="token punctuation">&gt;</span></span> classInfos<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">ClassInfo</span><span class="token punctuation">&gt;</span></span> classInfoMap <span class="token operator">=</span> classInfos<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toMap</span><span class="token punctuation">(</span><span class="token class-name">ClassInfo</span><span class="token operator">::</span><span class="token function">getId</span><span class="token punctuation">,</span> <span class="token class-name">Function</span><span class="token punctuation">.</span><span class="token function">identity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> y<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        scoreInfos<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>scoreInfo <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">ClassInfo</span> classInfo <span class="token operator">=</span> classInfoMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>scoreInfo<span class="token punctuation">.</span><span class="token function">getClassId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>classInfo <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            scoreInfo<span class="token punctuation">.</span><span class="token function">setClassInfo</span><span class="token punctuation">(</span>classInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@NoticeResult</span>
    <span class="token annotation punctuation">@TaskService</span><span class="token punctuation">(</span>desc <span class="token operator">=</span> <span class="token string">&quot;各维度信息聚合&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">QueryScoreResponse</span> <span class="token function">getQueryScoreResponse</span><span class="token punctuation">(</span><span class="token annotation punctuation">@VarTaskParam</span><span class="token punctuation">(</span><span class="token class-name">QueryScoreVarScope<span class="token punctuation">.</span>F</span><span class="token punctuation">.</span>student<span class="token punctuation">)</span> <span class="token class-name">Student</span> student<span class="token punctuation">,</span>
                                                    <span class="token annotation punctuation">@VarTaskParam</span><span class="token punctuation">(</span><span class="token class-name">QueryScoreVarScope<span class="token punctuation">.</span>F</span><span class="token punctuation">.</span>scoreInfos<span class="token punctuation">)</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ScoreInfo</span><span class="token punctuation">&gt;</span></span> scoreInfos<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">QueryScoreResponse</span> response <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QueryScoreResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        response<span class="token punctuation">.</span><span class="token function">setStudent</span><span class="token punctuation">(</span>student<span class="token punctuation">)</span><span class="token punctuation">;</span>
        response<span class="token punctuation">.</span><span class="token function">setScoreInfos</span><span class="token punctuation">(</span>scoreInfos<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> response<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br></div></div><p><strong><code>@TaskComponent</code>作用：</strong></p> <p>    🟢 与 Spring 容器中<code>@Component</code>注解有着相同的作用，将被标注的类组件托管至Spring容器中</p> <p>    🟢 指定该类成为了 Kstry 容器可解析的任务组件，可在其中定义服务节点（被<code>@TaskService</code>注解修饰的方法称为<strong>服务节点</strong>）</p> <p>        🔷 <code>name</code>：指定组件名称，与 bpmn 流程配置文件中<code>task-component</code>属性对应，默认为首字母小写的类名</p> <p><strong><code>@TaskService</code>作用：</strong></p> <p>    🟢 指定该方法是Kstry容器中的服务节点，也是在bpmn配置文件中可编排的最小执行单元，对应于bpmn配置文件中的<code>bpmn:serviceTask</code>节点</p> <p>    🟢 该注解只能定义在Kstry容器可解析的任务组件类中，否则将不被解析</p> <p>        🔷 <code>name</code>：指定该服务节点的名称，与 bpmn 配置文件中的<code>task-service</code>属性进行匹配对应，默认为方法名</p> <p>        🔷 <code>desc</code>：节点描述信息。流程配置中未指定节点名称时，尝试获取<code>@TaskService</code>注解的<code>desc</code>属性作为name</p> <p>        🔷 <code>iterator</code>：指定遍历信息，可以参考上面代码中的注释，也可跳转至后面的文档了解资源遍历功能详情</p> <p><strong><code>@NoticeResult</code>作用：</strong></p> <p>    🟢 指定执行结果将被通知到StoryBus中的哪些作用域中，<code>@NoticeResult</code>说明，该方法执行结果将被通知到result域，最终作为Story的执行结果返回给调用方</p> <p><strong><code>@VarTaskParam</code>作用：</strong></p> <p>    🟢 <code>@VarTaskParam</code>标注在服务节点的方法参数上，用来从StoryBus的var域获取变量值，并直接赋值给被标注的参数项</p> <p><strong><code>@ReqTaskParam</code>作用：</strong></p> <p>    🟢 <code>@ReqTaskParam</code>标注在服务节点的方法参数上，用来从StoryBus的req域获取变量值，并直接赋值给被标注的参数项</p> <p>        🔷 <code>reqSelf</code>：只有从req域获取参数时才有这个属性，该属性代表将客户端传入的request对象直接赋值给被标注的参数项</p> <h2 id="_1-6-定义服务流程"><a href="#_1-6-定义服务流程" class="header-anchor">#</a> 1.6 定义服务流程</h2> <p>    框架支持BPMN、JSON、代码三种文件格式的流程定义。其中BPMN、JSON两种格式可以通过文件放入resources目录、项目启动时解析注册、程序运行时动态修改三种方式来注册使用。三种注册方式后面文档会详细介绍，当前将分别介绍如何通过三种不同的文件格式来定义上述流程。目前来讲，BPMN、JSON两种文件定义流程时，只需知道将流程配置文件放到resources目录并配置<code>@EnableKstry(bpmnPath = &quot;./bpmn/*.bpmn,./bpmn/*.json&quot;)</code>使启动类可以解析到即可。</p> <h3 id="_1-6-1-bpmn格式定义流程"><a href="#_1-6-1-bpmn格式定义流程" class="header-anchor">#</a> 1.6.1 BPMN格式定义流程</h3> <p>    业务流程建模符号BPMN(Business Process Modeling Notation)是BPMI(The Business Process Management Initiative)开发的一套可视化流程建模标准(BPMN)。其主要目标是提供一些被所有业务用户容易理解的符号，拼装组合成流程图，进而使相关方可以简单直观的从流程的轮廓分析到这些流程的业务实现。Kstry框架支持了部分BPMN符号语法，可以极为方便的完成系统中复杂业务的可视化流程定义。并提供了流程配置控制台：<a href="http://kstry.cn/modeler/" target="_blank" rel="noopener noreferrer">配置台地址<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a data-fancybox="" title="查询学生信息流程定义" href="../img2/e25009a28fddcdeed786aff92a414151.png"><img src="/assets/img/e25009a28fddcdeed786aff92a414151.ec6f83fc.png" alt="image-WX20230926"></a></p> <p>    在配置台中定义如上流程（<a href="http://" target="_blank" rel="noopener noreferrer">流程文件地址<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>），如下所示可将定义好的流程复制到粘贴板。之后在项目的<code>resources/bpmn/</code>路径下创建扩展名为<code>.bpmn</code>的文件并将粘贴板的内容复制进文件内。比如定义文件名：<code>student-score-query-process.bpmn</code></p> <p><a data-fancybox="" title="将文件复制到粘贴板示意图" href="../img2/286065efa03a6a2cc4531e6dc3dd7e17.png"><img src="/assets/img/286065efa03a6a2cc4531e6dc3dd7e17.c34eb498.png" alt="image-WX20230926"></a></p> <p>    上面的流程可以看出，BPMN文件虽然可以展示流程图但并非是图片文件，而是文本文件。而在文本文件中也是多由XML文件的格式来表示。流程文件被定义出来之后便可以通过引擎解析执行了。下面是介绍上述流程图中的一些配置细节。</p> <p><a data-fancybox="" title="定义服务节点" href="../img2/3058c865359fd9b4b6bb4d6a71dda682.png"><img src="/assets/img/3058c865359fd9b4b6bb4d6a71dda682.914f46f9.png" alt="image-WX20230926"></a></p> <p>    上图展示了定义 <em>查询学生基本信息</em> 服务节点的配置。<code>task-component</code>的值与服务组件名即代码中的类名相对应（name属性为空时默认取的是类名首字母小写），<code>task-service</code>的值与服务节点方法即代码中的方法名相对应。当<code>task-service</code>的值在当前应用中全局唯一时，<code>task-component</code>属性值允许为空。如此配置便可以将流程配置文件中的服务节点与代码中的方法进行关联。流程执行时每执行到某个节点时实际在代码中会调用与之相对应的方法。</p> <p><a data-fancybox="" title="包含网关开启并发" href="../img2/ec376c940db47622997d830abcdd57ad.png"><img src="/assets/img/ec376c940db47622997d830abcdd57ad.9ec76de9.png" alt="image-WX20230926"></a></p> <p>    当需要同时执行多个耗时操作并且操作之间没有前后依赖关系时，可采用并发执行的手段来加快拿到响应结果的时间。框架支持在包含网关、并行网关两个网关上增加<code>open-async=true</code>配置的方式开启后面多流程执行的并发。可见从串行变为并行的升级成本是极低的。</p> <p><a data-fancybox="" title="流程中使用表达式" href="../img2/f76112d617fe69bb052db0df7120a471.png"><img src="/assets/img/f76112d617fe69bb052db0df7120a471.79ba0687.png" alt="image-WX20230926"></a></p> <p>    上述查询学生信息的例子中仅需学生成绩信息时才需要下半部分的查询动作。框架支持在流程线段上定义条件表达式来判断和控制后续的流程是否需要执行。表达式通过SpringSpEL引擎解析执行。不仅支持类似<code>var.student.age&gt;20</code>这种普通表达式判断，还支持<code>@notBlank(var.student.name)</code>这种常用函数，甚至在给定函数不满足业务诉求是还支持自定义函数来丰富条件表达式的判断，需要了解自定义函数细节可跳转至下面流程编排部分。</p> <p><a data-fancybox="" title="流程中使用指令" href="../img2/d9e72d44e893680e22eae5c1e2475f48.png"><img src="/assets/img/d9e72d44e893680e22eae5c1e2475f48.512b0c92.png" alt="image-WX20230926"></a></p> <p>    上述流程中有一个细节，<em>获取学生学年列表</em> 服务节点方法返回通知到var数据域的是一个<code>List&lt;StudyExperience&gt; studyExperienceList</code>变量值。而在后续 <em>查询班级信息</em> 服务节点方法中遍历的是<code>var.classIds</code>。那么<code>var.classIds</code>这个值是从哪里来的呢，这里就用到了框架提供的指令能力。<br>
    内部实现中指令其实就是服务节点，之所以以指令的形式存在是为了方便框架用户抽象一些公用方法，在核心服务方法执行前后做一些所需的数据处理。比如上述例子中<code>studyExperienceList</code>到<code>classIds</code>的转化就用到了框架自带的<code>c-jscript</code>指令。该指令的功能是通过解析执行流程定义中的js脚本来操作各域中的数据。下面是具体的使用方式：</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token comment">// task-property属性设置</span>
<span class="token punctuation">{</span>
    <span class="token property">&quot;result-converter&quot;</span><span class="token operator">:</span> <span class="token string">&quot;object_to_long_list&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;return-target&quot;</span><span class="token operator">:</span> <span class="token string">&quot;var.classIds&quot;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// c-jscript指令Content</span>
<span class="token keyword">var</span> classIds <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span> kvar<span class="token punctuation">.</span>studyExperienceList<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    classIds<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>kvar<span class="token punctuation">.</span>studyExperienceList<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>classId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">return</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>classIds<span class="token punctuation">)</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>    在 <em>获取学生学年列表</em> 服务节点执行完成之后，因为配置了<code>c-jscript</code>后置指令所以会进入到指令中执行。指令脚本会从<code>studyExperienceList</code>中依次取出<code>classId</code>放到新定义的<code>classIds</code>中并序列化成String返回。又因为<code>task-property</code>中指定了<code>object_to_long_list</code>类型转换器，将String类型转换成为<code>List&lt;Long&gt;</code>类型，最终将转换后的结果通知到var域的<code>classIds</code>变量中。这里只是简单介绍下各个功能点的使用场景，对于<code>task-property</code>属性作用、指令、类型转换器等可在后续文档中看到详细介绍。</p> <h3 id="_1-6-2-json格式定义流程"><a href="#_1-6-2-json格式定义流程" class="header-anchor">#</a> 1.6.2 JSON格式定义流程</h3> <p>    JSON格式是一种极简的流程定义方式。与BPMN格式相比优势在于小文件时简单易懂、容易转换生成、占用空间小易于传输等。而略势也很明显，最重要的便是彻底失去了可视化的能力，流程节点多了之后阅读起来将会非常困难。那么框架支持JSON格式流程定义的意义是什么呢？</p> <p>    支持JSON格式流程定义的最重要的原因就是其容易转换生成的特点。可视化流程配置工具层出不穷，各种开源也是争奇斗艳。BPMN格式仅仅是这众多工具中的一种，因为历史遗留、公司要求、接入成本等众多因素影响，不可能要求所有使用者都将BPMN作为流程配置的首选。为了满足更多用户的不同诉求，就需要一种中间协议。可以将各种流程配置文件转换成这种中间协议，以供框架来理解和执行，无疑JSON格式是一个很好的选择。有了这层协议无论使用者使用了何种可视化流程配置工具，都可以借此被Kstry框架所理解和执行。</p> <p>    下面是对上述 <em>学生信息查询流程</em> 的JSON格式定义描述：</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">[</span><span class="token punctuation">{</span>
  <span class="token property">&quot;process-id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Process_1693841776073&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;start-id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;student-score-query-json-process&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;process-nodes&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
    <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;student-score-query-json-process&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;student-score-query-json-process&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;next-nodes&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;Gateway_0moclik&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;start_event&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Gateway_0moclik&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;next-nodes&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;Activity_1tuuink&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Activity_1lzcrrr&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Flow_1jmfkgr&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">&quot;properties&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;open-async&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token comment">// 开启并发</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;inclusive_gateway&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Activity_1tuuink&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;查询学生\n基本信息&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;next-nodes&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;Gateway_0avnapl&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">&quot;properties&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;task-component&quot;</span><span class="token operator">:</span> <span class="token string">&quot;studentScoreService&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;task-service&quot;</span><span class="token operator">:</span> <span class="token string">&quot;getStudentBasic&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;service_task&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Activity_1lzcrrr&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;查询学生\n敏感信息&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;next-nodes&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;Gateway_0avnapl&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">&quot;properties&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;task-component&quot;</span><span class="token operator">:</span> <span class="token string">&quot;studentScoreService&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;task-service&quot;</span><span class="token operator">:</span> <span class="token string">&quot;getStudentPrivacy&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;service_task&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Gateway_0avnapl&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;next-nodes&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;Activity_1x55mgq&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">&quot;properties&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;inclusive_gateway&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Activity_1x55mgq&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;装配学生信息&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;next-nodes&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;Gateway_02qlo7f&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">&quot;properties&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;task-component&quot;</span><span class="token operator">:</span> <span class="token string">&quot;studentScoreService&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;task-service&quot;</span><span class="token operator">:</span> <span class="token string">&quot;assembleStudentInfo&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;service_task&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;flow-expression&quot;</span><span class="token operator">:</span> <span class="token string">&quot;req.needScore&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 流程线段上定义条件表达式</span>
    <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Flow_1jmfkgr&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;if（need-score-list）&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;next-nodes&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;Activity_0q5ad88&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;sequence_flow&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Activity_0q5ad88&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;获取学生\n学年列表&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;next-nodes&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;Gateway_0qmo5am&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">&quot;properties&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;task-service&quot;</span><span class="token operator">:</span> <span class="token string">&quot;getStudyExperienceList&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 使用指令</span>
      <span class="token property">&quot;c-jscript&quot;</span><span class="token operator">:</span> <span class="token string">&quot;var classIds = [];\nfor (var i = 0; i&lt; kvar.studyExperienceList.length; i++)\n{\n    classIds.push(kvar.studyExperienceList[i].classId);\n}\nreturn JSON.stringify(classIds)&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;task-property&quot;</span><span class="token operator">:</span> <span class="token string">&quot;{\n    \&quot;result-converter\&quot;: \&quot;object_to_long_list\&quot;,\n    \&quot;return-target\&quot;: \&quot;var.classIds\&quot;\n}&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;service_task&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Gateway_0qmo5am&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;next-nodes&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;Activity_1h1otxv&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Activity_1v1y60m&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">&quot;properties&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;open-async&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token comment">// 开启并发</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;inclusive_gateway&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Activity_1h1otxv&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;查询班级信息&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;next-nodes&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;Gateway_0t2t6ox&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">&quot;properties&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;task-service&quot;</span><span class="token operator">:</span> <span class="token string">&quot;getClasInfoById&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;service_task&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Activity_1v1y60m&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;查询学生\n分数列表&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;next-nodes&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;Gateway_0t2t6ox&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">&quot;properties&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;task-service&quot;</span><span class="token operator">:</span> <span class="token string">&quot;getStudentScoreList&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;service_task&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Gateway_0t2t6ox&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;next-nodes&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;Activity_0itm6m7&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">&quot;properties&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;strict-mode&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span> <span class="token comment">// 指定并行网关为非严格模式</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;parallel_gateway&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Activity_0itm6m7&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;组装历年成绩列表&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;next-nodes&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;Gateway_02qlo7f&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">&quot;properties&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;task-service&quot;</span><span class="token operator">:</span> <span class="token string">&quot;assembleScoreClassInfo&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;service_task&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Gateway_02qlo7f&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;next-nodes&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;Activity_0n1ystm&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">&quot;properties&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;inclusive_gateway&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Activity_0n1ystm&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;各维度信息聚合&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;next-nodes&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;2e5a5716e4404ca6843abffb807e23b3&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">&quot;properties&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;task-service&quot;</span><span class="token operator">:</span> <span class="token string">&quot;getQueryScoreResponse&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;service_task&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2e5a5716e4404ca6843abffb807e23b3&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;next-nodes&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;end_event&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br></div></div><h3 id="_1-6-3-代码方式定义流程"><a href="#_1-6-3-代码方式定义流程" class="header-anchor">#</a> 1.6.3 代码方式定义流程</h3> <p>    无论是BPMN格式还是JSON格式，在代码开发工具比如eclipse、IDEA中如果没有很好的插件支持，配置文件与代码便是割裂的。使用两种格式的配置文件时，在开发工具中各个服务节点方法之间将不存在任何关联和引用。这样会导致一些问题，比如仅仅只看代码是不知道业务如何实现的、开发过程中不能像传统方法一样通过快捷键在相互引用的方法之间快速跳转等，由此框架还支持了代码方式定义流程。</p> <p>    可以自定义方法返回<code>ProcessLink</code>或者<code>SubProcessLink</code>来定义流程和子流程。方法上标注@Bean注解将流程对象放入Spring容器中即可在执行时生效。当流程复杂不易阅读时还可以通过抽离子流程的方式将整个大流程分层成不同的子流程来帮助规划和理解。</p> <p>    服务节点方法可以作为lambda表达式的形式参与进整个流程的组装，解决了各个服务节点方法之间不存在任何关联和引用的问题，可以在开发工具中使用快捷键快速跳转。熟悉代码方式的流程定义后，阅读整个流程时虽然比不上BPMN可视化那样简洁明了，但理解起来也一定比没有任何模块划分一气呵成的代码方便不少。</p> <p>    另外无论是BPMN格式文件还是JSON格式文件，最终都是用代码流程定义的方式来解析生效的。所以使用其他协议的流程配置工具时也可以跳过JSON格式的转化，直接用代码方式解析生成流程。</p> <p>    下面是对上述 <em>学生信息查询流程</em> 的代码方式定义描述：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">ProcessLink</span> <span class="token function">studentScoreQueryProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> instructContent <span class="token operator">=</span> <span class="token string">&quot;var classIds = [];&quot;</span>
            <span class="token operator">+</span> <span class="token string">&quot;for (var i = 0; i&lt; kvar.studyExperienceList.length; i++)&quot;</span>
            <span class="token operator">+</span> <span class="token string">&quot;{&quot;</span>
            <span class="token operator">+</span> <span class="token string">&quot;    classIds.push(kvar.studyExperienceList[i].classId);&quot;</span>
            <span class="token operator">+</span> <span class="token string">&quot;}&quot;</span>
            <span class="token operator">+</span> <span class="token string">&quot;return JSON.stringify(classIds)&quot;</span><span class="token punctuation">;</span>
    <span class="token class-name">StartProcessLink</span> processLink <span class="token operator">=</span> <span class="token class-name">StartProcessLink</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token class-name">DefProcess</span><span class="token operator">::</span><span class="token function">studentScoreQueryProcess</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">InclusiveJoinPoint</span> asyncInclusive <span class="token operator">=</span> processLink<span class="token punctuation">.</span><span class="token function">nextInclusive</span><span class="token punctuation">(</span>processLink<span class="token punctuation">.</span><span class="token function">inclusive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">openAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">InclusiveJoinPoint</span> asyncInclusive2 <span class="token operator">=</span> asyncInclusive
            <span class="token punctuation">.</span><span class="token function">nextService</span><span class="token punctuation">(</span><span class="token class-name">Exp</span><span class="token punctuation">.</span><span class="token function">b</span><span class="token punctuation">(</span>e <span class="token operator">-&gt;</span> e<span class="token punctuation">.</span><span class="token function">isTrue</span><span class="token punctuation">(</span><span class="token class-name">ScopeTypeEnum</span><span class="token punctuation">.</span>REQUEST<span class="token punctuation">,</span> <span class="token class-name">QueryScoreRequest<span class="token punctuation">.</span>F</span><span class="token punctuation">.</span>needScore<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">StudentScoreService</span><span class="token operator">::</span><span class="token function">getStudyExperienceList</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">nextInstruct</span><span class="token punctuation">(</span><span class="token string">&quot;jscript&quot;</span><span class="token punctuation">,</span> instructContent<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token string">&quot;JS脚本&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">property</span><span class="token punctuation">(</span><span class="token string">&quot;{\&quot;result-converter\&quot;: \&quot;object_to_long_list\&quot;,\&quot;return-target\&quot;: \&quot;var.classIds\&quot;}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">nextInclusive</span><span class="token punctuation">(</span>processLink<span class="token punctuation">.</span><span class="token function">inclusive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">openAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    processLink<span class="token punctuation">.</span><span class="token function">inclusive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">joinLinks</span><span class="token punctuation">(</span>
                    processLink<span class="token punctuation">.</span><span class="token function">parallel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">notStrictMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">joinLinks</span><span class="token punctuation">(</span>
                            asyncInclusive2<span class="token punctuation">.</span><span class="token function">nextService</span><span class="token punctuation">(</span><span class="token class-name">StudentScoreService</span><span class="token operator">::</span><span class="token function">getClasInfoById</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            asyncInclusive2<span class="token punctuation">.</span><span class="token function">nextService</span><span class="token punctuation">(</span><span class="token class-name">StudentScoreService</span><span class="token operator">::</span><span class="token function">getStudentScoreList</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextService</span><span class="token punctuation">(</span><span class="token class-name">StudentScoreService</span><span class="token operator">::</span><span class="token function">assembleScoreClassInfo</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    processLink<span class="token punctuation">.</span><span class="token function">inclusive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">joinLinks</span><span class="token punctuation">(</span>
                            asyncInclusive<span class="token punctuation">.</span><span class="token function">nextService</span><span class="token punctuation">(</span><span class="token class-name">StudentScoreService</span><span class="token operator">::</span><span class="token function">getStudentBasic</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            asyncInclusive<span class="token punctuation">.</span><span class="token function">nextService</span><span class="token punctuation">(</span><span class="token class-name">StudentScoreService</span><span class="token operator">::</span><span class="token function">getStudentPrivacy</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextService</span><span class="token punctuation">(</span><span class="token class-name">StudentScoreService</span><span class="token operator">::</span><span class="token function">assembleStudentInfo</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">nextService</span><span class="token punctuation">(</span><span class="token class-name">StudentScoreService</span><span class="token operator">::</span><span class="token function">getQueryScoreResponse</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> processLink<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><h2 id="_1-7-调用执行"><a href="#_1-7-调用执行" class="header-anchor">#</a> 1.7 调用执行</h2> <p>    框架的执行依托于StoryEngine对象，该对象会随着框架初始化进程被托管至Spring容器中。所以使用起来会很方便，只需按照普通Spring Bean的方式注入即可。StoryEngine对象有三个方法，<code>fire</code>、<code>fireAsync</code>、<code>serialize</code>所实现功能分别是同步执行流程、异步执行流程、将容器中的流程序列化成JSON。</p> <h3 id="_1-7-1-同步方式调用执行"><a href="#_1-7-1-同步方式调用执行" class="header-anchor">#</a> 1.7.1 同步方式调用执行</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/student&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StudentController</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">StoryEngine</span> storyEngine<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/query&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">R</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">QueryScoreResponse</span><span class="token punctuation">&gt;</span></span> <span class="token function">studentQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">QueryScoreRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QueryScoreRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        request<span class="token punctuation">.</span><span class="token function">setStudentId</span><span class="token punctuation">(</span><span class="token number">77L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        request<span class="token punctuation">.</span><span class="token function">setNeedScore</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">StoryRequest</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">QueryScoreResponse</span><span class="token punctuation">&gt;</span></span> fireRequest <span class="token operator">=</span> <span class="token class-name">ReqBuilder</span>
                <span class="token punctuation">.</span><span class="token function">returnType</span><span class="token punctuation">(</span><span class="token class-name">QueryScoreResponse</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token comment">// 指定返回类型</span>
                <span class="token punctuation">.</span><span class="token function">recallStoryHook</span><span class="token punctuation">(</span><span class="token class-name">WebUtil</span><span class="token operator">::</span><span class="token function">recallStoryHook</span><span class="token punctuation">)</span> <span class="token comment">// 流程结束的回溯</span>
                <span class="token punctuation">.</span><span class="token function">trackingType</span><span class="token punctuation">(</span><span class="token class-name">TrackingTypeEnum</span><span class="token punctuation">.</span>SERVICE_DETAIL<span class="token punctuation">)</span> <span class="token comment">// 指定监控类型</span>
                <span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span> <span class="token comment">// 指定req域参数</span>
                <span class="token punctuation">.</span><span class="token function">varScopeData</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">QueryScoreVarScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 指定var域数据载体，可不指定使用默认值</span>
                <span class="token punctuation">.</span><span class="token function">startId</span><span class="token punctuation">(</span><span class="token string">&quot;student-score-query-process&quot;</span><span class="token punctuation">)</span> <span class="token comment">// 指定开始事件ID</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">TaskResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">QueryScoreResponse</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> storyEngine<span class="token punctuation">.</span><span class="token function">fire</span><span class="token punctuation">(</span>fireRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">.</span><span class="token function">isSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token class-name">R</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token class-name">R</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token class-name">NumberUtils</span><span class="token punctuation">.</span><span class="token function">toInt</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getResultCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> result<span class="token punctuation">.</span><span class="token function">getResultDesc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@NoArgsConstructor</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">R</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">boolean</span> success<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">Integer</span> code<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> msg<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">T</span> data<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">D</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">R</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">D</span><span class="token punctuation">&gt;</span></span> <span class="token function">success</span><span class="token punctuation">(</span><span class="token class-name">D</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">R</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">D</span><span class="token punctuation">&gt;</span></span> res <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">R</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        res<span class="token punctuation">.</span><span class="token function">setSuccess</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        res<span class="token punctuation">.</span><span class="token function">setCode</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        res<span class="token punctuation">.</span><span class="token function">setMsg</span><span class="token punctuation">(</span><span class="token string">&quot;success&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        res<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> res<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">D</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">R</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">D</span><span class="token punctuation">&gt;</span></span> <span class="token function">error</span><span class="token punctuation">(</span><span class="token keyword">int</span> code<span class="token punctuation">,</span> <span class="token class-name">String</span> desc<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">R</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">D</span><span class="token punctuation">&gt;</span></span> res <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">R</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        res<span class="token punctuation">.</span><span class="token function">setCode</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
        res<span class="token punctuation">.</span><span class="token function">setMsg</span><span class="token punctuation">(</span>desc<span class="token punctuation">)</span><span class="token punctuation">;</span>
        res<span class="token punctuation">.</span><span class="token function">setSuccess</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> res<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WebUtil</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">recallStoryHook</span><span class="token punctuation">(</span><span class="token class-name">RecallStory</span> recallStory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">MonitorTracking</span> monitorTracking <span class="token operator">=</span> recallStory<span class="token punctuation">.</span><span class="token function">getMonitorTracking</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">NodeTracking</span><span class="token punctuation">&gt;</span></span> storyTracking <span class="token operator">=</span> monitorTracking<span class="token punctuation">.</span><span class="token function">getStoryTracking</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> collect <span class="token operator">=</span> storyTracking<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>nt <span class="token operator">-&gt;</span> <span class="token class-name">GlobalUtil</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;{}({}ms)&quot;</span><span class="token punctuation">,</span> nt<span class="token punctuation">.</span><span class="token function">getNodeName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nt<span class="token punctuation">.</span><span class="token function">getSpendTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Story startId: {}, service node spend list: {}&quot;</span><span class="token punctuation">,</span> recallStory<span class="token punctuation">.</span><span class="token function">getStartId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">,</span> collect<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br></div></div><p>    StoryRequest是执行流程的入参，包含了全部所需的参数。样例中<code>recallStoryHook</code>的作用是在流程执行完之后无论成功或是失败都会进行一次回调，回调函数使用RecallStory作为入参，可获取：各个作用域变量、角色、最终返回结果、链路追踪器等。在上述样例中指定了<code>WebUtil::recallStoryHook</code>作用是打印各个服务节点的执行耗时。比如：</p> <div class="language-log line-numbers-mode"><pre class="language-log"><code><span class="token property">Story startId:</span> student<span class="token operator">-</span>score<span class="token operator">-</span>query<span class="token operator">-</span>process<span class="token punctuation">,</span> service node spend list<span class="token operator">:</span> 查询学生敏感信息<span class="token operator">(</span><span class="token number">0ms</span><span class="token operator">)</span><span class="token punctuation">,</span>查询学生基本信息<span class="token operator">(</span><span class="token number">0ms</span><span class="token operator">)</span><span class="token punctuation">,</span>获取学生学年列表<span class="token operator">(</span><span class="token number">0ms</span><span class="token operator">)</span><span class="token punctuation">,</span>JS脚本<span class="token operator">(</span><span class="token number">12ms</span><span class="token operator">)</span><span class="token punctuation">,</span>装配学生信息<span class="token operator">(</span><span class="token number">0ms</span><span class="token operator">)</span><span class="token punctuation">,</span>查询学生分数列表<span class="token operator">(</span><span class="token number">0ms</span><span class="token operator">)</span><span class="token punctuation">,</span>查询班级信息<span class="token operator">(</span><span class="token number">0ms</span><span class="token operator">)</span><span class="token punctuation">,</span>组装历年成绩列表<span class="token operator">(</span><span class="token number">0ms</span><span class="token operator">)</span><span class="token punctuation">,</span>各维度信息聚合<span class="token operator">(</span><span class="token number">0ms</span><span class="token operator">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>    另一个需要简单介绍下的是<code>trackingType</code>用来指定链路追踪级别。<code>SERVICE_DETAIL</code>的含义是打印各个服务节点执行时的细节详情。比如下面是 <em>装配学生信息</em> 服务节点的执行信息</p> <div class="language-log line-numbers-mode"><pre class="language-log"><code><span class="token operator">{</span>
  <span class="token string">&quot;endTime&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2023-09-30T17:42:53.752762000&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;index&quot;</span><span class="token operator">:</span> <span class="token number">16</span><span class="token punctuation">,</span>
  <span class="token string">&quot;methodName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;assembleStudentInfo&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;nodeId&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Activity_1x55mgq-12&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;nodeName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;装配学生信息&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;nodeType&quot;</span><span class="token operator">:</span> <span class="token string">&quot;SERVICE_TASK&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;noticeTracking&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token operator">{</span>    <span class="token operator">/</span><span class="token operator">/</span> 通知到var域的数据信息
    <span class="token string">&quot;converter&quot;</span><span class="token operator">:</span> <span class="token string">&quot;BASIC_CONVERTER&quot;</span><span class="token punctuation">,</span> <span class="token operator">/</span><span class="token operator">/</span> 使用到的类型转换器名称
    <span class="token string">&quot;scopeType&quot;</span><span class="token operator">:</span> <span class="token string">&quot;VARIABLE&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;sourceName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;student&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;targetName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;student&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;targetType&quot;</span><span class="token operator">:</span> <span class="token string">&quot;cn.kstry.flux.demo.facade.student.QueryScoreVarScope&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;value&quot;</span><span class="token operator">:</span> <span class="token string">&quot;{\&quot;address\&quot;:\&quot;XX省XX市XX区\&quot;,\&quot;birthday\&quot;:\&quot;1994-01-01\&quot;,\&quot;id\&quot;:77,\&quot;idCard\&quot;:\&quot;133133199401012345\&quot;,\&quot;name\&quot;:\&quot;张一\&quot;}&quot;</span>
  <span class="token operator">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token string">&quot;paramTracking&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token operator">{</span>   <span class="token operator">/</span><span class="token operator">/</span> 服务节点方法执行入参信息
    <span class="token string">&quot;scopeType&quot;</span><span class="token operator">:</span> <span class="token string">&quot;VARIABLE&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;sourceName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;studentBasic&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;targetName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;studentBasic&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;targetType&quot;</span><span class="token operator">:</span> <span class="token string">&quot;cn.kstry.flux.demo.dto.student.StudentBasic&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;value&quot;</span><span class="token operator">:</span> <span class="token string">&quot;{\&quot;address\&quot;:\&quot;XX省XX市XX区\&quot;,\&quot;id\&quot;:77,\&quot;name\&quot;:\&quot;张一\&quot;}&quot;</span>
  <span class="token operator">}</span><span class="token punctuation">,</span> <span class="token operator">{</span>
    <span class="token string">&quot;scopeType&quot;</span><span class="token operator">:</span> <span class="token string">&quot;VARIABLE&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;sourceName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;studentPrivacy&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;targetName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;studentPrivacy&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;targetType&quot;</span><span class="token operator">:</span> <span class="token string">&quot;cn.kstry.flux.demo.dto.student.StudentPrivacy&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;value&quot;</span><span class="token operator">:</span> <span class="token string">&quot;{\&quot;birthday\&quot;:\&quot;1994-01-01\&quot;,\&quot;id\&quot;:77,\&quot;idCard\&quot;:\&quot;133133199401012345\&quot;}&quot;</span>
  <span class="token operator">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token string">&quot;spendTime&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token string">&quot;startTime&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2023-09-30T17:42:53.752442000&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;targetName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;cn.kstry.flux.demo.service.student.StudentScoreService&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;threadId&quot;</span><span class="token operator">:</span> <span class="token string">&quot;kstry-task-thread-pool-1&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;toNodeIds&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;Activity_0n1ystm-32&quot;</span><span class="token punctuation">]</span>
<span class="token operator">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><h3 id="_1-7-2-异步方式调用执行"><a href="#_1-7-2-异步方式调用执行" class="header-anchor">#</a> 1.7.2 异步方式调用执行</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/student&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StudentController</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/scoreQuery&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">&lt;</span><span class="token class-name">QueryScoreResponse</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">scoreQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">QueryScoreRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QueryScoreRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        request<span class="token punctuation">.</span><span class="token function">setStudentId</span><span class="token punctuation">(</span><span class="token number">66L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        request<span class="token punctuation">.</span><span class="token function">setNeedScore</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">StoryRequest</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">QueryScoreResponse</span><span class="token punctuation">&gt;</span></span> fireRequest <span class="token operator">=</span> <span class="token class-name">ReqBuilder</span>
                <span class="token punctuation">.</span><span class="token function">returnType</span><span class="token punctuation">(</span><span class="token class-name">QueryScoreResponse</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token comment">// 指定返回类型</span>
                <span class="token punctuation">.</span><span class="token function">recallStoryHook</span><span class="token punctuation">(</span><span class="token class-name">WebUtil</span><span class="token operator">::</span><span class="token function">recallStoryHook</span><span class="token punctuation">)</span> <span class="token comment">// 流程结束的回溯</span>
                <span class="token punctuation">.</span><span class="token function">trackingType</span><span class="token punctuation">(</span><span class="token class-name">TrackingTypeEnum</span><span class="token punctuation">.</span>SERVICE_DETAIL<span class="token punctuation">)</span> <span class="token comment">// 指定监控类型</span>
                <span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span> <span class="token comment">// 指定req域参数</span>
                <span class="token punctuation">.</span><span class="token function">varScopeData</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">QueryScoreVarScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 指定var域数据载体，可不指定使用默认值</span>
                <span class="token punctuation">.</span><span class="token function">startId</span><span class="token punctuation">(</span><span class="token string">&quot;student-score-query-process&quot;</span><span class="token punctuation">)</span> <span class="token comment">// 指定开始事件ID</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">QueryScoreResponse</span><span class="token punctuation">&gt;</span></span> fireAsync <span class="token operator">=</span> storyEngine<span class="token punctuation">.</span><span class="token function">fireAsync</span><span class="token punctuation">(</span>fireRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">WebUtil</span><span class="token punctuation">.</span><span class="token function">dataDecorate</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> fireAsync<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WebUtil</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">resultDecorate</span><span class="token punctuation">(</span><span class="token class-name">Object</span> req<span class="token punctuation">,</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> defErrorCode <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">.</span><span class="token function">doOnSuccess</span><span class="token punctuation">(</span>r <span class="token operator">-&gt;</span> log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;req: {}, result success: {}&quot;</span><span class="token punctuation">,</span> req<span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">onErrorResume</span><span class="token punctuation">(</span>err <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token keyword">instanceof</span> <span class="token class-name">BusinessException</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;req: {}, task-service: {}, result error: &quot;</span><span class="token punctuation">,</span> req<span class="token punctuation">,</span> <span class="token class-name">GlobalUtil</span><span class="token punctuation">.</span><span class="token function">transferNotEmpty</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token class-name">BusinessException</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTaskIdentity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;req: {}, result error: &quot;</span><span class="token punctuation">,</span> req<span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span><span class="token class-name">R</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token class-name">ExceptionUtil</span><span class="token punctuation">.</span><span class="token function">tryGetCode</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>s <span class="token operator">-&gt;</span> <span class="token class-name">NumberUtils</span><span class="token punctuation">.</span><span class="token function">toInt</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> defErrorCode<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span>defErrorCode<span class="token punctuation">)</span><span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">dataDecorate</span><span class="token punctuation">(</span><span class="token class-name">Object</span> req<span class="token punctuation">,</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">resultDecorate</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> result<span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span>r <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token keyword">instanceof</span> <span class="token class-name">R</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> result<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span><span class="token class-name">R</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br></div></div><p>    异步流程执行中，<code>fireAsync</code>返回值是<code>Mono</code>类型。Flux和Mono都是Java Reactor响应式中的重要概念，目前Kstry仅采用了Mono作为异步流程调用后的返回结果。在详细了解Mono之前，可以简单的将其理解为功能更加强大的CompletableFuture。使用Mono可以注册流程结束之后被执行的正常或异常的回调操作。而更多的则是像上面例子中一样和类似SpringFlux这种响应式框架做无缝衔接，来对外提供WEB服务。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><!----> <span class="next"><a href="/doc/specification/process_choreography.html">
        二、流程编排
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.fc8f11ce.js" defer></script><script src="/assets/js/2.6d18f2ff.js" defer></script><script src="/assets/js/5.a021e58e.js" defer></script>
  </body>
</html>
